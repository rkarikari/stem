_D1='üìã Download JSON'
_D0='üìä Download Excel'
_C_='üìÑ Download CSV'
_Cz='‚ûï Add Financial Transaction'
_Cy='AI analyzing financial data...'
_Cx='‚ûï Add Transaction'
_Cw='‚Ç¶ (Nigerian Naira)'
_Cv='¬£ (British Pound)'
_Cu='$ (US Dollar)'
_Ct='Attendance %'
_Cs='Student ID'
_Cr='\n                                INSERT INTO grades (grade_id, student_id, course_id, grade, semester, year)\n                                VALUES (?, ?, ?, ?, ?, ?)\n                            '
_Cq='\n                            INSERT INTO courses (course_id, name, teacher_id, grade_level, credits, schedule)\n                            VALUES (?, ?, ?, ?, ?, ?)\n                        '
_Cp='‚ûï Add New Course'
_Co='‚ûï Add Teacher'
_Cn='Overall Utilization'
_Cm='‚ûï Add New Teacher'
_Cl='Current Grade'
_Ck='Email or phone'
_Cj='Student Name*'
_Ci='üí≥ Financial Breakdown'
_Ch='Minimum GPA'
_Cg='Full Capacity'
_Cf='Students by Grade Level'
_Ce='Student Age Distribution'
_Cd='GPA Distribution'
_Cc='üìÖ Attendance'
_Cb='üí∞ Financial'
_Ca='Total Courses'
_CZ='Active Teachers'
_CY='üéØ Key Performance Indicators'
_CX='SELECT COUNT(*) FROM attendance WHERE student_id = ?'
_CW='üìù Data Input'
_CV='üë®\u200düè´ Teachers'
_CU='None selected'
_CT='school_ai'
_CS='school_manager'
_CR="SELECT COUNT(*) FROM teachers WHERE status = 'active'"
_CQ="SELECT COUNT(*) FROM students WHERE status = 'active'"
_CP="UPDATE students SET status = 'graduated' WHERE student_id = ?"
_CO='UPDATE students SET grade = ? WHERE student_id = ?'
_CN='assignment_method'
_CM='activities'
_CL='previous_gpa'
_CK='required_fields'
_CJ='max_age_deviation'
_CI='utilization_percent'
_CH='UPDATE streams SET class_teacher_id = ? WHERE stream_id = ?'
_CG='Authorization'
_CF='Content-Type'
_CE='https://openrouter.ai/api/v1/models'
_CD='‚úÖ Data restored successfully!'
_CC='.json'
_CB='Transaction Type'
_CA='selected_currency_name'
_C9='Credits'
_C8='Course ID'
_C7='Is Class Teacher'
_C6='Total Streams'
_C5='Hire Date'
_C4='Salary'
_C3='Admission Date'
_C2='Parent Contact'
_C1='Balanced'
_C0='Random'
_B_='Performance-based'
_Bz='Medical Information'
_By='capacity'
_Bx='Current'
_Bw='Utilization'
_Bv='RdYlGn'
_Bu='Total Transactions'
_Bt='Tuition'
_Bs='At-Risk Students'
_Br='Average Attendance'
_Bq='context'
_Bp='infrastructure'
_Bo='report'
_Bn='retained'
_Bm='promoted'
_Bl='random'
_Bk='Max capacity must be greater than 0'
_Bj='error'
_Bi='No response'
_Bh='model'
_Bg='ollama_models'
_Bf='openrouter_models'
_Be='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
_Bd='openpyxl'
_Bc='secondary'
_Bb='Description'
_Ba='‚Çµ (Ghana Cedi)'
_BZ='Course'
_BY='SELECT course_id, name FROM courses'
_BX='Select a teacher...'
_BW='Course Name'
_BV='Avg Performance'
_BU='Social Studies'
_BT='inactive'
_BS='Behavior Score'
_BR='Metric'
_BQ='pending'
_BP='total_students'
_BO='Max Capacity'
_BN='GPA Range'
_BM='Total Revenue'
_BL='financial'
_BK='admin'
_BJ='academic'
_BI='risk'
_BH='trends'
_BG='school'
_BF='SELECT COUNT(*) FROM courses'
_BE="SELECT student_id, name FROM students WHERE status = 'active'"
_BD='Rejected'
_BC='ACCEPTED'
_BB='provider'
_BA='OLLAMA'
_B9='http://localhost:11434'
_B8='Semester'
_B7='Schedule'
_B6='Teacher'
_B5='mean'
_B4='Physical Education'
_B3='Mathematics'
_B2='Graduated'
_B1='Attendance Rate (%)'
_B0='Utilization %'
_A_='Excellent'
_Az='distribution'
_Ay='max_gpa'
_Ax='current_students'
_Aw='streams_by_type'
_Av='streams_by_grade'
_Au='stream_types'
_At='role'
_As='stream'
_Ar='text/csv'
_Aq='Stream'
_Ap='Good'
_Ao='Pending'
_An='REJECTED'
_Am='ai_reasoning'
_Al='balanced'
_Ak='performance'
_Aj='date_of_birth'
_Ai='Unknown'
_Ah='value'
_Ag="SELECT teacher_id, name FROM teachers WHERE status = 'active'"
_Af='Science'
_Ae='Current Students'
_Ad='Stream ID'
_Ac='Revenue'
_Ab='average_gpa'
_Aa='content'
_AZ='students'
_AY='subject'
_AX='Type'
_AW='primary'
_AV='Performance Score'
_AU='Date'
_AT='Amount'
_AS='Age'
_AR='capacity_utilization'
_AQ='application/json'
_AP='---'
_AO='Teachers'
_AN='Number of Students'
_AM='Average GPA'
_AL='count'
_AK='graduated'
_AJ='GRADUATED'
_AI='Teacher ID'
_AH='All'
_AG='Student'
_AF='Attendance'
_AE='attendance'
_AD='dash'
_AC='Month'
_AB='parent_contact'
_AA='min_gpa'
_A9='medical_info'
_A8='grade_level'
_A7='%Y%m%d_%H%M%S'
_A6='semester'
_A5='stream_type'
_A4='department'
_A3='Class Teacher'
_A2='Not assigned'
_A1='Grade Level'
_A0='year'
_z='\n'
_y='max_capacity'
_x='salary'
_w='type'
_v='ai_provider'
_u='openrouter'
_t='red'
_s='Total Students'
_r='admission_date'
_q='ollama_url'
_p='performance_score'
_o='Status'
_n='active'
_m='Subject'
_l='y'
_k='x'
_j=', '
_i='N/A'
_h='GPA'
_g='ollama'
_f='Grade'
_e='Count'
_d='JHS 3'
_c='JHS 2'
_b='JHS 1'
_a='Kindergarten'
_Z='age'
_Y='ai_model'
_X='Grade 6'
_W='Grade 5'
_V='Grade 4'
_U='behavior_score'
_T='Grade 3'
_S='Grade 2'
_R='Grade 1'
_Q='Department'
_P='Name'
_O='stream_id'
_N='Performance'
_M='%Y-%m-%d'
_L='date'
_K='attendance_rate'
_J='Students'
_I='status'
_H='grade'
_G='gpa'
_F=False
_E='name'
_D=.0
_C='student_id'
_B=None
_A=True
import streamlit as st,pandas as pd,numpy as np,sqlite3,json,requests,toml
from datetime import datetime,timedelta
import plotly.express as px,plotly.graph_objects as go
from dataclasses import dataclass,field
from typing import Dict,List,Optional,Any
import hashlib,uuid
from enum import Enum
import time,io
from PIL import Image
import base64
APP_VERSION='1.5.0'
def initialize_ui():st.set_page_config(page_title='RadioSport Scholium',page_icon='üßü',layout='wide',menu_items={'Report a Bug':'https://github.com/rkarikari/stem','About':'Copyright ¬© RNK, 2025 RadioSport. All rights reserved.'})
class AIProvider(Enum):OLLAMA=_g;OPENROUTER=_u
@dataclass
class Student:student_id:str;name:str;age:int;grade:str;admission_date:str;gpa:float=_D;attendance_rate:float=1e2;behavior_score:float=1e2;parent_contact:str='';medical_info:str='';photo:Optional[str]=_B;status:str=_n;stream_id:Optional[str]=_B
@dataclass
class Teacher:teacher_id:str;name:str;subject:str;department:str;hire_date:str;performance_score:float=1e2;salary:float=_D;status:str=_n;is_class_teacher:bool=_F
@dataclass
class Course:course_id:str;name:str;teacher_id:str;grade_level:str;credits:int;schedule:str
@dataclass
class Stream:
	stream_id:str;grade_level:str;stream_type:str;max_capacity:int=36;class_teacher_id:Optional[str]=_B;subject_teachers:Dict[str,str]=field(default_factory=dict)
	def __post_init__(A):
		if isinstance(A.subject_teachers,str):
			try:A.subject_teachers=json.loads(A.subject_teachers)
			except json.JSONDecodeError:A.subject_teachers={}
class SchoolAI:
	def __init__(A):
		B=st.session_state.get(_v,AIProvider.OLLAMA);A.provider_str=A._get_provider_string_direct(B)
		if isinstance(B,AIProvider):A.provider=B
		else:A.provider=AIProvider.OLLAMA
		A.ollama_url=st.session_state.get(_q,_B9);A.openrouter_key=A._load_openrouter_key();A.model=st.session_state.get(_Y,_B)
		if _Bf not in st.session_state:st.session_state.openrouter_models=[]
		if _Bg not in st.session_state:st.session_state.ollama_models=[]
	def _get_provider_string_direct(B,provider_value):
		'Direct mapping of provider to string - handles all cases'
		try:
			A=str(provider_value).lower()
			if _g in A:return _g
			elif _u in A:return _u
			else:return _g
		except Exception:return _g
	def _extract_provider_string(E,provider_enum):
		'Extract clean provider string from enum, handling various enum definitions';A=provider_enum
		try:
			if hasattr(A,_Ah)and isinstance(A.value,str):
				B=A.value.lower()
				if B in[_g,_u]:return B
			if hasattr(A,_E):
				C=A.name.lower()
				if C in[_g,_u]:return C
			D=str(A)
			if _BA in D.upper():return _g
			elif'OPENROUTER'in D.upper():return _u
			return _g
		except Exception:return _g
	def _clean_provider_string(B,provider_str):
		'Clean provider string from various formats';A=provider_str
		try:
			A=A.lower()
			if _g in A:return _g
			elif _u in A:return _u
			return _g
		except Exception:return _g
	def _load_openrouter_key(D):
		'Load OpenRouter API key from secrets.toml';A='api_key'
		try:
			if hasattr(st,'secrets')and _u in st.secrets:return st.secrets.openrouter.get(A,'')
			else:
				with open('.streamlit/secrets.toml','r')as B:C=toml.load(B);return C.get(_u,{}).get(A,'')
		except Exception:return st.session_state.get('openrouter_key','')
	def get_openrouter_free_models(D):
		'Dynamically load OpenRouter free models'
		try:
			A=requests.get(_CE,headers={_CF:_AQ},timeout=10)
			if A.status_code==200:C=A.json().get('data',[]);B=[A for A in C if A.get('pricing',{}).get('prompt','0')=='0'];st.session_state.openrouter_models=B;return B
			else:return st.session_state.openrouter_models
		except Exception:return st.session_state.openrouter_models
	def get_ollama_models(C,ollama_url=_B):
		'Dynamically load available models from Ollama server';D=ollama_url or C.ollama_url
		try:
			A=requests.get(f"{D}/api/tags",timeout=10)
			if A.status_code==200:E=A.json().get('models',[]);B=[A[_E]for A in E];st.session_state.ollama_models=B;return B
			else:return st.session_state.ollama_models
		except Exception:return st.session_state.ollama_models
	def sync_with_session_state(A):
		'Sync instance variables with session state properly'
		try:
			if _v in st.session_state:
				B=st.session_state.ai_provider;A.provider_str=A._get_provider_string_direct(B)
				if isinstance(B,AIProvider):A.provider=B
			if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
			if _Y in st.session_state:A.model=st.session_state.ai_model
		except Exception:pass
	def get_configuration_summary(A):'Get current configuration summary for display';B=A.provider_str.title()if A.provider_str else _Ai;return{_BB:B,_Bh:A.model or'Not selected','server_url':A.ollama_url if A.provider_str==_g else _i,'api_status':'Configured'if A.openrouter_key else'Not configured','connection_status':A._test_connection()}
	def _test_connection(A):
		'Test connection to current provider';D='‚ùå Failed';C='‚úÖ Connected'
		try:
			if A.provider_str==_g:B=requests.get(f"{A.ollama_url}/api/tags",timeout=5);return C if B.status_code==200 else D
			elif A.provider_str==_u:
				if not A.openrouter_key:return'‚ùå No API Key'
				B=requests.get(_CE,headers={_CG:f"Bearer {A.openrouter_key}"},timeout=5);return C if B.status_code==200 else D
			else:return'‚ùå Unknown provider'
		except Exception:return'‚ùå Connection Error'
	def generate_response(A,prompt,context=''):
		'Generate AI response using selected provider';C=context;B=prompt
		try:
			D=str(A.provider_str).lower()
			if _g in D:return A._ollama_request(B,C)
			elif _u in D:return A._openrouter_request(B,C)
			else:return f"Unknown provider: {A.provider_str}"
		except Exception as E:return f"Error: {str(E)}"
	def _ollama_request(B,prompt,context):
		'Make request to local Ollama instance';D=context;C=prompt
		try:
			if not B.model:return'Ollama Error: No model selected'
			F=f"{D}\n\n{C}"if D else C;A=requests.post(f"{B.ollama_url}/api/generate",json={_Bh:B.model,'prompt':F,_As:_F},timeout=120)
			if A.status_code==200:E=A.json().get('response',_Bi);return E.strip()if E else _Bi
			else:
				try:G=A.json();H=G.get(_Bj,f"HTTP {A.status_code}");return f"Ollama Error: {H}"
				except:return f"Ollama Error: HTTP {A.status_code}"
		except requests.exceptions.ConnectionError:return f"Ollama Error: Cannot connect to {B.ollama_url}"
		except requests.exceptions.Timeout:return'Ollama Error: Request timeout (120s)'
		except Exception as I:return f"Ollama Error: {str(I)}"
	def _openrouter_request(B,prompt,context):
		'Make request to OpenRouter API';F='message';D=context;C=prompt
		try:
			if not B.openrouter_key:return'OpenRouter Error: API key not configured'
			if not B.model:return'OpenRouter Error: No model selected'
			G=f"{D}\n\n{C}"if D else C;A=requests.post('https://openrouter.ai/api/v1/chat/completions',headers={_CG:f"Bearer {B.openrouter_key}",_CF:_AQ},json={_Bh:B.model,'messages':[{_At:'user',_Aa:G}]},timeout=60)
			if A.status_code==200:E=A.json()['choices'][0][F][_Aa];return E.strip()if E else _Bi
			else:
				try:H=A.json();I=H.get(_Bj,{}).get(F,f"HTTP {A.status_code}");return f"OpenRouter Error: {I}"
				except:return f"OpenRouter Error: HTTP {A.status_code}"
		except requests.exceptions.ConnectionError:return'OpenRouter Error: No internet connection'
		except requests.exceptions.Timeout:return'OpenRouter Error: Request timeout (60s)'
		except Exception as J:return f"OpenRouter Error: {str(J)}"
	def get_provider_enum(A):'Get provider as enum';return A.provider
	def get_provider_string(A):'Get provider as string';return A.provider_str
	def is_ollama(A):'Check if current provider is Ollama';return A.provider_str==_g
	def is_openrouter(A):'Check if current provider is OpenRouter';return A.provider_str==_u
class DatabaseManager:
	def __init__(A,db_path='school_management.db'):A.db_path=db_path;A.init_database()
	def init_database(C):
		'Initialize database with all required tables'
		with sqlite3.connect(C.db_path)as B:A=B.cursor();A.execute("\n                CREATE TABLE IF NOT EXISTS students (\n                    student_id TEXT PRIMARY KEY,\n                    name TEXT NOT NULL,\n                    age INTEGER,\n                    grade TEXT,\n                    admission_date TEXT,\n                    gpa REAL DEFAULT 0.0,\n                    attendance_rate REAL DEFAULT 100.0,\n                    behavior_score REAL DEFAULT 100.0,\n                    parent_contact TEXT,\n                    medical_info TEXT,\n                    photo TEXT,\n                    status TEXT DEFAULT 'active',\n                    stream_id TEXT,\n                    date_of_birth TEXT,\n                    FOREIGN KEY (stream_id) REFERENCES streams (stream_id)\n                )\n            ");A.execute("\n                CREATE TABLE IF NOT EXISTS teachers (\n                    teacher_id TEXT PRIMARY KEY,\n                    name TEXT NOT NULL,\n                    subject TEXT,\n                    department TEXT,\n                    hire_date TEXT,\n                    performance_score REAL DEFAULT 100.0,\n                    salary REAL DEFAULT 0.0,\n                    status TEXT DEFAULT 'active',\n                    is_class_teacher BOOLEAN DEFAULT FALSE\n                )\n            ");A.execute('\n                CREATE TABLE IF NOT EXISTS courses (\n                    course_id TEXT PRIMARY KEY,\n                    name TEXT NOT NULL,\n                    teacher_id TEXT,\n                    grade_level TEXT,\n                    credits INTEGER,\n                    schedule TEXT,\n                    FOREIGN KEY (teacher_id) REFERENCES teachers (teacher_id)\n                )\n            ');A.execute('\n                CREATE TABLE IF NOT EXISTS grades (\n                    grade_id TEXT PRIMARY KEY,\n                    student_id TEXT,\n                    course_id TEXT,\n                    grade REAL,\n                    semester TEXT,\n                    year INTEGER,\n                    FOREIGN KEY (student_id) REFERENCES students (student_id),\n                    FOREIGN KEY (course_id) REFERENCES courses (course_id)\n                )\n            ');A.execute('\n                CREATE TABLE IF NOT EXISTS attendance (\n                    attendance_id TEXT PRIMARY KEY,\n                    student_id TEXT,\n                    date TEXT,\n                    status TEXT,\n                    FOREIGN KEY (student_id) REFERENCES students (student_id)\n                )\n            ');A.execute("\n                CREATE TABLE IF NOT EXISTS finance (\n                    transaction_id TEXT PRIMARY KEY,\n                    student_id TEXT,\n                    amount REAL,\n                    type TEXT,\n                    description TEXT,\n                    date TEXT,\n                    status TEXT DEFAULT 'pending',\n                    FOREIGN KEY (student_id) REFERENCES students (student_id)\n                )\n            ");A.execute("\n                CREATE TABLE IF NOT EXISTS streams (\n                    stream_id TEXT PRIMARY KEY,\n                    grade_level TEXT NOT NULL,\n                    stream_type TEXT NOT NULL,\n                    max_capacity INTEGER DEFAULT 36,\n                    class_teacher_id TEXT,\n                    subject_teachers TEXT DEFAULT '{}',\n                    FOREIGN KEY (class_teacher_id) REFERENCES teachers (teacher_id)\n                )\n            ");A.execute('\n                CREATE TABLE IF NOT EXISTS stream_config (\n                    grade_level TEXT PRIMARY KEY,\n                    stream_types TEXT NOT NULL,\n                    max_capacity INTEGER DEFAULT 36,\n                    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n                )\n            ');B.commit()
	def add_student(D,student_data):
		'Add new student';A=student_data
		with sqlite3.connect(D.db_path)as B:E=B.cursor();C=list(A.keys());F=['?'for A in C];G=list(A.values());H=f"\n                INSERT INTO students ({_j.join(C)})\n                VALUES ({_j.join(F)})\n            ";E.execute(H,G);B.commit()
	def update_student(G,student_data):
		'Update student information';A=student_data
		with sqlite3.connect(G.db_path)as C:
			D=C.cursor();E=[];B=[]
			for(F,H)in A.items():
				if F!=_C:E.append(f"{F} = ?");B.append(H)
			B.append(A[_C]);I=f"\n                UPDATE students \n                SET {_j.join(E)}\n                WHERE student_id = ?\n            ";D.execute(I,B);C.commit()
			if D.rowcount==0:raise Exception(f"Student not found: {A[_C]}")
	def get_all_students(C):
		'Get all students'
		with sqlite3.connect(C.db_path)as A:A.row_factory=sqlite3.Row;B=A.cursor();B.execute('SELECT * FROM students');return[dict(A)for A in B.fetchall()]
	def execute_query(B,query,params=()):
		'Execute a query and return results'
		with sqlite3.connect(B.db_path)as C:A=C.cursor();A.execute(query,params);return A.fetchall()
	def execute_update(B,query,params=()):
		'Execute an update/insert query'
		with sqlite3.connect(B.db_path)as A:C=A.cursor();C.execute(query,params);A.commit()
class StreamManager:
	def __init__(A,db_manager,default_streams=_B,default_max_capacity=36):
		C=default_max_capacity;B=default_streams;A.db=db_manager;A.ideal_class_size=35;A.default_max_capacity=C;A.max_class_size=C
		if B is _B:A.default_streams=['R','C','S']
		else:A.default_streams=B
		A._initialize_stream_config()
	def _initialize_stream_config(A):'Initialize stream configuration table for per-grade stream settings';A.db.execute_update('\n            CREATE TABLE IF NOT EXISTS stream_config (\n                grade_level TEXT PRIMARY KEY,\n                stream_types TEXT NOT NULL,  -- JSON array of stream types\n                max_capacity INTEGER DEFAULT 36,  -- Per-grade max capacity\n                created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ')
	def set_streams_for_grade(C,grade_level,stream_types,max_capacity=_B):
		'Set custom stream types and max capacity for a specific grade level';B=max_capacity;A=stream_types;import json
		if not A or len(A)==0:raise ValueError('At least one stream type is required')
		if B is _B:B=C.default_max_capacity
		if B<=0:raise ValueError(_Bk)
		A=list(dict.fromkeys(A));E='\n            INSERT INTO stream_config (grade_level, stream_types, max_capacity)\n            VALUES (?, ?, ?)\n            ON CONFLICT(grade_level) DO UPDATE SET \n                stream_types = ?, \n                max_capacity = ?\n        ';D=json.dumps(A);C.db.execute_update(E,(grade_level,D,B,D,B))
	def get_streams_config_for_grade(A,grade_level):
		'Get stream configuration for a grade level';import json;C='SELECT stream_types, max_capacity FROM stream_config WHERE grade_level = ?';B=A.db.execute_query(C,(grade_level,))
		if B:D=json.loads(B[0][0]);E=B[0][1]if B[0][1]is not _B else A.default_max_capacity;return{_Au:D,_y:E}
		else:return{_Au:A.default_streams.copy(),_y:A.default_max_capacity}
	def get_max_capacity_for_grade(A,grade_level):'Get max capacity setting for a specific grade level';B=A.get_streams_config_for_grade(grade_level);return B[_y]
	def set_max_capacity_for_grade(A,grade_level,max_capacity):
		'Set max capacity for a specific grade level (keeps existing stream types)';C=max_capacity;B=grade_level
		if C<=0:raise ValueError(_Bk)
		D=A.get_streams_config_for_grade(B);A.set_streams_for_grade(B,D[_Au],C);A._update_existing_streams_capacity(B,C)
	def set_global_max_capacity(B,max_capacity):
		'Set default max capacity for all new streams';A=max_capacity
		if A<=0:raise ValueError(_Bk)
		B.default_max_capacity=A;B.max_class_size=A
	def _update_existing_streams_capacity(A,grade_level,new_max_capacity):'Update max capacity for existing streams in a grade level';B='UPDATE streams SET max_capacity = ? WHERE grade_level = ?';A.db.execute_update(B,(new_max_capacity,grade_level))
	def create_streams_for_grade(C,grade_level,custom_streams=_B,max_capacity=_B):
		'Create streams for a grade level with configurable stream types and max capacity';F=max_capacity;E=custom_streams;A=grade_level
		if E or F is not _B:B=C.get_streams_config_for_grade(A);G=E if E else B[_Au];D=F if F is not _B else B[_y];C.set_streams_for_grade(A,G,D)
		else:B=C.get_streams_config_for_grade(A);G=B[_Au];D=B[_y]
		for H in G:I=f"{A.replace(' ','')}{H}";J='\n                INSERT INTO streams (stream_id, grade_level, stream_type, max_capacity)\n                VALUES (?, ?, ?, ?)\n                ON CONFLICT(stream_id) DO UPDATE SET max_capacity = ?\n            ';C.db.execute_update(J,(I,A,H,D,D))
	def get_streams_for_grade(A,grade_level):'Get all streams for a grade level';B='SELECT * FROM streams WHERE grade_level = ? ORDER BY stream_type';C=A.db.execute_query(B,(grade_level,));return[Stream(*A)for A in C]
	def get_stream_by_id(B,stream_id):'Get stream by ID';C='SELECT * FROM streams WHERE stream_id = ?';A=B.db.execute_query(C,(stream_id,));return Stream(*A[0])if A else _B
	def assign_class_teacher(B,stream_id,teacher_id):'Assign class teacher to a stream';C=teacher_id;A=_CH;B.db.execute_update(A,(C,stream_id));A='UPDATE teachers SET is_class_teacher = TRUE WHERE teacher_id = ?';B.db.execute_update(A,(C,))
	def get_students_in_stream(E,stream_id):
		'Get all students in a specific stream';I='Unknown Student'
		try:
			J='PRAGMA table_info(students)';K=E.db.execute_query(J);F=[A[1]for A in K];L=[_C,_E,_H];M=[_Aj,'phone_number','parent_guardian_name','parent_guardian_phone','parent_guardian_email','emergency_contact_name','emergency_contact_phone',_A9,_I];C=[]
			for B in L:
				if B in F:C.append(B)
			for B in M:
				if B in F:C.append(B)
			if not C:return[]
			N=f"""
            SELECT {_j.join(C)}
            FROM students 
            WHERE stream_id = ? AND status = 'active'
            ORDER BY name
            """;O=E.db.execute_query(N,(stream_id,));D=[]
			for A in O:
				try:
					class P:
						def __init__(A,data_dict):
							for(B,C)in data_dict.items():setattr(A,B,C)
					G={}
					for(H,B)in enumerate(C):G[B]=A[H]if H<len(A)else _B
					Q=P(G);D.append(Q)
				except Exception:
					class R:
						def __init__(B,student_id,name):B.student_id=student_id if len(A)>0 else _Ai;B.name=name if len(A)>1 else I
					D.append(R(A[0]if len(A)>0 else _Ai,A[1]if len(A)>1 else I))
			return D
		except Exception:return[]
	def assign_student_to_stream(A,student_id,assignment_method=_Ak):
		'\n        Assign student to a stream based on specified method\n        Options: "performance", "random", "balanced"\n        Returns: stream_id that student was assigned to\n        ';E=student_id;D=assignment_method;B=A._get_student(E)
		if not B:raise ValueError(f"Student with ID {E} not found")
		C=A.get_streams_for_grade(B.grade)
		if not C:A.create_streams_for_grade(B.grade);C=A.get_streams_for_grade(B.grade)
		if D==_Ak:return A._performance_based_assignment(B,C)
		elif D==_Bl:return A._random_assignment(B,C)
		elif D==_Al:return A._balanced_assignment(B,C)
		else:return A._performance_based_assignment(B,C)
	def _performance_based_assignment(F,student,streams):
		'Assign based on GPA thresholds - adaptable to any number of streams';G=streams;D=student;A=sorted(G,key=lambda s:s.stream_type);C=len(A)
		if C==1:B=A[0]
		elif C==2:
			if D.gpa>=3.25:B=A[0]
			else:B=A[1]
		elif C==3:
			if D.gpa>=3.5:B=next((A for A in A if A.stream_type=='S'),A[0])
			elif D.gpa>=3.:B=next((A for A in A if A.stream_type=='C'),A[len(A)//2])
			else:B=next((A for A in A if A.stream_type=='R'),A[-1])
		else:
			if D.gpa>=3.8:E=0
			elif D.gpa>=3.4:E=min(1,C-1)
			elif D.gpa>=3.:E=min(C//2,C-1)
			elif D.gpa>=2.5:E=min(C-2,C-1)
			else:E=C-1
			B=A[E]
		if F.get_student_count(B.stream_id)>=B.max_capacity:
			H=[A for A in G if F.get_student_count(A.stream_id)<A.max_capacity]
			if H:B=min(H,key=lambda s:F.get_student_count(s.stream_id))
		F._update_student_stream(D.student_id,B.stream_id);return B.stream_id
	def _random_assignment(A,student,streams):
		'Randomly assign to a stream';C=streams;import random as E;B=[B for B in C if A.get_student_count(B.stream_id)<B.max_capacity]
		if not B:B=sorted(C,key=lambda s:A.get_student_count(s.stream_id))
		D=E.choice(B);A._update_student_stream(student.student_id,D.stream_id);return D.stream_id
	def _balanced_assignment(B,student,streams):'Assign to the stream with most available capacity';A=[(A,A.max_capacity-B.get_student_count(A.stream_id))for A in streams];A.sort(key=lambda x:(x[1],x[0].stream_type),reverse=_A);C=A[0][0];B._update_student_stream(student.student_id,C.stream_id);return C.stream_id
	def get_student_count(B,stream_id):'Get number of students in a stream';C="SELECT COUNT(*) FROM students WHERE stream_id = ? AND status = 'active'";A=B.db.execute_query(C,(stream_id,));return A[0][0]if A else 0
	def _update_student_stream(A,student_id,stream_id):"Update student's stream assignment";B='UPDATE students SET stream_id = ? WHERE student_id = ?';A.db.execute_update(B,(stream_id,student_id))
	def _get_student(C,student_id):
		'Get student by ID';D='SELECT * FROM students WHERE student_id = ?';B=C.db.execute_query(D,(student_id,))
		if B:
			A=B[0]
			if len(A)>=10:return Student(student_id=A[0],name=A[1],age=A[2],grade=A[3],admission_date=A[4],gpa=A[5]if len(A)>5 else _D,attendance_rate=A[6]if len(A)>6 else 1e2,behavior_score=A[7]if len(A)>7 else 1e2,parent_contact=A[8]if len(A)>8 else'',medical_info=A[9]if len(A)>9 else'',photo=A[10]if len(A)>10 else _B,status=A[11]if len(A)>11 else _n,stream_id=A[12]if len(A)>12 else _B)
	def assign_subject_teacher(B,stream_id,subject,teacher_id):
		'Assign subject teacher to a stream';C=stream_id;A=B.get_stream_by_id(C)
		if not A:return
		A.subject_teachers[subject]=teacher_id;import json;D=json.dumps(A.subject_teachers);E='UPDATE streams SET subject_teachers = ? WHERE stream_id = ?';B.db.execute_update(E,(D,C))
	def get_subject_teacher(B,stream_id,subject):
		'Get subject teacher for a stream';A=B.get_stream_by_id(stream_id)
		if not A:return
		return A.subject_teachers.get(subject,_B)
	def enforce_class_sizes(A,grade_level=_B):
		'Enforce maximum class sizes by rebalancing if needed';C=grade_level
		if C:D=A.get_streams_for_grade(C)
		else:E='SELECT * FROM streams';F=A.db.execute_query(E);D=[Stream(*A)for A in F]
		for B in D:
			G=A.get_student_count(B.stream_id)
			if G>B.max_capacity:A._rebalance_stream(B)
	def _rebalance_stream(A,overloaded_stream):
		'Rebalance an overloaded stream by moving students to other streams';B=overloaded_stream;D=A.get_students_in_stream(B.stream_id);E=len(D)-B.max_capacity
		if E<=0:return
		F=[A for A in A.get_streams_for_grade(B.grade_level)if A.stream_id!=B.stream_id];G=sorted(D,key=lambda s:s.gpa)[:E]
		for H in G:
			C=[(B,B.max_capacity-A.get_student_count(B.stream_id))for B in F if A.get_student_count(B.stream_id)<B.max_capacity]
			if C:C.sort(key=lambda x:x[1],reverse=_A);I=C[0][0];A._update_student_stream(H.student_id,I.stream_id)
	def get_stream_statistics(D):
		'Get statistics about all streams';C='capacity_settings';G='SELECT * FROM streams ORDER BY grade_level, stream_type';H=D.db.execute_query(G);E=[Stream(*A)for A in H];B={'total_streams':len(E),_Av:{},_Aw:{},_AR:[],C:{}}
		for A in E:
			F=D.get_student_count(A.stream_id);I=F/A.max_capacity*100 if A.max_capacity>0 else 0
			if A.grade_level not in B[_Av]:B[_Av][A.grade_level]=0
			B[_Av][A.grade_level]+=1
			if A.stream_type not in B[_Aw]:B[_Aw][A.stream_type]=0
			B[_Aw][A.stream_type]+=1
			if A.grade_level not in B[C]:B[C][A.grade_level]=A.max_capacity
			B[_AR].append({_O:A.stream_id,_H:A.grade_level,_w:A.stream_type,_Ax:F,_y:A.max_capacity,_CI:round(I,1)})
		return B
	def delete_stream(A,stream_id,reassign_method=_Al):
		'\n        Delete a stream and reassign its students to other streams in the same grade\n        ';E=reassign_method;B=stream_id;F=A.get_stream_by_id(B)
		if not F:return _F
		G=A.get_students_in_stream(B);C=[A for A in A.get_streams_for_grade(F.grade_level)if A.stream_id!=B]
		if not C:raise ValueError('Cannot delete the only stream in a grade level')
		for D in G:
			if E==_Al:A._balanced_assignment(D,C)
			elif E==_Ak:A._performance_based_assignment(D,C)
			else:A._random_assignment(D,C)
		H='DELETE FROM streams WHERE stream_id = ?';A.db.execute_update(H,(B,));return _A
	def get_available_stream_types(A):'Get list of all stream types that have been used';B='SELECT DISTINCT stream_type FROM streams ORDER BY stream_type';C=A.db.execute_query(B);D=[A[0]for A in C];E=list(set(A.default_streams+D));return sorted(E)
class SchoolManager:
	def __init__(A):A.db=DatabaseManager();A.ai=SchoolAI();A.stream_manager=StreamManager(A.db);A.admission_criteria={_AA:2.,_CJ:2,_CK:[_E,_Z,_AB]}
	def auto_admit_student(A,application_data):
		'AI-powered automatic student admission with clear criteria';Q='OpenRouter Error:';P='None listed';M='GRADE:';L='reason';B=application_data
		try:
			I=[]
			for N in A.admission_criteria[_CK]:
				if not B.get(N):I.append(N)
			if I:return{_I:_An,L:f"Missing required fields: {_j.join(I)}",_Am:'Application incomplete - missing required information'}
			E=B.get(_Z,6);D=A._determine_grade_by_age(E);O=A._get_typical_age_for_grade(D);R=abs(E-O);C=B.get(_CL,3.)
			if isinstance(C,str):
				try:C=float(C)
				except ValueError:C=3.
			if C<A.admission_criteria[_AA]:return{_I:_An,L:f"GPA {C} below minimum requirement of {A.admission_criteria[_AA]}",_Am:f"Academic performance below school standards. Minimum GPA required: {A.admission_criteria[_AA]}"}
			if R>A.admission_criteria[_CJ]:return{_I:_An,L:f"Age {E} not appropriate for available grade levels",_Am:f"Student age ({E}) significantly outside typical range for grade placement"}
			S=f"""
            SCHOOL ADMISSION EVALUATION

            Student Information:
            - Name: {B.get(_E)}
            - Age: {E} years old
            - Previous GPA: {C} (if applicable)
            - Extracurricular Activities: {B.get(_CM,P)}
            - Parent Contact: {B.get(_AB,"Provided")}
            - Medical Information: {B.get(_A9,P)}

            Recommended Grade Level: {D}
            (Typical age for this grade: {O})

            ADMISSION CRITERIA MET:
            ‚úì Required fields completed
            ‚úì GPA ({C}) meets minimum requirement ({A.admission_criteria[_AA]})
            ‚úì Age ({E}) within acceptable range for grade placement
            
            INSTRUCTIONS:
            Based on the information provided and criteria met, evaluate this application.
            
            The student meets all basic requirements. Consider:
            1. Academic readiness (GPA indicates capability)
            2. Age-appropriate placement (recommended grade: {D})
            3. Any special considerations from medical information
            4. Overall suitability for school environment
            
            Respond with:
            DECISION: ACCEPT or REJECT
            GRADE: {D} (unless special circumstances require adjustment)
            REASONING: Brief explanation of your decision
            
            Note: Student has already passed initial screening criteria.
            """;F=A.ai.generate_response(S)
			if any(A in F for A in['Ollama Error:',Q,'AI Error:']):raise Exception(F)
			T=_BC if'ACCEPT'in F.upper()else _An;G=D
			if M in F:
				try:
					U=[A for A in F.split(_z)if M in A][0];G=U.split(M)[1].strip().split()[0]
					if G not in A._get_all_grade_levels():G=D
				except:G=D
			if T==_BC:
				J=f"STU{len(A.get_all_students())+1:04d}";K=B.get(_r)
				if not K:from datetime import datetime as V;K=V.now().strftime(_M)
				W=Student(student_id=J,name=B.get(_E),age=E,grade=G,admission_date=K,gpa=C,attendance_rate=1e2,behavior_score=1e2,parent_contact=B.get(_AB,''),medical_info=B.get(_A9,''),photo=_B);A._save_student(W);X=B.get(_CN,_Ak);Y=A.stream_manager.assign_student_to_stream(J,X);return{_I:_BC,_C:J,_H:G,_O:Y,_Am:F,'recommended_grade':D}
			else:return{_I:_An,_Am:F,'note':'Decision made after meeting basic requirements'}
		except Exception as Z:
			H=str(Z)
			if Q in H and hasattr(A.ai,_BB)and _BA in str(A.ai.provider):H=H.replace('OpenRouter Error: ','')
			raise Exception(H)
	def _determine_grade_by_age(B,age):'Determine appropriate grade level based on age';A={5:_a,6:_R,7:_S,8:_T,9:_V,10:_W,11:_X,12:_b,13:_c,14:_d};return A.get(age,_R)
	def _get_typical_age_for_grade(B,grade):'Get typical age for a grade level';A={_a:5,_R:6,_S:7,_T:8,_V:9,_W:10,_X:11,_b:12,_c:13,_d:14};return A.get(grade,6)
	def _get_all_grade_levels(A):'Get list of all valid grade levels';return[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]
	def _save_student(B,student):'Save student to database';A=student;C='\n            INSERT INTO students (student_id, name, age, grade, admission_date, \n                                gpa, attendance_rate, behavior_score, parent_contact, medical_info)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n        ';D=A.student_id,A.name,A.age,A.grade,A.admission_date,A.gpa,A.attendance_rate,A.behavior_score,A.parent_contact,A.medical_info;B.db.execute_update(C,D)
	def get_admission_stats(C):
		'Get admission statistics';B='Accepted'
		try:D='SELECT status, COUNT(*) FROM applications GROUP BY status';A=C.db.execute_query(D);return dict(A)if A else{B:0,_BD:0,_Ao:0}
		except:return{B:0,_BD:0,_Ao:0}
	def auto_grade_promotion(B):
		'Automatically promote students based on AI evaluation';N='promotions';J='reasoning';I='to_grade';H='from_grade';G='‚úó NOT MET';F='‚úì MET'
		try:
			O=B.get_all_students();C=[]
			for A in O:
				K=2.;L=75;M=60;P=f"""
                GRADE PROMOTION EVALUATION
                
                Student: {A[_E]} (ID: {A[_C]})
                Current Grade: {A[_H]}
                Academic Performance:
                - GPA: {A[_G]}
                - Attendance Rate: {A[_K]}%
                - Behavior Score: {A[_U]}
                
                PROMOTION REQUIREMENTS:
                - Minimum GPA: {K} (Current: {A[_G]} - {F if A[_G]>=K else G})
                - Minimum Attendance: {L}% (Current: {A[_K]}% - {F if A[_K]>=L else G})
                - Minimum Behavior Score: {M} (Current: {A[_U]} - {F if A[_U]>=M else G})
                
                INSTRUCTIONS:
                If ALL requirements are met, respond with: PROMOTE
                If any requirement is not met, respond with: RETAIN
                
                Provide brief reasoning for your decision.
                
                DECISION: PROMOTE or RETAIN
                REASONING: [Your explanation]
                """;D=B.ai.generate_response(P)
				if'PROMOTE'in D.upper():
					E=B._get_next_grade(A[_H])
					if E!=_AJ:B._update_student_grade(A[_C],E);B.stream_manager.assign_student_to_stream(A[_C],_Al);C.append({_C:A[_C],_E:A[_E],H:A[_H],I:E,J:D,_I:_Bm})
					else:B._graduate_student(A[_C]);C.append({_C:A[_C],_E:A[_E],H:A[_H],I:_AJ,J:'Student has completed all requirements and is ready for graduation',_I:_AK})
				else:C.append({_C:A[_C],_E:A[_E],H:A[_H],I:A[_H],J:D,_I:_Bn})
			return{N:C}
		except Exception as Q:return{_Bj:f"Promotion process failed: {str(Q)}",N:[]}
	def _get_next_grade(B,current_grade):'Get the next grade level';A={_a:_R,_R:_S,_S:_T,_T:_V,_V:_W,_W:_X,_X:_b,_b:_c,_c:_d,_d:_AJ};return A.get(current_grade,_AJ)
	def _update_student_grade(A,student_id,new_grade):"Update student's grade in database";B=_CO;A.db.execute_update(B,(new_grade,student_id))
	def _graduate_student(A,student_id):'Mark student as graduated';B=_CP;A.db.execute_update(B,(student_id,))
	def get_all_students(B):
		'Get all active students with stream info'
		try:C="\n                SELECT s.*, st.stream_id, st.grade_level as stream_grade, st.stream_type\n                FROM students s\n                LEFT JOIN streams st ON s.stream_id = st.stream_id\n                WHERE s.status != 'graduated'\n            ";A=B.db.execute_query(C);D=[_C,_E,_Z,_H,_r,_G,_K,_U,_AB,_A9,'photo',_I,_O,'stream_grade',_A5];return[dict(zip(D,A))for A in A]if A else[]
		except Exception as E:return[]
	def generate_ai_insights(C):
		'Generate AI-powered school insights'
		try:
			B=C.get_all_students();A=len(B)
			if A==0:return'No active students found. Unable to generate insights.'
			D=sum(A[_G]for A in B)/A;E=sum(A[_K]for A in B)/A;F=f"""
            SCHOOL PERFORMANCE ANALYSIS
            
            Current School Statistics:
            - Total Active Students: {A}
            - Average GPA: {D:.2f}
            - Average Attendance Rate: {E:.1f}%
            
            ANALYSIS REQUEST:
            Please provide actionable insights and recommendations based on this data:
            
            1. ACADEMIC PERFORMANCE
               - Assessment of current GPA trends
               - Recommendations for improvement strategies
            
            2. ATTENDANCE PATTERNS
               - Evaluation of attendance rates
               - Suggestions for improving attendance
            
            3. RESOURCE ALLOCATION
               - Where should the school focus resources?
               - What programs might be most beneficial?
            
            4. EARLY INTERVENTION
               - Which students might need additional support?
               - What warning signs should we monitor?
            
            Provide specific, actionable recommendations that the school can implement.
            """;return C.ai.generate_response(F)
		except Exception as G:return f"Unable to generate insights: {str(G)}"
	def update_student(A,update_data):
		'Update student information'
		try:A.db.update_student(update_data);return _A
		except Exception as B:return _F
class GPACalculator:
	'\n    Handles GPA calculation and academic performance tracking\n    Separate from DatabaseManager to maintain clean separation of concerns\n    '
	def __init__(A,db_manager):A.db_manager=db_manager
	def calculate_gpa(D,student_id,semester=_B,year=_B):
		'\n        Calculate GPA for a student based on their course grades\n        \n        Args:\n            student_id: Student ID\n            semester: Specific semester (optional, calculates for all if None)\n            year: Specific year (optional, calculates for all if None)\n            \n        Returns:\n            float: Calculated GPA on 4.0 scale\n        ';E=semester
		try:
			A='\n                SELECT g.grade, c.credits\n                FROM grades g\n                JOIN courses c ON g.course_id = c.course_id\n                WHERE g.student_id = ?\n            ';B=[student_id]
			if E:A+=' AND g.semester = ?';B.append(E)
			if year:A+=' AND g.year = ?';B.append(year)
			F=D.db_manager.execute_query(A,tuple(B))
			if not F:return _D
			G=_D;C=0
			for(H,credits)in F:
				if H is not _B and credits is not _B:I=D._convert_to_4_scale(H);G+=I*credits;C+=credits
			return round(G/C,2)if C>0 else _D
		except Exception as J:return _D
	def _convert_to_4_scale(B,percentage_grade):
		'Convert percentage grade to 4.0 GPA scale';A=percentage_grade
		if A>=75:return 4.
		elif A>=70:return 3.5
		elif A>=65:return 3.
		elif A>=60:return 2.5
		elif A>=55:return 2.
		elif A>=50:return 1.5
		elif A>=45:return 1.
		elif A>=40:return .5
		else:return _D
	def update_student_gpa(A,student_id,semester=_B,year=_B):
		"\n        Calculate and update student's GPA in the database\n        \n        Returns:\n            float: The calculated GPA that was stored\n        ";B=student_id
		try:C=A.calculate_gpa(B,semester,year);A.db_manager.execute_update('UPDATE students SET gpa = ? WHERE student_id = ?',(C,B));return C
		except Exception as D:return _D
	def bulk_update_all_gpas(A):
		'\n        Update GPAs for all active students\n        \n        Returns:\n            Dict[str, float]: Dictionary mapping student_id to their calculated GPA\n        '
		try:
			B=A.db_manager.execute_query(_BE);C={}
			if B:
				for(D,F)in B:
					try:E=A.update_student_gpa(D);C[D]=E
					except Exception:continue
			return C
		except Exception as G:return{}
	def get_gpa_by_semester(A,student_id):
		'\n        Get GPA breakdown by semester for a student\n        \n        Returns:\n            List of dictionaries with semester, year, and GPA\n        ';B=student_id
		try:
			G="\n                SELECT DISTINCT semester, year\n                FROM grades\n                WHERE student_id = ?\n                ORDER BY year DESC, \n                    CASE semester\n                        WHEN 'Trinity' THEN 1\n                        WHEN 'Lent' THEN 2\n                        WHEN 'Advent' THEN 3\n                    END\n            ";C=A.db_manager.execute_query(G,(B,));D=[]
			if C:
				for(E,F)in C:H=A.calculate_gpa(B,E,F);D.append({_A6:E,_A0:F,_G:H})
			return D
		except Exception as I:return[]
	def get_class_gpa_statistics(F,grade_level=_B):
		'\n        Get GPA statistics for a class or entire school\n        \n        Returns:\n            Dictionary with average, min, max GPAs and distribution\n        ';B=grade_level
		try:
			C="\n                SELECT s.student_id, s.name, s.gpa, s.grade\n                FROM students s\n                WHERE s.status = 'active' AND s.gpa IS NOT NULL\n            ";D=[]
			if B:C+=' AND s.grade = ?';D.append(B)
			E=F.db_manager.execute_query(C,tuple(D))
			if not E:return{_AL:0,_Ab:_D,_AA:_D,_Ay:_D,_Az:{}}
			A=[B for(A,A,B,A)in E if B is not _B]
			if not A:return{_AL:0,_Ab:_D,_AA:_D,_Ay:_D,_Az:{}}
			G={'A (3.5-4.0)':len([A for A in A if A>=3.5]),'B (2.5-3.49)':len([A for A in A if 2.5<=A<3.5]),'C (1.5-2.49)':len([A for A in A if 1.5<=A<2.5]),'D (1.0-1.49)':len([A for A in A if 1.<=A<1.5]),'F (0.0-0.99)':len([A for A in A if A<1.])};return{_AL:len(A),_Ab:round(sum(A)/len(A),2),_AA:min(A),_Ay:max(A),_Az:G}
		except Exception as H:return{_AL:0,_Ab:_D,_AA:_D,_Ay:_D,_Az:{}}
class AIHelperFunctions:
	'Class containing AI helper functions for data compilation'
	def __init__(A,db_manager):'Initialize with database manager instance';A.db=db_manager
	def compile_school_data(C):
		'Compile comprehensive school data from all tables'
		try:A=C.db.execute_query("SELECT COUNT(*) as total, AVG(gpa) as avg_gpa, AVG(attendance_rate) as avg_attendance FROM students WHERE status = 'active'");B=C.db.execute_query("SELECT COUNT(*) as total, AVG(performance_score) as avg_performance FROM teachers WHERE status = 'active'");E=C.db.execute_query('SELECT COUNT(*) as total FROM courses');D=C.db.execute_query('SELECT AVG(grade) as avg_grade FROM grades WHERE year = (SELECT MAX(year) FROM grades)');F=C.db.execute_query('SELECT status, COUNT(*) as count FROM attendance GROUP BY status');G=C.db.execute_query('SELECT type, SUM(amount) as total FROM finance GROUP BY type');H=A[0][0]if A and len(A)>0 else 0;I=A[0][1]if A and len(A)>0 and A[0][1]is not _B else 0;J=A[0][2]if A and len(A)>0 and A[0][2]is not _B else 0;K=B[0][0]if B and len(B)>0 else 0;L=B[0][1]if B and len(B)>0 and B[0][1]is not _B else 0;M=E[0][0]if E and len(E)>0 else 0;N=D[0][0]if D and len(D)>0 and D[0][0]is not _B else 0;O=_z.join([f"- {A[0]}: {A[1]}"for A in F])if F else'No attendance data';P=_z.join([f"- {A[0]}: ${A[1]:,.2f}"for A in G])if G else'No financial data';Q=f"""
            STUDENT STATISTICS:
            - Total Active Students: {H}
            - Average GPA: {I:.2f}
            - Average Attendance Rate: {J:.1f}%
            
            TEACHER STATISTICS:
            - Total Active Teachers: {K}
            - Average Performance Score: {L:.1f}
            
            ACADEMIC DATA:
            - Total Courses: {M}
            - Average Grade: {N:.2f}
            
            ATTENDANCE SUMMARY:
            {O}
            
            FINANCIAL SUMMARY:
            {P}
            """;return Q
		except Exception as R:return f"Error compiling school data: {str(R)}"
	def compile_report_data(A):'Compile data for reporting';return A.compile_school_data()
	def compile_trends_data(A):
		'Compile historical data for trend analysis'
		try:B=A.db.execute_query('SELECT year, semester, AVG(grade) as avg_grade FROM grades GROUP BY year, semester ORDER BY year, semester');C=A.db.execute_query('SELECT substr(admission_date, 1, 4) as year, COUNT(*) as enrolled FROM students WHERE admission_date IS NOT NULL GROUP BY substr(admission_date, 1, 4) ORDER BY year');D=_z.join([f"- {A[0]} {A[1]}: {A[2]:.2f}"for A in B])if B else'No grade trend data';E=_z.join([f"- {A[0]}: {A[1]} students"for A in C])if C else'No enrollment trend data';F=f"""
            GRADE TRENDS:
            {D}
            
            ENROLLMENT TRENDS:
            {E}
            """;return F
		except Exception as G:return f"Error compiling trends data: {str(G)}"
	def compile_risk_data(C):
		'Compile data for risk assessment'
		try:B=C.db.execute_query("SELECT COUNT(*) FROM students WHERE (gpa < 2.0 OR attendance_rate < 80 OR behavior_score < 70) AND status = 'active'");A=C.db.execute_query("SELECT COUNT(*), COALESCE(SUM(amount), 0) FROM finance WHERE status = 'pending' AND date < date('now', '-30 days')");D=B[0][0]if B and len(B)>0 else 0;E=A[0][0]if A and len(A)>0 else 0;F=A[0][1]if A and len(A)>0 and A[0][1]is not _B else 0;G=f"""
            ACADEMIC RISKS:
            - At-risk students (low GPA/attendance/behavior): {D}
            
            FINANCIAL RISKS:
            - Overdue payments: {E}
            - Total overdue amount: ${F:,.2f}
            """;return G
		except Exception as H:return f"Error compiling risk data: {str(H)}"
	def compile_academic_data(A):
		'Compile academic performance data'
		try:B=A.db.execute_query("\n                SELECT \n                    CASE \n                        WHEN grade >= 90 THEN 'A' \n                        WHEN grade >= 80 THEN 'B' \n                        WHEN grade >= 70 THEN 'C' \n                        WHEN grade >= 60 THEN 'D' \n                        ELSE 'F' \n                    END as letter_grade, \n                    COUNT(*) \n                FROM grades \n                WHERE grade IS NOT NULL \n                GROUP BY letter_grade\n            ");C=A.db.execute_query('\n                SELECT c.name, AVG(g.grade) as avg_grade \n                FROM courses c \n                JOIN grades g ON c.course_id = g.course_id \n                WHERE g.grade IS NOT NULL\n                GROUP BY c.course_id, c.name \n                ORDER BY avg_grade DESC\n            ');D=_z.join([f"- Grade {A[0]}: {A[1]} students"for A in B])if B else'No grade distribution data';E=_z.join([f"- {A[0]}: {A[1]:.2f}"for A in C[:10]])if C else'No course performance data';F=f"""
            GRADE DISTRIBUTION:
            {D}
            
            COURSE PERFORMANCE:
            {E}
            """;return F
		except Exception as G:return f"Error compiling academic data: {str(G)}"
	def compile_admin_data(A):
		'Compile administrative data'
		try:B=A.db.execute_query("\n                SELECT s.grade_level, s.stream_type, \n                       COUNT(st.student_id) as enrolled, \n                       s.max_capacity \n                FROM streams s \n                LEFT JOIN students st ON s.stream_id = st.stream_id AND st.status = 'active'\n                GROUP BY s.stream_id, s.grade_level, s.stream_type, s.max_capacity\n            ");C=A.db.execute_query("\n                SELECT t.name, COUNT(c.course_id) as courses \n                FROM teachers t \n                LEFT JOIN courses c ON t.teacher_id = c.teacher_id \n                WHERE t.status = 'active'\n                GROUP BY t.teacher_id, t.name\n            ");D=_z.join([f"- {A[0]} {A[1]}: {A[2]}/{A[3]} ({A[2]/A[3]*100 if A[3]>0 else 0:.1f}%)"for A in B])if B else'No stream data';E=_z.join([f"- {A[0]}: {A[1]} courses"for A in C[:10]])if C else'No teacher workload data';F=f"""
            STREAM UTILIZATION:
            {D}
            
            TEACHER WORKLOAD:
            {E}
            """;return F
		except Exception as G:return f"Error compiling administrative data: {str(G)}"
	def compile_financial_data(A):
		'Compile financial data'
		try:B=A.db.execute_query('\n                SELECT type, status, COUNT(*) as count, SUM(amount) as total \n                FROM finance \n                WHERE amount IS NOT NULL\n                GROUP BY type, status\n            ');C=A.db.execute_query('\n                SELECT substr(date, 1, 7) as month, SUM(amount) as total \n                FROM finance \n                WHERE date IS NOT NULL AND amount IS NOT NULL\n                GROUP BY substr(date, 1, 7) \n                ORDER BY month DESC \n                LIMIT 12\n            ');D=_z.join([f"- {A[0]} ({A[1]}): {A[2]} transactions, ${A[3]:,.2f}"for A in B])if B else'No financial summary data';E=_z.join([f"- {A[0]}: ${A[1]:,.2f}"for A in C])if C else'No monthly trend data';F=f"""
            FINANCIAL SUMMARY BY TYPE AND STATUS:
            {D}
            
            MONTHLY FINANCIAL TRENDS (Last 12 months):
            {E}
            """;return F
		except Exception as G:return f"Error compiling financial data: {str(G)}"
	def compile_infrastructure_data(C):
		'Compile infrastructure-related data'
		try:A=C.db.execute_query("\n                SELECT \n                    (SELECT SUM(max_capacity) FROM streams) as total_capacity,\n                    (SELECT COUNT(*) FROM students WHERE status = 'active') as total_students\n            ");D=C.db.execute_query('\n                SELECT grade_level, COUNT(*) as stream_count, SUM(max_capacity) as total_capacity \n                FROM streams \n                GROUP BY grade_level\n            ');B=A[0][0]if A and len(A)>0 and A[0][0]is not _B else 0;E=A[0][1]if A and len(A)>0 and A[0][1]is not _B else 0;F=E/B*100 if B>0 else 0;G=_z.join([f"- {A[0]}: {A[1]} streams, {A[2]} capacity"for A in D])if D else'No stream distribution data';H=f"""
            CAPACITY UTILIZATION:
            - Total Capacity: {B}
            - Current Students: {E}
            - Utilization Rate: {F:.1f}%
            
            STREAM DISTRIBUTION:
            {G}
            """;return H
		except Exception as I:return f"Error compiling infrastructure data: {str(I)}"
	def compile_context_data(A):
		'Compile essential context data for AI chat'
		try:B=A.db.execute_query(_CQ);C=A.db.execute_query(_CR);D=A.db.execute_query(_BF);E=B[0][0]if B and len(B)>0 else 0;F=C[0][0]if C and len(C)>0 else 0;G=D[0][0]if D and len(D)>0 else 0;H=f"""
            SCHOOL OVERVIEW:
            - Active Students: {E}
            - Active Teachers: {F}
            - Total Courses: {G}
            """;return H
		except Exception as I:return f"Error compiling context data: {str(I)}"
	def get_data_by_type(A,data_type):
		'Get data based on specified type';B=data_type;C={_BG:A.compile_school_data,_Bo:A.compile_report_data,_BH:A.compile_trends_data,_BI:A.compile_risk_data,_BJ:A.compile_academic_data,_BK:A.compile_admin_data,_BL:A.compile_financial_data,_Bp:A.compile_infrastructure_data,_Bq:A.compile_context_data};D=C.get(B.lower())
		if D:return D()
		else:return f"Unknown data type: {B}. Available types: {_j.join(C.keys())}"
def calculate_age(birth_date):'Calculate age from birth date.';A=birth_date;B=datetime.now().date();return B.year-A.year-((B.month,B.day)<(A.month,A.day))
def get_next_grade(current_grade):'Helper function to determine next grade level';A={_R:_S,_S:_T,_T:_V,_V:_W,_W:_X,_X:_b,_b:_c,_c:_d,_d:_AJ};return A.get(current_grade,_AJ)
def main():
	Q='context_length';P='Refresh model list';O='Cloud';N='Local';initialize_ui()
	if _CS not in st.session_state:st.session_state.school_manager=SchoolManager()
	if _v not in st.session_state:st.session_state.ai_provider=AIProvider.OLLAMA
	st.sidebar.header('üßü RadioSport Scholium');st.sidebar.text(f" Version {APP_VERSION}")
	if _CT not in st.session_state:st.session_state.school_ai=SchoolAI()
	B=st.session_state.school_ai;R=st.sidebar.radio('AI Provider',[N,O],key='ai_provider_select');S={N:AIProvider.OLLAMA.value,O:AIProvider.OPENROUTER.value};T=S[R];st.session_state.ai_provider=AIProvider(T);B.provider=st.session_state.ai_provider
	if st.session_state.ai_provider==AIProvider.OLLAMA:
		st.sidebar.subheader('üîß Ollama Settings')
		with st.sidebar.expander('Server Configuration',expanded=_F):
			E=st.text_input('Ollama Server URL',value=st.session_state.get(_q,_B9),placeholder=_B9,help='Change if running Ollama on different host/port')
			if E!=st.session_state.get(_q,_B9):
				st.session_state.ollama_url=E;B.ollama_url=E;st.session_state.ollama_models=[]
				if _Y in st.session_state:del st.session_state.ai_model
			if st.button('üîÑ Test Connection',key='sidebar_test_ollama'):
				I=B.get_ollama_models()
				if I:st.success(f"‚úÖ Connected! {len(I)} models found")
				else:st.error('‚ùå Connection failed')
		F,G=st.sidebar.columns([3,1])
		with F:
			if not st.session_state.get(_Bg,[]):B.get_ollama_models()
			C=st.session_state.get(_Bg,[])
			if C:
				A=st.session_state.get(_Y)
				if not A or A not in C:A=C[0];st.session_state.ai_model=A
				J=st.selectbox('Available Models',C,index=C.index(A),key='sidebar_ollama_model');st.session_state.ai_model=J;B.model=J
			else:
				st.warning('‚ö†Ô∏è No models found.');st.info('Install models:')
				if _Y in st.session_state:del st.session_state.ai_model
				B.model=_B
		with G:
			if st.button('üîÑ',key='sidebar_refresh_ollama',help=P):
				st.session_state.ollama_models=[]
				if _Y in st.session_state:del st.session_state.ai_model
				B.get_ollama_models();st.rerun()
	else:
		st.sidebar.subheader('Model:');F,G=st.sidebar.columns([3,1])
		with F:
			if not st.session_state.get(_Bf,[]):B.get_openrouter_free_models()
			C=st.session_state.get(_Bf,[])
			if C:
				K=[f"{A.get(_E,A['id'])}"for A in C];D=[A['id']for A in C];A=st.session_state.get(_Y)
				if not A or A not in D:
					A=D[0]if D else _B
					if A:st.session_state.ai_model=A
				if A:
					U=D.index(A);L=st.selectbox('Free Models',range(len(K)),format_func=lambda x:K[x],index=U,key='sidebar_openrouter_model',help='Only free models are shown');H=D[L];st.session_state.ai_model=H;B.model=H;M=C[L];st.sidebar.caption(f"ID: {H}")
					if Q in M:st.sidebar.caption(f"Context: {M[Q]:,} tokens")
			else:
				st.sidebar.warning('‚ö†Ô∏è No free models available')
				if B.openrouter_key:st.sidebar.info('Check your internet connection or try refreshing.')
				if _Y in st.session_state:del st.session_state.ai_model
				B.model=_B
		with G:
			if st.button('üîÑ',key='sidebar_refresh_openrouter',help=P):
				st.session_state.openrouter_models=[]
				if _Y in st.session_state:del st.session_state.ai_model
				B.get_openrouter_free_models();st.rerun()
	if A==_CU:st.sidebar.error('‚ö†Ô∏è Please select a model to continue')
	st.title('üè´ RadioSport Scholium');V,W,X,Y,Z,a,b,c,d,e=st.tabs(['üìä Dashboard','üë• Admissions','üéì Students',_CV,'üìö Academics','üí∞ Finance','üìà Analytics','ü§ñ AI Insights','üè´ Streams',_CW])
	with V:dashboard_page()
	with W:admissions_page()
	with X:students_page()
	with Y:teachers_page()
	with Z:academics_page()
	with a:finance_page()
	with b:analytics_page()
	with c:ai_insights_page()
	with d:streams_page()
	with e:data_input_page()
def dashboard_page():
	Bf='Period';Be='No student data available';Bd='behavior';Bc='Avg Transaction';Bb='Fees Revenue';Ba='Tuition Revenue';BZ='recent_activity_rate';BY='average_transaction_amount';BX='fees_revenue';BW='tuition_revenue';BV='total_revenue';BU='student_teacher_ratio';BT='students_with_low_attendance';BS='students_with_perfect_attendance';BR='average_attendance_rate';BQ='at_risk_percentage';BP='at_risk_students';BO='high_performer_percentage';BN='high_performers';BM='system_health';BL='Optimal';BK='inverse';BJ='orange';BI='Attendance Range';BH='lightgray';BG='darkblue';BF='Transactions';BE='#4CAF50';BD='Revenue Type';BC='viridis';BB='High Performers';AU='Enrollment';AT='Health Score';AS='staffing_metrics';AR='Recent Activity';AQ='lightcoral';AP='spline';AH='attendance_metrics';AG='Student-Teacher Ratio';AF='normal';AE='yellow';AD='lightgreen';AC='Attendance Rate';AB='Category';AA='0%';A1='financial_summary';A0='Capacity Utilization';z='width';y='thickness';x='line';w='threshold';v='steps';u='bar';t='axis';s='gauge+number';j='text';g='academic_performance';H='range';C='color';Q=DatabaseManager();N=st.session_state.get('currency_symbol','‚Çµ')
	try:Bg="\n            SELECT student_id, name, age, grade, gpa, behavior_score, status, stream_id\n            FROM students \n            WHERE status = 'active'\n        ";A=Q.execute_query(Bg);Bh="\n            SELECT teacher_id, name, subject, department, performance_score, salary, status\n            FROM teachers \n            WHERE status = 'active'\n        ";O=Q.execute_query(Bh);Bi=_BF;AI=Q.execute_query(Bi)[0][0];Bj="\n            SELECT s.stream_id, s.grade_level, s.stream_type, s.max_capacity,\n                   COUNT(st.student_id) as current_students\n            FROM streams s\n            LEFT JOIN students st ON s.stream_id = st.stream_id AND st.status = 'active'\n            GROUP BY s.stream_id, s.grade_level, s.stream_type, s.max_capacity\n        ";D=Q.execute_query(Bj);Bk="\n            SELECT \n                SUM(CASE WHEN type = 'tuition' THEN amount ELSE 0 END) as tuition_revenue,\n                SUM(CASE WHEN type = 'fees' THEN amount ELSE 0 END) as fees_revenue,\n                SUM(amount) as total_revenue,\n                COUNT(*) as total_transactions,\n                date,\n                type,\n                amount\n            FROM finance\n        ";M=Q.execute_query(Bk);Bl="\n            SELECT \n                strftime('%Y-%m', date) as month,\n                SUM(amount) as monthly_revenue,\n                COUNT(*) as monthly_transactions\n            FROM finance\n            GROUP BY strftime('%Y-%m', date)\n            ORDER BY month DESC\n            LIMIT 12\n        ";J=Q.execute_query(Bl);Bm="\n            SELECT \n                COUNT(DISTINCT student_id) as students_with_records,\n                AVG(CASE WHEN status = 'present' THEN 100.0 ELSE 0.0 END) as avg_attendance_rate\n            FROM attendance\n            WHERE date >= date('now', '-7 days')\n        ";k=Q.execute_query(Bm);Bn="\n            SELECT \n                date,\n                COUNT(*) as total_records,\n                SUM(CASE WHEN status = 'present' THEN 1 ELSE 0 END) as present_count,\n                ROUND(AVG(CASE WHEN status = 'present' THEN 100.0 ELSE 0.0 END), 1) as attendance_rate\n            FROM attendance\n            WHERE date >= date('now', '-30 days')\n            GROUP BY date\n            ORDER BY date\n        ";AV=Q.execute_query(Bn)
	except Exception as Bo:st.error(f"Error loading dashboard data: {str(Bo)}");return
	B={}
	if A:
		for K in A:
			W=K[0];Bp=_CX;AW=Q.execute_query(Bp,(W,))[0][0]
			if AW>0:Bq="SELECT COUNT(*) FROM attendance WHERE student_id = ? AND status = 'present'";Br=Q.execute_query(Bq,(W,))[0][0];B[W]=Br/AW*100
			else:B[W]=1e2
	G=len(A)if A else 0;l=sum(A[4]for A in A)/len(A)if A else 0;m=sum(B.values())/len(B)if B else 0;a=len(O)if O else 0;A2=len([A for A in A if A[4]>=3.5])if A else 0;A3=len([A for A in A if A[4]<2.5 or B.get(A[0],100)<75])if A and B else 0;b=M[0][2]if M and M[0][2]else 0;A4=M[0][0]if M and M[0][0]else 0;A5=M[0][1]if M and M[0][1]else 0;R=M[0][3]if M and M[0][3]else 0;st.subheader(_CY);E,F,S,n,Bs=st.columns(5)
	with E:st.metric(_s,G)
	with F:st.metric(_AM,f"{l:.2f}")
	with S:st.metric(_Br,f"{m:.1f}%")
	with n:st.metric(_CZ,a)
	with Bs:st.metric(_Ca,AI)
	E,F,S,n=st.columns(4)
	with E:AX=len(D)if D else 0;st.metric('Active Streams',AX)
	with F:st.metric(BB,A2,delta=f"{A2/G*100:.1f}%"if G>0 else AA)
	with S:st.metric(_Bs,A3,delta=f"{A3/G*100:.1f}%"if G>0 else AA)
	with n:st.metric(_BM,f"{N}{b:,.2f}")
	st.divider();st.subheader('üìà Visual Analytics');Bt,Bu,Bv,Bw,Bx=st.tabs(['üìö Academic','üë• Demographics',_Cb,_Cc,'üè¢ Operations'])
	with Bt:
		E,F=st.columns(2)
		with E:
			if A:By=['4.0+','3.5-3.9','3.0-3.4','2.5-2.9','2.0-2.4','<2.0'];Bz=[len([A for A in A if A[4]>=4.]),len([A for A in A if 3.5<=A[4]<4.]),len([A for A in A if 3.<=A[4]<3.5]),len([A for A in A if 2.5<=A[4]<3.]),len([A for A in A if 2.<=A[4]<2.5]),len([A for A in A if A[4]<2.])];B_=pd.DataFrame({_BN:By,_AN:Bz});AY=px.bar(B_,x=_BN,y=_AN,title=_Cd,color=_AN,color_continuous_scale=BC);AY.update_layout(height=400);st.plotly_chart(AY,use_container_width=_A)
		with F:
			if A:C0=len([A for A in A if A[4]>=3.7]);C1=len([A for A in A if 3.<=A[4]<3.7]);C2=len([A for A in A if 2.5<=A[4]<3.]);C3=len([A for A in A if A[4]<2.5]);C4=pd.DataFrame({AB:[_A_,_Ap,'Satisfactory','Needs Improvement'],_e:[C0,C1,C2,C3]});AZ=px.pie(C4,values=_e,names=AB,title='Academic Performance Distribution',color_discrete_sequence=px.colors.qualitative.Set3);AZ.update_layout(height=400);st.plotly_chart(AZ,use_container_width=_A)
		if A:
			A6={}
			for K in A:
				o=K[3];h=K[4]
				if o not in A6:A6[o]=[]
				A6[o].append(h)
			Aa={B:sum(A)/len(A)for(B,A)in A6.items()};AJ=pd.DataFrame({_f:list(Aa.keys()),_AM:list(Aa.values())});Ab=px.line(AJ,x=_f,y=_AM,title='Average GPA by Grade Level',markers=_A,line_shape=AP);Ab.update_layout(height=400);st.plotly_chart(Ab,use_container_width=_A)
	with Bu:
		E,F=st.columns(2)
		with E:
			if A:C5=[A[2]for A in A];C6=pd.DataFrame({_AS:C5});Ac=px.histogram(C6,x=_AS,nbins=15,title=_Ce,color_discrete_sequence=['#FF6B6B']);Ac.update_layout(height=400);st.plotly_chart(Ac,use_container_width=_A)
		with F:
			if A:C7=[A[3]for A in A];Ad=pd.Series(C7).value_counts().sort_index();AJ=pd.DataFrame({_f:Ad.index,_J:Ad.values});Ae=px.bar(AJ,x=_f,y=_J,title=_Cf,color=_J,color_continuous_scale='blues');Ae.update_layout(height=400);st.plotly_chart(Ae,use_container_width=_A)
		if O:
			Af=[A[3]for A in O if A[3]]
			if Af:Ag=pd.Series(Af).value_counts();C8=pd.DataFrame({_Q:Ag.index,_AO:Ag.values});Ah=px.pie(C8,values=_AO,names=_Q,title='Teacher Distribution by Department',color_discrete_sequence=px.colors.qualitative.Pastel);Ah.update_layout(height=400);st.plotly_chart(Ah,use_container_width=_A)
	with Bv:
		E,F=st.columns(2)
		with E:
			if A4>0 or A5>0:C9=pd.DataFrame({BD:[_Bt,'Fees'],_AT:[A4,A5]});Ai=px.pie(C9,values=_AT,names=BD,title='Revenue Breakdown',color_discrete_sequence=[BE,'#2196F3']);Ai.update_layout(height=400);st.plotly_chart(Ai,use_container_width=_A)
		with F:
			if J:c=pd.DataFrame(J,columns=[_AC,_Ac,BF]);c=c.sort_values(_AC);Aj=px.line(c,x=_AC,y=_Ac,title='Monthly Revenue Trend',markers=_A,line_shape=AP);Aj.update_layout(height=400);st.plotly_chart(Aj,use_container_width=_A)
		if b>0:
			E,F,S=st.columns(3)
			with E:X=b/R if R>0 else 0;Ak=go.Figure(go.Indicator(mode=s,value=X,domain={_k:[0,1],_l:[0,1]},title={j:f"Avg Transaction ({N})"},gauge={t:{H:[_B,X*2]},u:{C:BG},v:[{H:[0,X*.5],C:BH},{H:[X*.5,X*1.5],C:'gray'}],w:{x:{C:_t,z:4},y:.75,_Ah:X*1.2}}));Ak.update_layout(height=300);st.plotly_chart(Ak,use_container_width=_A)
			with F:
				if len(J)>=2:p=J[0][1];q=J[1][1];Al=go.Figure(go.Indicator(mode='number+delta',value=p,delta={'reference':q,'valueformat':'.0f'},title={j:f"Monthly Revenue ({N})"}));Al.update_layout(height=300);st.plotly_chart(Al,use_container_width=_A)
			with S:st.metric(_Bu,R);st.metric('Revenue per Student',f"{N}{b/G:.2f}"if G>0 else _i)
	with Bw:
		E,F=st.columns(2)
		with E:
			if B:CA=['95-100%','90-94%','85-89%','80-84%','75-79%','<75%'];CB=[len([A for A in B.values()if A>=95]),len([A for A in B.values()if 90<=A<95]),len([A for A in B.values()if 85<=A<90]),len([A for A in B.values()if 80<=A<85]),len([A for A in B.values()if 75<=A<80]),len([A for A in B.values()if A<75])];CC=pd.DataFrame({BI:CA,_AN:CB});Am=px.bar(CC,x=BI,y=_AN,title='Attendance Rate Distribution',color=_AN,color_continuous_scale=_Bv);Am.update_layout(height=400);st.plotly_chart(Am,use_container_width=_A)
		with F:
			if AV:CD=pd.DataFrame(AV,columns=[_AU,'Total Records','Present Count',AC]);An=px.line(CD,x=_AU,y=AC,title='Daily Attendance Trend (Last 30 Days)',markers=_A,line_shape=AP);An.update_layout(height=400);st.plotly_chart(An,use_container_width=_A)
		if A and B:
			Ao=[]
			for K in A:W=K[0];h=K[4];CE=B.get(W,100);Ao.append({_h:h,AC:CE})
			CF=pd.DataFrame(Ao);Ap=px.scatter(CF,x=AC,y=_h,title='Attendance vs Academic Performance Correlation',trendline='ols');Ap.update_layout(height=400);st.plotly_chart(Ap,use_container_width=_A)
	with Bx:
		E,F=st.columns(2)
		with E:
			if D:A7=pd.DataFrame(D,columns=[_Ad,_A1,'Stream Type',_BO,_Ae]);A7[_B0]=(A7[_Ae]/A7[_BO]*100).round(1);AK=px.bar(A7,x=_Ad,y=_B0,title='Stream Capacity Utilization',color=_B0,color_continuous_scale='RdYlGn_r');AK.add_hline(y=100,line_dash=_AD,line_color=_t,annotation_text=_Cg);AK.update_layout(height=400);st.plotly_chart(AK,use_container_width=_A)
		with F:
			if O:
				Aq=[A[4]for A in O if A[4]is not _B]
				if Aq:CG=pd.DataFrame({_AV:Aq});Ar=px.histogram(CG,x=_AV,nbins=10,title='Teacher Performance Score Distribution',color_discrete_sequence=['#FF9800']);Ar.update_layout(height=400);st.plotly_chart(Ar,use_container_width=_A)
		st.subheader('üè• System Health Dashboard');CH,CI,CJ,CK=st.columns(4)
		with CH:L=G/a if a>0 else 0;As=go.Figure(go.Indicator(mode=s,value=L,domain={_k:[0,1],_l:[0,1]},title={j:'Student:Teacher Ratio'},gauge={t:{H:[_B,40]},u:{C:'darkgreen'if L<=20 else BJ if L<=30 else _t},v:[{H:[0,20],C:AD},{H:[20,30],C:AE},{H:[30,40],C:AQ}],w:{x:{C:_t,z:4},y:.75,_Ah:25}}));As.update_layout(height=300);st.plotly_chart(As,use_container_width=_A)
		with CI:
			if D:Y=sum(A[3]for A in D);i=sum(A[4]for A in D);T=i/Y*100 if Y>0 else 0;At=go.Figure(go.Indicator(mode=s,value=T,domain={_k:[0,1],_l:[0,1]},title={j:'Capacity Utilization %'},gauge={t:{H:[_B,120]},u:{C:BG},v:[{H:[0,75],C:BH},{H:[75,90],C:AE},{H:[90,100],C:AD},{H:[100,120],C:_t}],w:{x:{C:_t,z:4},y:.75,_Ah:100}}));At.update_layout(height=300);st.plotly_chart(At,use_container_width=_A)
		with CJ:Au=go.Figure(go.Indicator(mode=s,value=l,domain={_k:[0,1],_l:[0,1]},title={j:_AM},gauge={t:{H:[_B,4.]},u:{C:'purple'},v:[{H:[0,2.],C:AQ},{H:[2.,3.],C:AE},{H:[3.,4.],C:AD}],w:{x:{C:_t,z:4},y:.75,_Ah:3.5}}));Au.update_layout(height=300);st.plotly_chart(Au,use_container_width=_A)
		with CK:Av=go.Figure(go.Indicator(mode=s,value=m,domain={_k:[0,1],_l:[0,1]},title={j:'Avg Attendance %'},gauge={t:{H:[_B,100]},u:{C:'teal'},v:[{H:[0,70],C:AQ},{H:[70,85],C:AE},{H:[85,100],C:AD}],w:{x:{C:_t,z:4},y:.75,_Ah:90}}));Av.update_layout(height=300);st.plotly_chart(Av,use_container_width=_A)
	st.divider();st.subheader('üè• System Health & Status');E,F,S=st.columns(3)
	with E:
		if D:
			Y=sum(A[3]for A in D);i=sum(A[4]for A in D);T=i/Y*100 if Y>0 else 0
			if T>90:st.metric(A0,f"{T:.1f}%",delta='Near Full',delta_color=BK)
			elif T>75:st.metric(A0,f"{T:.1f}%",delta=_Ap,delta_color=AF)
			else:st.metric(A0,f"{T:.1f}%",delta='Available',delta_color=AF)
		else:st.metric(A0,AA)
	with F:
		L=G/a if a>0 else 0
		if L>25:st.metric(AG,f"{L:.1f}:1",delta='High Load',delta_color=BK)
		elif L>20:st.metric(AG,f"{L:.1f}:1",delta='Moderate',delta_color=AF)
		else:st.metric(AG,f"{L:.1f}:1",delta=BL,delta_color=AF)
	with S:
		if k and k[0][0]:CL=k[0][0];Aw=CL/G*100 if G>0 else 0;st.metric(AR,f"{Aw:.1f}%",delta='Last 7 days')
		else:st.metric(AR,AA,delta='No recent data')
	st.divider();st.subheader('üöÄ Quick Actions');E,F,S,n=st.columns(4)
	with E:
		if st.button('üìä Generate Analytics Report',type=_AW,use_container_width=_A):
			with st.spinner('Generating comprehensive analytics report...'):
				I={g:{_BP:G,_Ab:round(l,2),BN:A2,BO:round(A2/G*100,1)if G>0 else 0,BP:A3,BQ:round(A3/G*100,1)if G>0 else 0},AH:{BR:round(m,1),BS:len([A for A in B.values()if A>=95])if B else 0,BT:len([A for A in B.values()if A<75])if B else 0},AS:{'total_teachers':a,BU:round(L,1),_AR:round(T,1)if D else 0},A1:{BV:b,BW:A4,BX:A5,'total_transactions':R,BY:round(b/R,2)if R>0 else 0},BM:{'total_courses':AI,'active_streams':AX,BZ:round(Aw,1)if k and k[0][0]else 0}};st.success('‚úÖ Analytics report generated successfully!')
				with st.expander('üìã Comprehensive Analytics Report',expanded=_A):
					st.markdown('### üìö Academic Performance');U,V,r=st.columns(3)
					with U:st.metric(_s,I[g][_BP]);st.metric(_AM,I[g][_Ab])
					with V:st.metric(BB,f"{I[g][BN]} ({I[g][BO]}%)")
					with r:st.metric(_Bs,f"{I[g][BP]} ({I[g][BQ]}%)")
					st.markdown('### üìÖ Attendance Analysis');U,V,r=st.columns(3)
					with U:st.metric(_Br,f"{I[AH][BR]}%")
					with V:st.metric('Perfect Attendance',I[AH][BS])
					with r:st.metric('Low Attendance',I[AH][BT])
					st.markdown('### üí∞ Financial Summary');U,V=st.columns(2)
					with U:st.metric(_BM,f"{N}{I[A1][BV]:,.2f}");st.metric(Ba,f"{N}{I[A1][BW]:,.2f}")
					with V:st.metric(Bb,f"{N}{I[A1][BX]:,.2f}");st.metric(Bc,f"{N}{I[A1][BY]:.2f}")
					st.markdown('### üè• System Health');U,V,r=st.columns(3)
					with U:st.metric(AG,f"{I[AS][BU]}:1")
					with V:st.metric(A0,f"{I[AS][_AR]}%")
					with r:st.metric(AR,f"{I[BM][BZ]}%")
					st.markdown('### üì• Export Options');CM=json.dumps(I,indent=2);st.download_button(label='üì• Download Report as JSON',data=CM,file_name=f"school_analytics_report_{pd.Timestamp.now().strftime(_A7)}.json",mime=_AQ)
	with F:
		if st.button('üéØ Identify At-Risk Students',use_container_width=_A):
			if A:
				d=[]
				for K in A:
					W,CN,Cm,o,h,Ax=K[:6];Ay=B.get(W,100)
					if h<2.5 or Ay<75 or Ax<70:d.append({_E:CN,_H:o,_G:h,_AE:Ay,Bd:Ax})
				if d:
					st.warning(f"‚ö†Ô∏è Found {len(d)} at-risk students")
					with st.expander('View At-Risk Students'):
						CO=pd.DataFrame(d);AL=px.scatter(CO,x=_AE,y=_G,size=Bd,hover_name=_E,title='At-Risk Students Analysis',labels={_AE:_B1,_G:_h},color=_H);AL.add_hline(y=2.5,line_dash=_AD,line_color=_t,annotation_text=_Ch);AL.add_vline(x=75,line_dash=_AD,line_color=_t,annotation_text='Minimum Attendance');st.plotly_chart(AL,use_container_width=_A)
						for K in d[:5]:st.write(f"‚Ä¢ **{K[_E]}** (Grade {K[_H]}) - GPA: {K[_G]:.2f}, Attendance: {K[_AE]:.1f}%")
						if len(d)>5:st.write(f"... and {len(d)-5} more")
				else:st.success('‚úÖ No at-risk students identified!')
			else:st.info(Be)
	with S:
		if st.button('üí∞ Financial Summary',use_container_width=_A):
			st.success('üí∞ Financial summary generated!')
			with st.expander(_Ci):
				U,V=st.columns(2)
				with U:st.metric(Ba,f"{N}{A4:,.2f}");st.metric(_Bu,R)
				with V:st.metric(Bb,f"{N}{A5:,.2f}");X=b/R if R>0 else 0;st.metric(Bc,f"{N}{X:.2f}")
				if J:c=pd.DataFrame(J,columns=[_AC,_Ac,BF]);c=c.sort_values(_AC);CP=px.area(c,x=_AC,y=_Ac,title='Revenue Trend Over Time',color_discrete_sequence=[BE]);st.plotly_chart(CP,use_container_width=_A)
	with n:
		if st.button('üîÑ System Health Check',use_container_width=_A):
			with st.spinner('Running system health check...'):
				Z=[]
				if not A:Z.append('‚ö†Ô∏è No active students found')
				if not O:Z.append('‚ö†Ô∏è No active teachers found')
				if not D:Z.append('‚ö†Ô∏è No streams configured')
				if A and B:
					Az=len([A for A in B.values()if A<70])
					if Az>G*.2:Z.append(f"‚ö†Ô∏è High absenteeism: {Az} students")
				if A:
					AM=len([A for A in A if A[4]<2.])
					if AM>G*.15:Z.append(f"‚ö†Ô∏è Academic concerns: {AM} students with GPA < 2.0")
				if Z:
					st.warning(f"üö® Found {len(Z)} system issues")
					with st.expander('View Health Issues'):
						for CQ in Z:st.write(CQ)
						CR=['Data Integrity','Academic Performance',_AF,'System Resources'];CS=[100 if A and O and D else 50,100-AM/G*100 if A else 100,m if B else 100,min(100,100-T)if D else 100];CT=pd.DataFrame({AB:CR,AT:CS});A_=px.bar(CT,x=AB,y=AT,title='System Health Breakdown',color=AT,color_continuous_scale=_Bv);A_.add_hline(y=75,line_dash=_AD,line_color=BJ,annotation_text='Warning Threshold');st.plotly_chart(A_,use_container_width=_A)
				else:
					st.success('‚úÖ All systems operating normally!');CU={'System Uptime':'99.9%','Data Quality':_A_,_N:BL,'Security':'Secure'}
					for(AN,CV)in CU.items():st.metric(AN,CV)
	st.divider();st.subheader('üìà Recent Activity & Insights');E,F=st.columns(2)
	with E:
		st.markdown('**üìö Academic Performance Insights**')
		if A:B0=sorted(A,key=lambda x:x[4],reverse=_A)[:5];CW=pd.DataFrame({_AG:[f"{A[1][:15]}..."if len(A[1])>15 else A[1]for A in B0],_h:[A[4]for A in B0]});B1=px.bar(CW,x=_h,y=_AG,orientation='h',title='Top 5 Performers',color=_h,color_continuous_scale=BC);B1.update_layout(height=300);st.plotly_chart(B1,use_container_width=_A)
		else:st.write(Be)
	with F:
		st.markdown('**üë• System Statistics & Trends**')
		if D:CX=pd.DataFrame({_Aq:[f"Stream {A[0]}"for A in D[:5]],_Bw:[A[4]/A[3]*100 if A[3]>0 else 0 for A in D[:5]]});AO=px.line(CX,x=_Aq,y=_Bw,title='Stream Utilization Trend',markers=_A);AO.add_hline(y=100,line_dash=_AD,line_color=_t);AO.update_layout(height=300);st.plotly_chart(AO,use_container_width=_A)
		else:st.write('No stream data available')
	st.subheader('üîÆ Predictive Insights & Recommendations');CY,CZ,Ca=st.columns(3)
	with CY:
		st.markdown('**üìä Enrollment Projections**')
		if D:Y=sum(A[3]for A in D);i=sum(A[4]for A in D);Cb=i*1.05;Cc=pd.DataFrame({Bf:[_Bx,'Projected (Next Term)'],AU:[i,min(Cb,Y)]});B2=px.bar(Cc,x=Bf,y=AU,title='Enrollment Projection',color=AU);B2.add_hline(y=Y,line_dash=_AD,line_color=_t,annotation_text=_BO);st.plotly_chart(B2,use_container_width=_A)
	with CZ:
		st.markdown('**üí° Academic Recommendations**');e=[]
		if A:
			B3=len([A for A in A if A[4]<2.5])
			if B3>0:e.append(f"‚Ä¢ Focus on {B3} students with GPA < 2.5")
			if B:
				B4=len([A for A in B.values()if A<80])
				if B4>0:e.append(f"‚Ä¢ Implement attendance intervention for {B4} students")
			if l<3.:e.append('‚Ä¢ Consider additional academic support programs')
		if not e:e.append('‚Ä¢ Maintain current excellent performance standards');e.append('‚Ä¢ Consider advanced programs for high achievers')
		for Cd in e[:4]:st.write(Cd)
	with Ca:
		st.markdown('**üéØ Action Items**');f=[]
		if D:
			B5=[A for A in D if A[4]/A[3]>.95]
			if B5:f.append(f"‚Ä¢ Review capacity for {len(B5)} streams")
		if L>25:f.append('‚Ä¢ Consider hiring additional teachers')
		if J and len(J)>=2:
			p=J[0][1];q=J[1][1]
			if p<q*.9:f.append('‚Ä¢ Investigate revenue decline')
		if not f:f.append('‚Ä¢ Continue monitoring key metrics');f.append('‚Ä¢ Plan for next academic term')
		for Ce in f[:4]:st.write(Ce)
	if A or O:
		st.subheader('üîî Smart Alerts & Notifications');P=[]
		if A:
			B6=len([A for A in A if A[4]<2.])
			if B6>0:P.append(f"üö® {B6} students with GPA below 2.0 need immediate attention")
			if B:
				B7=len([A for A in B.values()if A<60])
				if B7>0:P.append(f"‚ö†Ô∏è {B7} students with attendance below 60%")
		if D:
			B8=[A for A in D if A[4]>A[3]]
			if B8:P.append(f"üìä {len(B8)} streams are over capacity")
		if O:
			if L>30:P.append('üë• Teacher-student ratio is critically high')
		if J and len(J)>=2:
			p=J[0][1];q=J[1][1]
			if p<q*.85:P.append('üí∞ Significant revenue decline detected')
		if P:
			Cf,Cg=st.columns([3,1])
			with Cf:
				for Ch in P:st.warning(Ch)
			with Cg:
				Ci=['Academic',_AF,'Capacity','Financial'];B9=[len([A for A in P if'üö®'in A or _h in A]),len([A for A in P if _AE in A.lower()]),len([A for A in P if _By in A.lower()or'streams'in A.lower()]),len([A for A in P if'üí∞'in A or'revenue'in A.lower()])]
				if sum(B9)>0:A8=pd.DataFrame({_AX:Ci,_e:B9});A8=A8[A8[_e]>0];BA=px.pie(A8,values=_e,names=_AX,title='Alert Categories');BA.update_layout(height=200);st.plotly_chart(BA,use_container_width=_A)
		else:
			st.success('‚úÖ No critical alerts at this time');A9=[]
			if l>=3.:A9.append('üìö Excellent academic performance maintained')
			if m>=85:A9.append('üìÖ Strong attendance rates across all grades')
			if L<=25:A9.append('üë• Optimal teacher-student ratio')
			for AN in A9:st.success(AN)
	st.markdown(_AP);Cj,Ck,Cl=st.columns(3)
	with Cj:st.caption(f"üìÖ Last updated: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S')}")
	with Ck:st.caption(f"üìä Data points: {G+a+AI}")
	with Cl:st.caption(f"üîÑ System status: {'üü¢ Online'if A or O else'üî¥ No Data'}")
def diagnose_ai_issues(manager):
	'Helper function to diagnose AI configuration issues';D=manager;C=[];B=[]
	if not hasattr(D,'ai')or not D.ai:C.append('AI system not initialized');B.append('Restart the application');return C,B
	A=D.ai;E=A._test_connection()
	if'‚ùå'in E:
		C.append(f"Connection failed: {E}")
		if hasattr(A,_BB)and A.provider.name==_BA:B.extend(['Start Ollama server: `ollama serve`',f"Verify model exists: `ollama pull {A.model}`",'Check server URL in settings'])
		else:B.extend(['Check API key configuration','Verify internet connection','Confirm model availability'])
	if hasattr(A,_BB)and A.provider.name==_BA:
		try:
			F=A.get_ollama_models()
			if A.model not in F:C.append(f"Model '{A.model}' not found in available models");B.append(f"Pull the model: `ollama pull {A.model}`")
		except:C.append('Could not retrieve model list');B.append('Check Ollama server connection')
	return C,B
def admissions_page():
	Y='Acceptance Rate';X='Active (Accepted)';W='rejected';R='AI Reasoning';st.header('üë• AI-Powered Admissions');Z,a=st.columns([1,1])
	with Z:
		st.subheader('üìù New Application')
		if _CS not in st.session_state:st.error('School management system not initialized. Please restart the application.');return
		A=st.session_state.school_manager
		if hasattr(A,'ai')and A.ai:A.ai.sync_with_session_state()
		else:st.error('AI system not initialized.');return
		with st.form('admission_form'):
			S=st.text_input(_Cj,placeholder='Enter full name');b,c=st.columns([2,1])
			with b:from datetime import datetime,date as F;d=F.today().replace(year=F.today().year-10);B=st.date_input('Date of Birth*',value=d,min_value=F(1990,1,1),max_value=F.today(),help="Student's actual date of birth")
			with c:
				if B:M=F.today();C=M.year-B.year-((M.month,M.day)<(B.month,B.day));st.metric(_AS,f"{C} years")
				else:C=6
			e=st.number_input('Previous School GPA',min_value=_D,max_value=4.,value=3.);f=st.text_area('Extracurricular Activities',placeholder='List activities');T=st.text_input('Parent Contact*',placeholder=_Ck);g=st.text_area(_Bz,placeholder='Any medical conditions');h=st.form_submit_button('ü§ñ AI Auto-Evaluate Application');i=st.selectbox('Stream Assignment Method',[_B_,_C0,_C1],help='How students are assigned to class streams',index=2)
			if h:
				D=[]
				if not S:D.append('Student Name is required')
				if not T:D.append('Parent Contact is required')
				if not B:D.append('Date of Birth is required')
				if C<3 or C>25:D.append('Age must be between 3 and 25')
				if B and B>F.today():D.append('Date of Birth cannot be in the future')
				if D:
					for j in D:st.error(j)
				else:
					from datetime import datetime;k={_E:S,_Z:C,_Aj:B.strftime(_M),_CL:e,_CM:f,_AB:T,_A9:g,_r:datetime.now().strftime(_M),_CN:i.lower().replace('-','')}
					with st.spinner('AI is evaluating the application...'):
						try:
							J=A.auto_admit_student(k)
							if not isinstance(J,dict):raise ValueError('Invalid AI response format')
							G=J.get(_I,'UNKNOWN').upper();N=J.get(_Am,'No reasoning provided')
							if G==_BC:
								st.success('üéâ Application ACCEPTED!');st.write(f"**Student ID:** {J.get(_C,_i)}");st.write(f"**Assigned Grade:** {J.get(_H,_i)}");st.write(f"**Date of Birth:** {B.strftime('%B %d, %Y')}");st.write(f"**Age:** {C} years")
								with st.expander(R):st.markdown(N)
							elif G==_An:
								st.error('‚ùå Application REJECTED')
								with st.expander(R):st.markdown(N)
							else:
								st.warning(f"‚ö†Ô∏è Unclear evaluation result: {G}")
								with st.expander(R):st.markdown(N)
						except Exception as E:st.error(f"Evaluation failed: {str(E)}")
	with a:
		st.subheader('üìä Admission Statistics')
		try:
			l=A.db.execute_query('SELECT status FROM students');H={_n:0,_BQ:0,W:0,_AK:0}
			for m in l:
				G=m[0]
				if G in H:H[G]+=1
			I={_o:[X,_Ao,_BD,_B2],_e:[H.get(_n,0),H.get(_BQ,0),H.get(W,0),H.get(_AK,0)]}
		except Exception as E:st.warning(f"Could not fetch admission statistics: {str(E)}");I={_o:[X,_Ao,_BD,_B2],_e:[0,0,0,0]}
		if sum(I[_e])>0:n=px.pie(values=I[_e],names=I[_o],title='Student Status Distribution',color_discrete_sequence=px.colors.qualitative.Pastel);st.plotly_chart(n,use_container_width=_A)
		else:st.info('üìà No admission data available yet. Submit applications to see statistics.')
		st.subheader('üìà Quick Stats');o,p=st.columns(2);K=sum(I[_e])
		with o:st.metric(_s,K)
		with p:
			if K>0:q=I[_e][0];r=round(q/K*100,1);st.metric(Y,f"{r}%")
			else:st.metric(Y,_i)
		if K>0:
			st.subheader('üë∂ Age Distribution')
			try:
				U=A.db.execute_query("SELECT age FROM students WHERE status = 'active'")
				if U:
					V=[A[0]for A in U if A[0]is not _B]
					if V:
						O={}
						for C in V:O[C]=O.get(C,0)+1
						P=pd.DataFrame(list(O.items()),columns=[_AS,_e]);P=P.sort_values(_AS);s=px.bar(P,x=_AS,y=_e,title=_Ce,color=_e,color_continuous_scale='Blues');st.plotly_chart(s,use_container_width=_A)
					else:st.info('No age data available for visualization.')
				else:st.info('No student age data found.')
			except Exception as E:st.warning(f"Could not generate age distribution: {str(E)}")
		st.subheader('ü§ñ AI Model')
		if hasattr(A,'ai')and A.ai:
			L=A.ai.provider
			if isinstance(L,AIProvider):L=L.value.title()
			st.write(f"**Model:** {st.session_state.get(_Y,_CU)}");st.write(f"**Provider:** {L}");st.write(f"**Connection Status:** {A.ai._test_connection()}")
			if st.button('üß™ Test Model'):
				with st.spinner('Testing AI model...'):
					try:
						A.ai.sync_with_session_state();Q=A.ai.generate_response("Say 'Hello, this is a test response.'")
						if Q and Q.strip():st.success(f"‚úÖ Model working! Response: {Q}")
						else:st.warning('‚ö†Ô∏è Empty or invalid response from AI model.')
					except Exception as E:st.error(f"‚ùå Test failed: {str(E)}")
		else:st.error('AI system not configured. Check AI settings in the sidebar.')
def students_page():
	u='Not recorded';t='suspended';s='%.1f';r='Max';q='Score';st.header('üéì Student Management');R=st.session_state.school_manager;S=R.get_all_students()
	if not S:st.info('No students found. Add students through the Admissions tab.');return
	i=_F
	for O in S:
		if O.get(_Aj):
			try:
				v=datetime.strptime(O[_Aj],_M).date();J=calculate_age(v)
				if O.get(_Z)!=J:O[_Z]=J;R.update_student({_C:O[_C],_Z:J});i=_A
			except:pass
	if i:S=R.get_all_students()
	w,x=st.tabs(['üìä View Students','‚úèÔ∏è Edit Student Data']);C=pd.DataFrame(S);C[_As]=C.apply(lambda row:f"{row.get(_O,_i)} ({row.get(_A5,_i)})"if row.get(_O)and row.get(_A5)else _A2,axis=1)
	with w:
		H,I,T,y=st.columns(4)
		with H:U=st.selectbox('Filter by Grade',[_AH]+list(C[_H].unique()))
		with I:
			if U!=_AH:
				c=C[C[_H]==U];V=c[c[_O].notna()&(c[_O]!='')]
				if len(V)>0:
					K=[]
					for(z,P)in V.iterrows():
						E=P.get(_O,'');L=P.get(_A5,'')
						if E and L and L!='0':M=f"{E} ({L})"
						elif E:M=E
						else:continue
						if M not in K:K.append(M)
					d=[_AH]+K+[_A2]
				else:d=[_AH,_A2]
			else:
				V=C[C[_O].notna()&(C[_O]!='')];K=[]
				for(z,P)in V.iterrows():
					E=P.get(_O,'');L=P.get(_A5,'')
					if E and L and L!='0':M=f"{E} ({L})"
					elif E:M=E
					else:continue
					if M not in K:K.append(M)
				d=[_AH]+K+[_A2]
			N=st.selectbox('Filter by Stream',d)
		with T:j=st.slider(_Ch,_D,4.,_D)
		with y:k=st.text_input('Search by Name')
		B=C.copy()
		if U!=_AH:B=B[B[_H]==U]
		if N!=_AH:
			if N==_A2:B=B[B[_O].isna()|(B[_O]=='')]
			else:
				if'('in N and N.endswith(')'):l=N.split(' (')[0]
				else:l=N
				B=B[B[_O]==l]
		if j>0:B=B[B[_G]>=j]
		if k:B=B[B[_E].str.contains(k,case=_F)]
		st.dataframe(B[[_C,_E,_Z,_H,_As,_G,_K,_U]],use_container_width=_A)
		if not B.empty:
			A0=st.selectbox('Select Student for Details',B[_E].tolist());A=B[B[_E]==A0].iloc[0];H,I=st.columns(2)
			with H:st.subheader(f"üìã {A[_E]} Details");st.write(f"**Student ID:** {A[_C]}");st.write(f"**Grade:** {A[_H]}");st.write(f"**Age:** {A[_Z]}");st.write(f"**GPA:** {A[_G]}");st.write(f"**Attendance:** {A[_K]}%");st.write(f"**Behavior Score:** {A[_U]}");st.write(f"**Stream:** {A[_As]}");st.write(f"**Status:** {A.get(_I,'Active')}")
			with I:st.subheader('üìä Performance Chart');W={_BR:[_h,_AF,'Behavior'],q:[A[_G]*25,A[_K],A[_U]],r:[100,100,100]};X=go.Figure();X.add_trace(go.Bar(name=_Bx,x=W[_BR],y=W[q]));X.add_trace(go.Bar(name='Maximum',x=W[_BR],y=W[r],opacity=.3));X.update_layout(title='Student Performance Metrics',barmode='overlay');st.plotly_chart(X,use_container_width=_A)
	with x:
		st.subheader('‚úèÔ∏è Edit Student Information');H,I=st.columns([2,1])
		with H:m=st.selectbox('Select Student to Edit',C[_E].tolist(),key='edit_student_select')
		with I:st.metric(_s,len(C))
		if m:
			A=C[C[_E]==m].iloc[0]
			with st.form('edit_student_form'):
				st.markdown(f"### Editing: {A[_E]} (ID: {A[_C]})");H,I,T=st.columns(3)
				with H:
					st.markdown('**üìö Academic Information**');A1=st.number_input(_h,min_value=_D,max_value=4.,value=float(A[_G]),step=.1,format='%.2f');A2=st.selectbox(_A1,options=sorted(C[_H].unique()),index=list(sorted(C[_H].unique())).index(A[_H]));D=A.to_dict();A3=C[_As].unique();e=[A for A in A3 if A!=_A2];F=D.get(_O);Q=D.get(_A5)
					if F and Q:G=f"{F} ({Q})"
					elif F:G=F
					else:G=_A2
					if G!=_A2 and G not in e:e.append(G)
					Y=[_A2]+list(e);f=0
					if G in Y:f=Y.index(G)
					elif F:
						for(A4,A5)in enumerate(Y):
							if A5.startswith(F):f=A4;break
					Z=st.selectbox('Stream Assignment',options=Y,index=f)
				with I:st.markdown('**üìä Performance Metrics**');A6=st.number_input(_B1,min_value=_D,max_value=1e2,value=float(A[_K]),step=.1,format=s);A7=st.number_input(_BS,min_value=_D,max_value=1e2,value=float(A[_U]),step=.1,format=s);A8=st.selectbox('Student Status',options=[_n,_BT,t,_AK],index=[_n,_BT,t,_AK].index(A.get(_I,_n)))
				with T:
					st.markdown('**üë®\u200düë©\u200düëß\u200düë¶ Personal Information**');a=A.get(_Aj);n=A.get(_Z,10)
					if a:
						try:
							if isinstance(a,str):b=datetime.strptime(a,_M).date()
							else:b=a
						except(ValueError,TypeError):b=datetime.now().date()-timedelta(days=365*int(n))
					else:b=datetime.now().date()-timedelta(days=365*int(n))
					g=st.date_input('Date of Birth',value=b,min_value=datetime.now().date()-timedelta(days=365*25),max_value=datetime.now().date()-timedelta(days=365*3),help='Age will be automatically calculated from this date');J=calculate_age(g);A9=int(A[_Z])
					if J!=A9:st.write(f"**Updated age:** {J} years")
					else:st.write(f"**Age:** {J} years")
					AA=st.text_input(_C2,value=A.get(_AB,''),placeholder='Phone number or email');AB=st.text_area(_Bz,value=A.get(_A9,''),height=80,placeholder='Any relevant medical information...')
				H,I,T=st.columns([1,1,2])
				with H:AC=st.form_submit_button('Save Changes',type=_AW)
				with I:AD=st.form_submit_button('Reset Form')
				if AC:
					try:
						AE=calculate_age(g);h={_C:A[_C],_G:A1,_H:A2,_K:A6,_U:A7,_I:A8,_Aj:g.strftime(_M),_Z:AE,_AB:AA,_A9:AB}
						if Z!=_A2:E=Z.split(' (')[0]if' ('in Z else Z;h[_O]=E
						else:h[_O]=_B
						R.update_student(h);st.success(f"Successfully updated {A[_E]}'s information");time.sleep(1);st.rerun()
					except Exception as AF:st.error(f"Error updating student: {str(AF)}")
				if AD:st.rerun()
			st.markdown(_AP);st.subheader('üìã Current Student Summary');D=A.to_dict();AG,AH,AI,AJ=st.columns(4)
			with AG:st.metric('Current GPA',f"{D[_G]:.2f}");st.metric('Current Attendance',f"{D[_K]:.1f}%")
			with AH:st.metric('Current Behavior Score',f"{D[_U]:.1f}");st.metric(_Cl,D[_H])
			with AI:
				F=D.get(_O);Q=D.get(_A5)
				if F and Q:G=f"{F} ({Q})"
				elif F:G=F
				else:G=_A2
				st.metric('Current Stream',G);st.metric('Current Status',D.get(_I,_n).title())
			with AJ:o=D.get(_Z,_Ai);st.metric(_AS,f"{o} years"if o!=_Ai else _Ai);p=D.get(_r,u);st.metric(_C3,p if p else u)
def teachers_page():
	'Main teacher management page with basic CRUD operations';B6='Medium';B5='load_factor';B4='Assigned Teacher (Dept - Subject)';B3='üìä Generate Reports';B2='ü§ñ AI Teacher Assignment';B1='Avg Students/Teacher';B0='Average Performance';A_='Non-Class Teachers';Az='Class Teachers Only';Ay='\n                SELECT COUNT(DISTINCT g.student_id) as student_count\n                FROM courses c\n                LEFT JOIN grades g ON c.course_id = g.course_id\n                WHERE c.teacher_id = ?\n                ';Ax='Health & PE';AN='Class Teachers';AM='Languages';AL='Health Education';AK='Drama';AJ='Foreign Languages';AI='Psychology';AH='Economics';AG='Geography';AF='Literature';AE='Physics';AD='Chemistry';AC='Biology';AB='Computer Science';AA='Music';A9='Art';A8='History';u='General';t='Arts';s='STEM';r='English';g='recommendation_score';f='Unassigned';a='Not Assigned';W='Total Teachers';Q='‚úÖ';K='Assigned Stream';st.header('üë®\u200düè´ Teacher Management');C=DatabaseManager()
	try:
		B7="\n        SELECT \n            t.teacher_id,\n            t.name,\n            t.subject,\n            t.department,\n            t.performance_score,\n            t.status,\n            t.is_class_teacher,\n            CASE \n                WHEN t.is_class_teacher = 1 THEN \n                    COALESCE(s.grade_level || ' - ' || s.stream_type, 'Not Assigned')\n                ELSE \n                    'Not Class Teacher'\n            END as assigned_class\n        FROM teachers t\n        LEFT JOIN streams s ON t.teacher_id = s.class_teacher_id\n        WHERE t.status = 'active'\n        ORDER BY t.name\n        ";O=C.execute_query(B7)
		if not O:
			st.warning('No teacher data found in database. Please add teachers first.');st.subheader(_Cm)
			with st.form('add_teacher'):
				D,E=st.columns(2)
				with D:I=st.text_input(_AI,placeholder='T001');v=st.text_input(_P,placeholder='Dr. John Smith');X=st.selectbox(_m,[_B3,_Af,r,A8,A9,AA,_B4,AB,AC,AD,AE,AF,AG,AH,AI,AJ,AK,AL])
				with E:B8=st.selectbox(_Q,[s,AM,_BU,t,Ax,u]);B9=st.slider(_AV,_D,1e2,85.);BA=st.number_input(_C4,min_value=_D,value=5e4)
				BB=st.date_input(_C5);w=st.checkbox('Is Class Teacher?',value=_F)
				if st.form_submit_button('Add Teacher'):
					if I and v:
						try:BC="\n                            INSERT INTO teachers \n                            (teacher_id, name, subject, department, hire_date, performance_score, salary, status, is_class_teacher)\n                            VALUES (?, ?, ?, ?, ?, ?, ?, 'active', ?)\n                            ";C.execute_update(BC,(I,v,X,B8,BB.strftime(_M),B9,BA,w));st.success(f"Teacher {v} added successfully!");st.rerun()
						except Exception as F:st.error(f"Error adding teacher: {str(F)}")
					else:st.error('Please fill in Teacher ID and Name')
			return
		x={_AI:[A[0]for A in O],_P:[A[1]for A in O],_m:[A[2]for A in O],_Q:[A[3]for A in O],_N:[A[4]for A in O],_o:[A[5]for A in O],_A3:[Q if A[6]else'‚ùå'for A in O],K:[A[7]for A in O]};AO=[]
		for I in x[_AI]:
			BD='\n            SELECT is_class_teacher FROM teachers WHERE teacher_id = ?\n            ';AP=C.execute_query(BD,(I,));w=AP[0][0]if AP else _F
			if w:
				BE="\n                SELECT COUNT(DISTINCT st.student_id) as student_count\n                FROM streams s\n                JOIN students st ON s.stream_id = st.stream_id\n                WHERE s.class_teacher_id = ? AND st.status = 'active'\n                ";L=C.execute_query(BE,(I,));h=L[0][0]if L and L[0][0]else 0;y=Ay;L=C.execute_query(y,(I,));i=L[0][0]if L and L[0][0]else 0;j=max(h,i)
				if h>0 and i>0 and i>h:j=i
				else:j=h
			else:y=Ay;L=C.execute_query(y,(I,));j=L[0][0]if L and L[0][0]else 0
			AO.append(j)
		x[_J]=AO;A=pd.DataFrame(x)
	except Exception as F:st.error(f"Error fetching teacher data: {str(F)}");return
	BF,BG,BH=st.tabs(['üë®\u200düè´ Basic Management','üöÄ Advanced Features','‚öôÔ∏è Teacher Updates'])
	with BF:
		D,E=st.columns([2,1])
		with D:
			st.subheader('üìä Teacher Overview');b=st.text_input('üîç Search Teachers',placeholder='Search by name, subject, department, or stream...');BI,BJ=st.columns(2)
			with BI:AQ=st.selectbox('Filter by Department',[_AH]+sorted(A[_Q].unique().tolist()))
			with BJ:AR=st.selectbox('Filter by Class Teacher Status',[_AH,Az,A_])
			G=A.copy()
			if b:BK=A[_P].str.contains(b,case=_F,na=_F)|A[_m].str.contains(b,case=_F,na=_F)|A[_Q].str.contains(b,case=_F,na=_F)|A[K].str.contains(b,case=_F,na=_F);G=G[BK]
			if AQ!=_AH:G=G[G[_Q]==AQ]
			if AR==Az:G=G[G[_A3]==Q]
			elif AR==A_:G=G[G[_A3]=='‚ùå']
			BL=[_AI,_P,_m,_Q,_N,_o,_A3,K,_J];G=G[BL];st.dataframe(G,use_container_width=_A)
			if st.button('üì• Export Teacher Data'):T=G.to_csv(index=_F);st.download_button(label='Download CSV',data=T,file_name='teachers_data.csv',mime=_Ar)
		with E:
			st.subheader('üéØ Performance Distribution')
			if len(A)>0:AS=px.histogram(A,x=_N,nbins=min(15,len(A)),title='Teacher Performance Distribution',color_discrete_sequence=['#636EFA']);AS.update_layout(bargap=.1);st.plotly_chart(AS,use_container_width=_A)
			else:st.info('No data to display')
			st.subheader('üìä Department Overview')
			if len(A)>0:AT=A[_Q].value_counts();BM=px.pie(values=AT.values,names=AT.index,title='Teachers by Department');st.plotly_chart(BM,use_container_width=_A);st.metric(W,len(A));st.metric(B0,f"{A[_N].mean():.1f}%"if len(A)>0 else _i);st.metric(_s,f"{A[_J].sum():,}");st.metric(B1,f"{A[_J].mean():.0f}"if len(A)>0 else _i)
			else:st.info('No teacher data available for metrics.')
	with BG:
		st.subheader('üöÄ Advanced Teacher Management Features');BN,BO,BP=st.tabs(['üè´ Stream Assignment',B2,B3])
		with BN:
			st.subheader('üè´ Stream Assignment Management');D,E=st.columns(2)
			with D:
				st.write('**Assign Teacher to Stream**')
				if len(A)>0:
					k=A[A[_A3]==Q].copy()
					if not k.empty:
						z={}
						for(l,B)in k.iterrows():BQ=f"{B[_P]} ({B[_Q]} - {B[_m]})";z[BQ]=B[_P]
						BR=st.selectbox('Select Class Teacher',list(z.keys()),key='assign_teacher',help='Format: Teacher Name (Department - Subject)');A0=z[BR];J=k[k[_P]==A0].iloc[0];st.info(f"""
                        **Selected Teacher Details:**
                        - **Name:** {J[_P]}
                        - **Department:** {J[_Q]}
                        - **Subject:** {J[_m]}
                        - **Performance:** {J[_N]:.1f}%
                        - **Current Students:** {J[_J]}
                        - **Current Assignment:** {J[K]}
                        """)
						try:
							BS="\n                            SELECT stream_id, grade_level, stream_type, max_capacity,\n                                   (SELECT COUNT(*) FROM students WHERE stream_id = s.stream_id AND status = 'active') as current_students\n                            FROM streams s\n                            WHERE class_teacher_id IS NULL OR class_teacher_id = ''\n                            ORDER BY grade_level, stream_type\n                            ";AU=C.execute_query(BS)
							if AU:
								A1={}
								for A2 in AU:m,U,M,c,R=A2;R=R or 0;BT=f"{U} - {M} (Capacity: {c}, Current: {R})";A1[BT]=m
								AV=st.selectbox('Select Stream',list(A1.keys()),key='assign_stream',help='Format: Grade - Stream Type (Capacity info)');AW=A1[AV];AX=AV.split(' (');AY=AX[0];BU=AX[1].rstrip(')');st.info(f"""
                                **Selected Stream Details:**
                                - **Stream:** {AY}
                                - **Stream ID:** {AW}
                                - **{BU}**
                                """)
								if J[_Q]in[s,u]or _Af in J[_m]or'Math'in J[_m]:st.success("‚úÖ Teacher's background is suitable for this stream assignment")
								else:st.warning("‚ö†Ô∏è Consider if teacher's department aligns with stream requirements")
								if st.button('Assign Stream',key='assign_btn'):
									I=A[A[_P]==A0][_AI].iloc[0]
									try:A3=_CH;C.execute_update(A3,(I,AW));st.success(f"‚úÖ Successfully assigned {A0} ({J[_Q]}) to {AY}");st.rerun()
									except Exception as F:st.error(f"Error assigning stream: {str(F)}")
							else:st.info('No unassigned streams available')
						except Exception as F:st.error(f"Error fetching streams: {str(F)}")
					else:st.info('No class teachers available')
			with E:
				st.write('**Stream Assignment Summary**')
				if len(A)>0:
					N=A[A[_A3]==Q];BV=len(N[N[K]!=a]);V=len(N[N[K]==a]);st.metric(AN,len(N));st.metric('Assigned',BV);st.metric(f,V)
					if V>0:
						st.warning(f"{V} class teachers need stream assignment");st.write('**Unassigned Class Teachers:**');BW=N[N[K]==a]
						for(l,B)in BW.iterrows():st.write(f"‚Ä¢ **{B[_P]}** - {B[_Q]} ({B[_m]})")
					st.write('**Class Teachers by Department:**');BX=N[_Q].value_counts()
					for(d,BY)in BX.items():BZ=len(N[(N[_Q]==d)&(N[K]!=a)]);st.write(f"‚Ä¢ **{d}:** {BY} total ({BZ} assigned)")
			st.subheader('üìã Stream Assignment Overview')
			try:
				Ba="\n                SELECT \n                    s.stream_id,\n                    s.grade_level,\n                    s.stream_type,\n                    s.max_capacity,\n                    (SELECT COUNT(*) FROM students WHERE stream_id = s.stream_id AND status = 'active') as current_students,\n                    COALESCE(t.name, 'Unassigned') as teacher_name,\n                    COALESCE(t.teacher_id, '') as teacher_id,\n                    COALESCE(t.department, 'N/A') as teacher_department,\n                    COALESCE(t.subject, 'N/A') as teacher_subject,\n                    COALESCE(t.performance_score, 0) as teacher_performance\n                FROM streams s\n                LEFT JOIN teachers t ON s.class_teacher_id = t.teacher_id\n                ORDER BY s.grade_level, s.stream_type\n                ";Y=C.execute_query(Ba)
				if Y:
					AZ=[]
					for A2 in Y:
						m,U,M,c,R,Aa,I,Bb,Bc,Bd=A2;R=R or 0
						if Aa!=f:J=f"{Aa} ({Bb} - {Bc})";Ab=f"{Bd:.1f}%"
						else:J=f;Ab=_i
						Be=R/c*100 if c>0 else 0;AZ.append([m,f"{U} - {M}",f"{R}/{c} ({Be:.1f}%)",J,I,Ab])
					Ac=pd.DataFrame(AZ,columns=[_Ad,_Aq,'Enrollment (Utilization)',B4,_AI,_AV])
					def Bf(row):
						A=row
						if f in str(A[B4]):return['background-color: #ffcccc']*len(A)
						else:return['background-color: #ccffcc']*len(A)
					Bg=Ac.style.apply(Bf,axis=1);st.dataframe(Bg,use_container_width=_A);D,E,A4,Bh=st.columns(4)
					with D:Ad=len(Y);st.metric(_C6,Ad)
					with E:Ae=len([A for A in Y if A[5]!=f]);st.metric('Assigned Streams',Ae)
					with A4:n=Ad-Ae;st.metric('Unassigned Streams',n)
					with Bh:Af=sum([A[3]for A in Y if A[3]]);Bi=sum([A[4]or 0 for A in Y]);Bj=Bi/Af*100 if Af>0 else 0;st.metric(_Cn,f"{Bj:.1f}%")
					if st.button('üì• Export Stream Assignments',key='export_streams'):T=Ac.to_csv(index=_F);st.download_button(label='Download Stream Assignments CSV',data=T,file_name=f"stream_assignments_{pd.Timestamp.now().strftime(_A7)}.csv",mime=_Ar,key='download_streams')
				else:st.info('No streams found in the database')
			except Exception as F:st.error(f"Error fetching stream assignments: {str(F)}")
			st.subheader('üîç Assignment Insights');D,E=st.columns(2)
			with D:
				st.write('**Department-Stream Compatibility**')
				if len(A)>0:
					Bk={s:'Excellent for Science, Math-focused streams',AM:'Ideal for Language Arts, Literature streams',_BU:'Perfect for History, Geography streams',t:'Great for Creative, Arts-focused streams',Ax:'Suitable for Physical Education programs',u:'Flexible for various stream types'}
					for(d,Bl)in Bk.items():
						Ag=len(A[(A[_Q]==d)&(A[_A3]==Q)])
						if Ag>0:st.write(f"**{d}** ({Ag} class teachers): {Bl}")
			with E:
				st.write('**Assignment Recommendations**')
				try:
					Bm="\n                    SELECT stream_id, grade_level, stream_type \n                    FROM streams \n                    WHERE class_teacher_id IS NULL OR class_teacher_id = ''\n                    LIMIT 3\n                    ";n=C.execute_query(Bm)
					if n:
						st.write('**Suggested Assignments:**')
						for Bn in n:
							m,U,M=Bn
							if _Af in M or'Math'in M:o=s
							elif'Language'in M or r in M:o=AM
							elif t in M:o=t
							else:o=u
							A5=A[(A[_Q]==o)&(A[_A3]==Q)&(A[K]==a)]
							if not A5.empty:H=A5.loc[A5[_N].idxmax()];st.write(f"**{U} - {M}**");st.write(f"‚Üí Suggested: {H[_P]} ({H[_Q]}, {H[_N]:.1f}%)")
							else:st.write(f"**{U} - {M}**: No suitable teachers available")
					else:st.success('‚úÖ All streams have been assigned!')
				except Exception as F:st.error(f"Error generating recommendations: {str(F)}")
				with BO:
					st.subheader(B2);D,E=st.columns(2)
					with D:
						st.write('**AI Recommendation Engine**')
						try:
							Bo="SELECT DISTINCT subject FROM teachers WHERE status = 'active' AND subject IS NOT NULL AND subject != ''";Ah=C.execute_query(Bo);Bp=[A[0]for A in Ah]if Ah else[];Bq="SELECT DISTINCT name FROM courses WHERE name IS NOT NULL AND name != ''";Ai=C.execute_query(Bq);Br=[A[0]for A in Ai]if Ai else[];Z=list(set(Bp+Br))
							if not Z:Z=[_B3,_Af,r,A8,A9,AA,_B4,AB,AC,AD,AE,AF,AG,AH,AI,AJ,AK,AL]
							st.info(f"üìö Found {len(Z)} subjects: {_j.join(sorted(Z)[:5])}{'...'if len(Z)>5 else''}");X=st.selectbox(_m,sorted(Z),key='ai_subject');U=st.selectbox(_A1,[_a,'Lower Primary','Upper Primary','Junior High School'],key='ai_grade');A6=st.number_input('Expected Class Size',min_value=1,max_value=50,value=35,key='ai_class_size')
							if st.button('üéØ AI Recommend Teacher',key='ai_recommend'):
								try:
									Bs="\n                                    SELECT DISTINCT t.teacher_id, t.name, t.subject, t.department, t.performance_score, \n                                           t.is_class_teacher,\n                                           COALESCE(student_counts.student_count, 0) as current_students,\n                                           CASE \n                                               WHEN t.is_class_teacher = 1 THEN \n                                                   COALESCE(s.grade_level || ' - ' || s.stream_type, 'Not Assigned')\n                                               ELSE \n                                                   'Not Class Teacher'\n                                           END as assigned_class\n                                    FROM teachers t\n                                    LEFT JOIN streams s ON t.teacher_id = s.class_teacher_id\n                                    LEFT JOIN (\n                                        SELECT c.teacher_id, COUNT(DISTINCT g.student_id) as student_count\n                                        FROM courses c\n                                        LEFT JOIN grades g ON c.course_id = g.course_id\n                                        WHERE c.teacher_id IS NOT NULL AND c.teacher_id != ''\n                                        GROUP BY c.teacher_id\n                                    ) student_counts ON t.teacher_id = student_counts.teacher_id\n                                    WHERE t.status = 'active' \n                                    AND (LOWER(t.subject) = LOWER(?) OR EXISTS (\n                                        SELECT 1 FROM courses c WHERE c.teacher_id = t.teacher_id AND LOWER(c.name) = LOWER(?)\n                                    ))\n                                    ORDER BY t.performance_score DESC, t.name ASC\n                                    ";Aj=C.execute_query(Bs,(X,X))
									if Aj:
										P=pd.DataFrame(Aj,columns=[_AI,_P,_m,_Q,_N,_C7,_J,K]);P[B5]=1-P[_J]/200;P[g]=P[_N]*.7+P[B5]*100*.3;H=P.loc[P[g].idxmax()];p=int(H[_J])
										if p+A6<=200:st.success(f"**Recommended Teacher: {H[_P]}**");st.write(f"- Teacher ID: {H[_AI]}");st.write(f"- Subject: {H[_m]}");st.write(f"- Performance Score: {H[_N]:.1f}%");st.write(f"- Current Students: {p}");st.write(f"- Department: {H[_Q]}");st.write(f"- Class Teacher: {'Yes'if H[_C7]else'No'}");st.write(f"- Assigned Stream: {H[K]}");st.write(f"- Recommendation Score: {H[g]:.1f}");st.info('**Recommendation Reasoning:**');st.write(f"- High performance score ({H[_N]:.1f}%)");st.write(f"- Manageable current workload ({p} students)");st.write(f"- Can accommodate {A6} additional students")
										else:
											st.warning(f"{H[_P]} is overloaded ({p} students). Consider redistributing classes.");Ak=P[P[_J]+A6<=200].sort_values(g,ascending=_F)
											if not Ak.empty:
												st.info('**Alternative recommendations:**')
												for(C3,B)in Ak.head(3).iterrows():st.write(f"‚Ä¢ **{B[_P]}** (Score: {B[g]:.1f}, Students: {int(B[_J])}, Stream: {B[K]})")
											else:st.error('No teachers available with sufficient capacity.')
									else:
										st.warning(f"No teachers found for **{X}**. Consider:");st.write('- üÜï Hiring a new teacher');st.write('- üìö Cross-training existing teachers');st.write('- üîÑ Reassigning from other subjects');Bt="\n                                        SELECT t.name, t.subject, t.performance_score, \n                                               COALESCE(student_counts.student_count, 0) as current_students\n                                        FROM teachers t\n                                        LEFT JOIN (\n                                            SELECT c.teacher_id, COUNT(DISTINCT g.student_id) as student_count\n                                            FROM courses c\n                                            LEFT JOIN grades g ON c.course_id = g.course_id\n                                            WHERE c.teacher_id IS NOT NULL AND c.teacher_id != ''\n                                            GROUP BY c.teacher_id\n                                        ) student_counts ON t.teacher_id = student_counts.teacher_id\n                                        WHERE t.status = 'active'\n                                        ORDER BY t.performance_score DESC\n                                        LIMIT 5\n                                        ";Al=C.execute_query(Bt)
										if Al:
											st.info('**Top performing teachers (other subjects):**')
											for B in Al:st.write(f"‚Ä¢ {B[0]} - {B[1]} (Performance: {B[2]:.1f}%, Students: {B[3]})")
								except Exception as F:st.error('Error generating recommendation. Please try again.')
						except Exception as F:st.error('Error loading subjects. Using default subject list.');X=st.selectbox(_m,[_B3,_Af,r,A8,A9,AA,_B4,AB,AC,AD,AE,AF,AG,AH,AI,AJ,AK,AL],key='ai_subject_fallback')
					with E:
						st.write('**Teacher Workload Analysis**')
						if len(A)>0:
							Am=px.bar(A,x=_P,y=_J,title='Teacher Workload (Students per Teacher)',color=_N,color_continuous_scale=_Bv);Am.update_xaxes(tickangle=45);st.plotly_chart(Am,use_container_width=_A);st.write('**Workload Statistics:**');st.write(f"- Average students per teacher: {A[_J].mean():.1f}");st.write(f"- Max students (single teacher): {A[_J].max()}");st.write(f"- Min students (single teacher): {A[_J].min()}");An=A[A[_J]>150]
							if len(An)>0:
								st.warning('‚ö†Ô∏è **Overloaded Teachers:**')
								for(l,B)in An.iterrows():st.write(f"‚Ä¢ {B[_P]}: {B[_J]} students")
							else:st.success('‚úÖ No teachers are currently overloaded')
						else:st.info('üìä Add teachers to view workload analysis')
						st.write('**üìà System Insights**')
						try:
							Bu=_BF;Ao=C.execute_query(Bu);Bv=Ao[0][0]if Ao else 0;Bw="SELECT COUNT(*) FROM courses WHERE teacher_id IS NULL OR teacher_id = ''";Ap=C.execute_query(Bw);V=Ap[0][0]if Ap else 0;Bx,By=st.columns(2)
							with Bx:st.metric('üìö Total Courses',Bv)
							with By:st.metric('‚ùì Unassigned Courses',V)
							if V>0:st.warning(f"There are {V} courses without assigned teachers.")
						except Exception as F:st.error('Error fetching course insights.')
				with BP:
					st.subheader(B3);D,E,A4=st.columns(3)
					with D:
						st.write('**Performance Reports**')
						if st.button('üìà Performance Analysis',key='perf_analysis'):
							if len(A)>0:
								Aq=A[A[_N]>=90];Ar=A[(A[_N]>=70)&(A[_N]<90)];q=A[A[_N]<70];st.write('**üìà Performance Analysis Report**');st.write(f"- **High Performers (‚â•90%):** {len(Aq)} teachers ({len(Aq)/len(A)*100:.1f}%)");st.write(f"- **Medium Performers (70-89%):** {len(Ar)} teachers ({len(Ar)/len(A)*100:.1f}%)");st.write(f"- **Low Performers (<70%):** {len(q)} teachers ({len(q)/len(A)*100:.1f}%)");st.write(f"- **Average Performance:** {A[_N].mean():.1f}%");st.write(f"- **Performance Standard Deviation:** {A[_N].std():.1f}")
								if len(q)>0:
									st.warning('**Teachers needing improvement:**')
									for(l,B)in q.iterrows():st.write(f"‚Ä¢ {B[_P]} ({B[_N]:.1f}%) - {B[_m]}")
								Bz=A.groupby(_Q)[_N].agg([_B5,_AL]).round(1);st.write('**Performance by Department:**');st.dataframe(Bz)
					with E:
						st.write('**Workload Reports**')
						if st.button('üë• Workload Analysis',key='workload_analysis'):
							if len(A)>0:
								st.write('**üë• Teacher Workload Report**');st.write(f"- **Total Students:** {A[_J].sum():,}");st.write(f"- **Average Students per Teacher:** {A[_J].mean():.1f}");st.write(f"- **Student Distribution Range:** {A[_J].min()} - {A[_J].max()}");B_=A[A[_J]<50];C0=A[(A[_J]>=50)&(A[_J]<100)];A7=A[A[_J]>=100];st.write(f"- **Light Load (<50 students):** {len(B_)} teachers");st.write(f"- **Medium Load (50-99 students):** {len(C0)} teachers");st.write(f"- **Heavy Load (‚â•100 students):** {len(A7)} teachers")
								if len(A7)>0:
									st.warning('**Teachers with heavy workload:**')
									for(l,B)in A7.iterrows():st.write(f"‚Ä¢ {B[_P]}: {B[_J]} students ({B[_m]})")
					with A4:
						st.write('**Department Reports**')
						if st.button('üè¢ Department Summary',key='dept_summary'):
							if len(A)>0:st.write('**üè¢ Department Summary Report**');S=A.groupby(_Q).agg({_P:_AL,_N:[_B5,'std'],_J:['sum',_B5],_A3:lambda x:(x==Q).sum()}).round(1);S.columns=[W,_BV,'Performance StdDev',_s,B1,AN];st.dataframe(S);As=S[W].idxmax();At=S[W].idxmin();st.write(f"- **Largest Department:** {As} ({S.loc[As,W]} teachers)");st.write(f"- **Smallest Department:** {At} ({S.loc[At,W]} teachers)");Au=S[_BV].idxmax();st.write(f"- **Best Performing Department:** {Au} ({S.loc[Au,_BV]:.1f}% avg)")
					st.write(_AP);st.write('**üìã Export Comprehensive Reports**');D,E=st.columns(2)
					with D:
						if st.button('üìä Export All Teacher Data',key='export_all'):e=A.copy();e['Performance Category']=pd.cut(e[_N],bins=[0,70,90,100],labels=['Low',B6,'High']);e['Workload Category']=pd.cut(e[_J],bins=[0,50,100,float('inf')],labels=['Light',B6,'Heavy']);T=e.to_csv(index=_F);st.download_button(label='Download Comprehensive Teacher Report',data=T,file_name=f"teacher_comprehensive_report_{pd.Timestamp.now().strftime(_A7)}.csv",mime=_Ar,key='download_comprehensive')
					with E:
						if st.button('üìà Export Performance Summary',key='export_perf'):C1={_BR:[W,B0,'High Performers (‚â•90%)','Medium Performers (70-89%)','Low Performers (<70%)',_s,'Average Students per Teacher',AN,'Assigned Class Teachers'],'Value':[len(A),f"{A[_N].mean():.1f}%",len(A[A[_N]>=90]),len(A[(A[_N]>=70)&(A[_N]<90)]),len(A[A[_N]<70]),A[_J].sum(),f"{A[_J].mean():.1f}",len(A[A[_A3]==Q]),len(A[(A[_A3]==Q)&(A[K]!=a)])]};C2=pd.DataFrame(C1);T=C2.to_csv(index=_F);st.download_button(label='Download Performance Summary',data=T,file_name=f"teacher_performance_summary_{pd.Timestamp.now().strftime(_A7)}.csv",mime=_Ar,key='download_summary')
			with BH:
				st.subheader('‚öôÔ∏è Teacher Management');D,E=st.columns(2)
				with D:
					st.write('**Update Teacher Performance**')
					if len(A)>0:
						Av=st.selectbox('Select Teacher',A[_P].tolist(),key='update_teacher');Aw=st.slider('New Performance Score',_D,1e2,85.,key='update_performance')
						if st.button('Update Performance'):
							I=A[A[_P]==Av][_AI].iloc[0]
							try:A3='UPDATE teachers SET performance_score = ? WHERE teacher_id = ?';C.execute_update(A3,(Aw,I));st.success(f"Updated {Av}'s performance to {Aw}%");st.rerun()
							except Exception as F:st.error('Error updating performance. Please try again.')
				with E:
					st.write('**Add New Teacher**')
					if st.button(_Co):st.session_state.show_add_form=_A
def academics_page():
	BV='Academic Year';BU='Reason';BT='Eligible for Promotion';BS='No GPA distribution data available';BR='No active students found';BQ='No courses available';BP='No students available';BO='Remark';BN='GPA Points';BM='No Teacher (Optional for Primary)';At='Promoted';As='To Grade';Ar='From Grade';Aq='‚ùå NOT MET';Ap='‚úÖ MET';Ao='Promotion Rate %';An='background-color: #d1ecf1; color: #0c5460';Am='Grade (%)';Al='Very Good';AV='Retained';AU='Select a student...';AT='background-color: #f8d7da; color: #721c24';AS='background-color: #d4edda; color: #155724';AR='Fail';AQ='F9';AP='E8';AO='D7';AN='C6';AM='C5';AL='C4';AK='B3';AJ='B2';AI='A1';A3='Action';e='Pass';O='Credit';st.header('üìö Academic Management');A=DatabaseManager();U=GPACalculator(A)
	def Au(student_id,student_name,from_grade,to_grade,action,gpa,attendance_rate,behavior_score,reason,academic_year=_B):
		'Log promotion activity to history table';C=student_id;B=academic_year
		if B is _B:from datetime import datetime as D;E=D.now().year;B=f"{E}-{str(E+1)[2:]}"
		try:A.execute_update('\n                DELETE FROM promotion_history \n                WHERE student_id = ? AND academic_year = ?\n            ',(C,B));A.execute_update('\n                INSERT INTO promotion_history \n                (academic_year, student_id, student_name, from_grade, to_grade, action, \n                 promotion_date, gpa, attendance_rate, behavior_score, reason)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n            ',(B,C,student_name,from_grade,to_grade,action,D.now().strftime(_M),gpa,attendance_rate,behavior_score,reason))
		except Exception as F:st.error(f"Error logging promotion activity: {F}")
	BW,BX,BY,BZ=st.tabs(['üìñ Courses','üìù Grades','üìÖ Schedule','ü§ñ Promotion'])
	with BW:
		st.subheader('Course Catalog')
		with st.expander(_Cp):
			with st.form('add_course_form'):
				G,H=st.columns(2)
				with G:f=st.text_input(_C8);V=st.text_input(_BW);Av=st.selectbox(_A1,[_R,_S,_T,_V,_W,_X,_b,_c,_d])
				with H:
					AW=Av in[_R,_S,_T,_V,_W,_X]
					if AW:AX=_Ag;n=A.execute_query(AX);AY=[BM]+[A for(B,A)in n];AZ={B:A for(A,B)in n};W=st.selectbox('Teacher (Optional for Primary Grades)',AY);A4=AZ.get(W,_B)
					else:AX=_Ag;n=A.execute_query(AX);AY=[_BX]+[A for(B,A)in n];AZ={B:A for(A,B)in n};W=st.selectbox('Teacher (Required for JHS)',AY);A4=AZ.get(W,_B)
					credits=st.number_input(_C9,min_value=1,max_value=6,value=3);Ba=st.text_input('Schedule (e.g., MWF 9:00-10:00)')
				if st.form_submit_button('Add Course'):
					if not f or not V:st.error('Course ID and Course Name are required')
					elif not AW and(not W or W==_BX):st.error('Teacher is required for JHS courses')
					else:
						if AW and W==BM:A4=_B
						Bb=_Cq
						try:A.execute_update(Bb,(f,V,A4,Av,credits,Ba));Bc=W if A4 else'No Teacher Assigned';st.success(f"Course '{V}' added successfully! Teacher: {Bc}");st.rerun()
						except Exception as C:st.error(f"Error adding course: {str(C)}")
		o="\n            SELECT c.course_id, c.name, COALESCE(t.name, 'No Teacher Assigned') as teacher_name, \n                   c.grade_level, c.credits, c.schedule,\n                   COUNT(g.student_id) as enrolled_count\n            FROM courses c\n            LEFT JOIN teachers t ON c.teacher_id = t.teacher_id\n            LEFT JOIN grades g ON c.course_id = g.course_id\n            GROUP BY c.course_id, c.name, t.name, c.grade_level, c.credits, c.schedule\n            ORDER BY c.name\n        ";X=A.execute_query(o)
		if X:Bd=pd.DataFrame(X,columns=[_C8,_BW,_B6,_A1,_C9,_B7,'Enrolled Students']);st.dataframe(Bd,use_container_width=_A,hide_index=_A)
		else:st.info('No courses found. Add some courses to get started!')
	with BX:
		st.subheader('Grade Management');Be,Bf=st.tabs(['üìù Grade Entry','üìä GPA Management'])
		with st.expander('üìä GPA Scale Reference',expanded=_F):Bg=[[AI,'75-100','4.0',_A_],[AJ,'70-74','3.5',Al],[AK,'65-69','3.0',_Ap],[AL,'60-64','2.5',O],[AM,'55-59','2.0',O],[AN,'50-54','1.5',O],[AO,'45-49','1.0',e],[AP,'40-44','0.5',e],[AQ,'0-39','0.0',AR]];Bh=pd.DataFrame(Bg,columns=[_f,'Percentage Range',BN,BO]);st.dataframe(Bh,use_container_width=_A,hide_index=_A)
		with Be:
			G,H=st.columns(2)
			with G:
				st.write('**Grade Entry**')
				with st.form('add_grade_form'):
					Y=_BE;M=A.execute_query(Y);P={f"{B} ({A})":A for(A,B)in M};o=_BY;X=A.execute_query(o);g={f"{B} ({A})":A for(A,B)in X};p=st.selectbox('Select Student',list(P.keys())if P else[BP]);A5=st.selectbox('Select Course',list(g.keys())if g else[BQ]);Aa=st.number_input(Am,min_value=_D,max_value=1e2,step=.1);A6=st.selectbox(_B8,['Advent','Lent','Trinity']);A7=st.number_input('Year',min_value=2025,max_value=2095,value=2025)
					def Ab(percentage):
						A=percentage
						if A>=75:return 4.,AI,_A_
						elif A>=70:return 3.5,AJ,Al
						elif A>=65:return 3.,AK,_Ap
						elif A>=60:return 2.5,AL,O
						elif A>=55:return 2.,AM,O
						elif A>=50:return 1.5,AN,O
						elif A>=45:return 1.,AO,e
						elif A>=40:return .5,AP,e
						else:return _D,AQ,AR
					if Aa>0:A8,F,A9=Ab(Aa);st.info(f"**GPA Equivalent:** {A8} ({F} - {A9})")
					if st.form_submit_button('Add Grade'):
						if p!=BP and A5!=BQ:
							import uuid;Bi=str(uuid.uuid4());D=P[p];f=g[A5];Bj=_Cr
							try:
								A.execute_update(Bj,(Bi,D,f,Aa,A6,A7));st.success('Grade added successfully!')
								try:Ac=U.update_student_gpa(D);st.info(f"Student GPA updated to: {Ac:.2f}")
								except Exception as C:st.warning(f"Grade added but GPA update failed: {C}")
								st.rerun()
							except Exception as C:st.error(f"Error adding grade: {str(C)}")
			with H:
				st.write('**Grade Distribution**');Bk="\n                    SELECT \n                        CASE \n                            WHEN grade >= 75 THEN 'A1 (75-100)'\n                            WHEN grade >= 70 THEN 'B2 (70-74)'\n                            WHEN grade >= 65 THEN 'B3 (65-69)'\n                            WHEN grade >= 60 THEN 'C4 (60-64)'\n                            WHEN grade >= 55 THEN 'C5 (55-59)'\n                            WHEN grade >= 50 THEN 'C6 (50-54)'\n                            WHEN grade >= 45 THEN 'D7 (45-49)'\n                            WHEN grade >= 40 THEN 'E8 (40-44)'\n                            ELSE 'F9 (0-39)'\n                        END as letter_grade,\n                        COUNT(*) as count\n                    FROM grades\n                    GROUP BY letter_grade\n                    ORDER BY \n                        CASE \n                            WHEN grade >= 75 THEN 1\n                            WHEN grade >= 70 THEN 2\n                            WHEN grade >= 65 THEN 3\n                            WHEN grade >= 60 THEN 4\n                            WHEN grade >= 55 THEN 5\n                            WHEN grade >= 50 THEN 6\n                            WHEN grade >= 45 THEN 7\n                            WHEN grade >= 40 THEN 8\n                            ELSE 9\n                        END\n                ";Aw=A.execute_query(Bk)
				if Aw:
					import plotly.express as q;Bl=pd.DataFrame(Aw,columns=[_f,_e]);r=q.bar(Bl,x=_f,y=_e,title='Grade Distribution');r.update_xaxes(tickangle=45);st.plotly_chart(r,use_container_width=_A);Bm='SELECT AVG(grade) as avg_grade FROM grades';Ad=A.execute_query(Bm)
					if Ad and Ad[0][0]:
						Ax=Ad[0][0];Ae,Bn,Bo=Ab(Ax);Af,Ag=st.columns(2)
						with Af:st.metric('Average Grade',f"{Ax:.1f}%")
						with Ag:st.metric(_AM,f"{Ae:.2f}")
						st.info(f"Class Average: {Bn} - {Bo}")
				else:st.info('No grades data available for chart')
			st.markdown(_AP);st.subheader('Recent Grades');Bp='\n                SELECT s.name as student_name, c.name as course_name, \n                       g.grade, g.semester, g.year\n                FROM grades g\n                JOIN students s ON g.student_id = s.student_id\n                JOIN courses c ON g.course_id = c.course_id\n                ORDER BY g.year DESC, g.semester DESC\n                LIMIT 10\n            ';Ay=A.execute_query(Bp)
			if Ay:
				Az=[]
				for(Q,V,I,A6,A7)in Ay:A8,F,A9=Ab(I);Az.append([Q,V,f"{I:.1f}%",F,f"{A8:.1f}",A9,A6,A7])
				Bq=pd.DataFrame(Az,columns=[_AG,_BZ,Am,'Letter Grade',BN,BO,_B8,'Year'])
				def Br(row):
					A=row;B=float(A[Am].replace('%',''))
					if B>=75:return[AS]*len(A)
					elif B>=65:return[An]*len(A)
					elif B>=50:return['background-color: #fff3cd; color: #856404']*len(A)
					elif B>=40:return[AT]*len(A)
					else:return['background-color: #f5c6cb; color: #721c24']*len(A)
				Bs=Bq.style.apply(Br,axis=1);st.dataframe(Bs,use_container_width=_A);st.markdown('\n                **Grade Legend:**\n                - üü¢ **A1 (75-100%)**: 4.0 GPA - Excellent\n                - üîµ **B2/B3 (65-74%)**: 3.5-3.0 GPA - Very Good/Good  \n                - üü° **C4/C5/C6 (50-64%)**: 2.5-1.5 GPA - Credit\n                - üî¥ **D7/E8 (40-49%)**: 1.0-0.5 GPA - Pass\n                - ‚ö´ **F9 (0-39%)**: 0.0 GPA - Fail\n                ')
			else:st.info('No recent grades found')
		with Bf:
			st.markdown('### üìä GPA Management Center');st.markdown('#### üîÑ GPA Updates');G,H=st.columns(2)
			with G:
				st.markdown('**Bulk GPA Operations**')
				if st.button('üîÑ Update All Student GPAs',type=_AW):
					with st.spinner('Calculating GPAs for all students...'):
						try:
							s=U.bulk_update_all_gpas();st.success(f"Updated GPAs for {len(s)} students!")
							if s:
								Ae=sum(s.values())/len(s);st.info(f"Average GPA: {Ae:.2f}");A_=sorted(s.items(),key=lambda x:x[1],reverse=_A)
								if len(A_)>=3:
									st.markdown('**Top Performers:**')
									for(h,(Q,B))in enumerate(A_[:3]):
										if B>=3.75:R=AI
										elif B>=3.25:R=AJ
										elif B>=2.75:R=AK
										elif B>=2.25:R=AL
										elif B>=1.75:R=AM
										elif B>=1.25:R=AN
										elif B>=.75:R=AO
										elif B>=.25:R=AP
										else:R=AQ
										st.write(f"{h+1}. {Q}: {B:.2f} ({R})")
								st.rerun()
							else:st.warning('No students found or no grades available')
						except Exception as C:st.error(f"Error updating GPAs: {str(C)}")
				st.markdown('**Individual Student GPA Update**');Y=_BE;M=A.execute_query(Y)
				if M:
					P={f"{B} ({A})":A for(A,B)in M};Ah=st.selectbox('Select Student for GPA Update',[AU]+list(P.keys()),key='gpa_update_student')
					if Ah!=AU:
						D=P[Ah];Q=Ah.split(' (')[0]
						if st.button(f"Update GPA for {Q}",key='update_individual_gpa'):
							try:Ac=U.update_student_gpa(D);st.success(f"GPA updated to {Ac:.2f}");st.rerun()
							except Exception as C:st.error(f"Error updating GPA: {str(C)}")
				else:st.info(BR)
			with H:
				st.markdown('**Class GPA Statistics**')
				try:
					i=U.get_class_gpa_statistics()
					if i[_AL]>0:
						Af,Ag=st.columns(2)
						with Af:st.metric(_AM,f"{i[_Ab]:.2f}");st.metric(_J,i[_AL])
						with Ag:st.metric('Highest GPA',f"{i[_Ay]:.2f}");st.metric('Lowest GPA',f"{i[_AA]:.2f}")
						B0=i[_Az]
						if any(B0.values()):
							t=pd.DataFrame(list(B0.items()),columns=[_BN,_e]);t=t[t[_e]>0]
							if not t.empty:Bt=q.pie(t,values=_e,names=_BN,title='GPA Distribution by Grade Range');st.plotly_chart(Bt,use_container_width=_A)
							else:st.info(BS)
						else:st.info(BS)
					else:st.info('No GPA data available. Add grades and update GPAs.')
				except Exception as C:st.error(f"Error loading GPA statistics: {str(C)}")
			st.markdown(_AP);st.markdown('### üë§ Individual Student GPA Analysis');Y=_BE;M=A.execute_query(Y)
			if M:
				P={f"{B} ({A})":A for(A,B)in M};Ai=st.selectbox('Select Student for Detailed Analysis',[AU]+list(P.keys()),key='gpa_analysis_student')
				if Ai!=AU:
					D=P[Ai];Q=Ai.split(' (')[0];G,H,Aj=st.columns(3)
					with G:
						st.markdown('**Current Performance**')
						try:
							Z=U.calculate_gpa(D);st.metric('Overall GPA',f"{Z:.2f}/4.0")
							if Z>=3.5:F='A';u='üü¢';v='Excellent/Very Good'
							elif Z>=2.5:F='B';u='üü°';v=_Ap
							elif Z>=1.5:F='C';u='üü†';v=O
							elif Z>=.5:F='D-E';u='üî¥';v=e
							else:F='F';u='‚ö´';v=AR
							st.write(f"{u} **Grade:** {F}");st.write(f"**Performance:** {v}");Bu=min(Z/4.,1.);st.progress(Bu)
						except Exception as C:st.error(f"Error calculating GPA: {str(C)}");Z=_D
					with H:
						st.markdown('**Semester Performance**')
						try:
							L=U.get_gpa_by_semester(D)
							if L:
								for S in L:
									a=S[_G]
									if len(L)>1:
										B1=L.index(S)
										if B1>0:
											B2=L[B1-1][_G]
											if a>B2:w='üìà'
											elif a<B2:w='üìâ'
											else:w='‚û°Ô∏è'
										else:w=''
									else:w=''
									if a>=3.5:x='A'
									elif a>=2.5:x='B'
									elif a>=1.5:x='C'
									elif a>=.5:x='D-E'
									else:x='F'
									st.write(f"{S[_A6]} {S[_A0]}: {a:.2f} ({x}) {w}")
							else:st.info('No semester data available')
						except Exception as C:st.error(f"Error loading semester data: {str(C)}")
					with Aj:
						st.markdown('**Recent Course Grades**')
						try:
							Bv='\n                                SELECT c.name as course_name, g.grade, g.semester, g.year\n                                FROM grades g\n                                JOIN courses c ON g.course_id = c.course_id\n                                WHERE g.student_id = ?\n                                ORDER BY g.year DESC, g.semester DESC, c.name\n                            ';AA=A.execute_query(Bv,(D,))
							if AA:
								for(V,I,A6,A7)in AA[:5]:
									def Bw(percentage):
										A=percentage
										if A>=75:return 4.,AI,_A_
										elif A>=70:return 3.5,AJ,Al
										elif A>=65:return 3.,AK,_Ap
										elif A>=60:return 2.5,AL,O
										elif A>=55:return 2.,AM,O
										elif A>=50:return 1.5,AN,O
										elif A>=45:return 1.,AO,e
										elif A>=40:return .5,AP,e
										else:return _D,AQ,AR
									A8,F,A9=Bw(I)
									if I>=75:y='üü¢'
									elif I>=65:y='üü°'
									elif I>=50:y='üü†'
									elif I>=40:y='üî¥'
									else:y='‚ö´'
									st.write(f"{y} **{V}**: {I:.1f}% ({F})")
								if len(AA)>5:st.write(f"... and {len(AA)-5} more grades")
							else:st.info('No grades available for this student')
						except Exception as C:st.error(f"Error loading course grades: {str(C)}")
					st.markdown(_AP);st.markdown('#### üìà GPA Trend Analysis')
					try:
						L=U.get_gpa_by_semester(D)
						if L and len(L)>1:
							B3=[]
							for S in L:Bx=f"{S[_A6]} {S[_A0]}";B3.append({_B8:Bx,_h:S[_G]})
							By=pd.DataFrame(B3);AB=q.line(By,x=_B8,y=_h,title=f"GPA Trend for {Q}",markers=_A);AB.update_yaxis(range=[0,4.]);AB.add_hline(y=2.,line_dash=_AD,line_color=_t,annotation_text='Minimum Pass GPA');AB.add_hline(y=3.,line_dash=_AD,line_color='green',annotation_text='Good Performance');st.plotly_chart(AB,use_container_width=_A)
							if len(L)>=2:
								AC=L[0][_G];AD=L[1][_G]
								if AC>AD:st.success(f"üìà **Improving Performance**: GPA increased by {AC-AD:.2f} points")
								elif AC<AD:st.warning(f"üìâ **Declining Performance**: GPA decreased by {AD-AC:.2f} points")
								else:st.info('‚û°Ô∏è **Stable Performance**: GPA remained consistent')
						else:st.info('Need at least 2 semesters of data to show trend analysis')
					except Exception as C:st.error(f"Error creating trend analysis: {str(C)}")
			else:st.info(BR)
			st.markdown(_AP);st.markdown('### üèÜ GPA Leaderboard')
			try:
				Bz="\n                    SELECT s.name, s.gpa, s.student_id\n                    FROM students s\n                    WHERE s.status = 'active' AND s.gpa IS NOT NULL\n                    ORDER BY s.gpa DESC\n                    LIMIT 10\n                ";z=A.execute_query(Bz)
				if z:
					B4=[]
					for(h,(T,B,D))in enumerate(z):
						if B>=3.5:F='A';AE='ü•á'if h==0 else'ü•à'if h==1 else'ü•â'if h==2 else'üèÖ'
						elif B>=2.5:F='B';AE='üèÖ'
						elif B>=1.5:F='C';AE='üìö'
						else:F='D/F';AE='üìù'
						B4.append({'Rank':h+1,_AG:T,_h:f"{B:.2f}",_f:F,'Medal':AE})
					B_=pd.DataFrame(B4);st.dataframe(B_,use_container_width=_A,hide_index=_A);G,H,Aj=st.columns(3)
					with G:C0=len([A for(B,A,B)in z if A>=3.5]);st.metric('Honor Students (GPA ‚â• 3.5)',C0)
					with H:C1=len([A for(B,A,B)in z if 2.5<=A<3.5]);st.metric('Good Standing (GPA 2.5-3.4)',C1)
					with Aj:C2=len([A for(B,A,B)in z if A<2.]);st.metric('At Risk (GPA < 2.0)',C2)
				else:st.info('No GPA data available for leaderboard')
			except Exception as C:st.error(f"Error loading leaderboard: {str(C)}")
	with BY:
		st.subheader('Class Schedule');C3="\n                SELECT c.name as course_name, COALESCE(t.name, 'No Teacher Assigned') as teacher_name, \n                       c.schedule, c.grade_level\n                FROM courses c\n                LEFT JOIN teachers t ON c.teacher_id = t.teacher_id\n                WHERE c.schedule IS NOT NULL AND c.schedule != ''\n                ORDER BY c.grade_level, c.schedule\n            ";B5=A.execute_query(C3)
		if B5:
			Ak=pd.DataFrame(B5,columns=[_BZ,_B6,_B7,_A1])
			for I in Ak[_A1].unique():st.write(f"**{I} Schedule:**");C4=Ak[Ak[_A1]==I];st.dataframe(C4[[_BZ,_B6,_B7]],use_container_width=_A,hide_index=_A);st.write('')
		else:st.info('No scheduled courses found. Add course schedules to see them here!')
		st.subheader('Schedule Management')
		with st.expander('üìÖ Update Course Schedule'):
			o=_BY;X=A.execute_query(o)
			if X:
				g={f"{B} ({A})":A for(A,B)in X};A5=st.selectbox('Select Course to Schedule',list(g.keys()));B6=st.text_input('Schedule (e.g., MWF 9:00-10:00 AM)')
				if st.button('Update Schedule'):
					if B6:
						f=g[A5];C5='UPDATE courses SET schedule = ? WHERE course_id = ?'
						try:A.execute_update(C5,(B6,f));st.success('Schedule updated successfully!');st.rerun()
						except Exception as C:st.error(f"Error updating schedule: {str(C)}")
					else:st.error('Please enter a schedule')
			else:st.info('No courses available to schedule')
	with BZ:
		st.subheader('ü§ñ AI-Powered Grade Promotion System');G,H=st.columns(2)
		with G:st.markdown('### üìã Promotion Criteria');C6='\n            **Academic Requirements:**\n            - Minimum GPA: 2.0\n            - Minimum Attendance: 75%\n            - Minimum Behavior Score: 60\n            \n            **AI Evaluation Factors:**\n            - Overall academic performance\n            - Attendance patterns\n            - Behavioral assessments\n            - Individual progress tracking\n            ';st.info(C6);st.markdown('### ‚öôÔ∏è Promotion Settings');b=st.number_input('Minimum GPA for Promotion',min_value=_D,max_value=4.,value=2.,step=.1);c=st.number_input('Minimum Attendance (%)',min_value=0,max_value=100,value=75);d=st.number_input('Minimum Behavior Score',min_value=0,max_value=100,value=60)
		with H:
			st.markdown('### üìä Promotion Statistics');C7="\n                SELECT \n                    grade,\n                    COUNT(*) as total_students,\n                    AVG(gpa) as avg_gpa,\n                    AVG(attendance_rate) as avg_attendance,\n                    AVG(behavior_score) as avg_behavior,\n                    COUNT(CASE WHEN gpa >= 2.0 AND attendance_rate >= 75 AND behavior_score >= 60 THEN 1 END) as eligible_for_promotion\n                FROM students \n                WHERE status = 'active'\n                GROUP BY grade\n                ORDER BY grade\n            ";B7=A.execute_query(C7)
			if B7:AF=pd.DataFrame(B7,columns=[_f,_s,'Avg GPA','Avg Attendance','Avg Behavior',BT]);AF[Ao]=(AF[BT]/AF[_s]*100).round(1);st.dataframe(AF,use_container_width=_A,hide_index=_A)
			else:st.info('No student data available for promotion analysis')
		st.markdown(_AP);st.markdown('### üë• Individual Student Review');G,H=st.columns([2,1])
		with G:
			Y="\n                SELECT s.student_id, s.name, s.grade, s.gpa, s.attendance_rate, s.behavior_score,\n                       CASE \n                           WHEN s.gpa >= ? AND s.attendance_rate >= ? AND s.behavior_score >= ? \n                           THEN 'Eligible' \n                           ELSE 'Review Needed' \n                       END as promotion_status\n                FROM students s\n                WHERE s.status = 'active'\n                ORDER BY s.grade, s.name\n            ";M=A.execute_query(Y,(b,c,d))
			if M:
				C8=pd.DataFrame(M,columns=[_Cs,_P,_Cl,_h,_Ct,_BS,_o])
				def C9(val):
					if val=='Eligible':return AS
					elif val=='Review Needed':return AT
					return''
				CA=C8.style.map(C9,subset=[_o]);st.dataframe(CA,use_container_width=_A,hide_index=_A);CB=[f"{A[1]} ({A[0]})"for A in M];p=st.selectbox('Select Student for AI Analysis',CB)
				if p:
					D=p.split('(')[1].replace(')','')
					if st.button('ü§ñ Get AI Promotion Recommendation'):
						with st.spinner('AI analyzing student performance...'):
							CC='\n                                SELECT s.*, \n                                       AVG(g.grade) as avg_course_grade,\n                                       COUNT(g.grade_id) as total_grades\n                                FROM students s\n                                LEFT JOIN grades g ON s.student_id = g.student_id\n                                WHERE s.student_id = ?\n                                GROUP BY s.student_id\n                            ';B8=A.execute_query(CC,(D,))
							if B8:
								E=B8[0];D=E[0]if E[0]is not _B else _i;Q=E[1]if E[1]is not _B else _i;N=E[3]if E[3]is not _B else _i;B=E[5]if E[5]is not _B else _D;J=E[6]if E[6]is not _B else _D;K=E[7]if E[7]is not _B else 0;B9=E[-2]if E[-2]is not _B else _B;CD=f"{B:.2f}"if B is not _B else _i;CE=f"{J:.1f}"if J is not _B else _i;CF=f"{K}"if K is not _B else _i;CG=f"{B9:.2f}"if B9 is not _B else _i;j=f"""
**AI PROMOTION ANALYSIS**

**Student:** {Q} (ID: {D})
**Current Grade:** {N}
**Academic Performance:**
- Overall GPA: {CD}
- Average Course Grade: {CG}
- Attendance Rate: {CE}%
- Behavior Score: {CF}/100

**Criteria Assessment:**
- GPA Requirement (‚â•{b}): {Ap if B is not _B and B>=b else Aq}
- Attendance Requirement (‚â•{c}%): {Ap if J is not _B and J>=c else Aq}
- Behavior Requirement (‚â•{d}): {Ap if K is not _B and K>=d else Aq}

**AI RECOMMENDATION:**
""";CH=B is not _B and B>=b and J is not _B and J>=c and K is not _B and K>=d
								if CH:A0=get_next_grade(N);j+=f"""
**PROMOTE** to {A0}

**Reasoning:** Student demonstrates consistent academic performance above minimum requirements. Strong attendance and behavior scores indicate readiness for next grade level challenges.

**Recommendations for Success:**
- Continue monitoring academic progress
- Maintain current attendance patterns
- Consider advanced placement opportunities
"""
								else:
									j+=f"""
**RETAIN** in current grade

**Reasoning:** Student has not met all promotion criteria. Additional support needed before advancement.

**Intervention Recommendations:**
"""
									if B is _B or B<b:j+='\n- Academic tutoring and remedial support'
									if J is _B or J<c:j+='\n- Attendance intervention program'
									if K is _B or K<d:j+='\n- Behavioral counseling and support'
								st.markdown(j)
		with H:
			st.markdown('### üéØ Quick Actions')
			if st.button('üöÄ Run Bulk AI Promotion',type=_AW):
				with st.spinner('Processing AI-powered promotions for all students...'):
					try:
						A.execute_update('\n                            CREATE TABLE IF NOT EXISTS promotion_history (\n                                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                                academic_year TEXT NOT NULL,\n                                student_id TEXT NOT NULL,\n                                student_name TEXT NOT NULL,\n                                from_grade TEXT NOT NULL,\n                                to_grade TEXT NOT NULL,\n                                action TEXT NOT NULL,\n                                promotion_date TEXT NOT NULL,\n                                gpa REAL,\n                                attendance_rate REAL,\n                                behavior_score REAL,\n                                reason TEXT\n                            )\n                        ');BA=A.execute_query("\n                            SELECT student_id, name, grade, gpa, attendance_rate, behavior_score\n                            FROM students \n                            WHERE status = 'active'\n                            ORDER BY grade, name\n                        ");BB=0;BC=0;BD=0;AG=[]
						for E in BA:
							D,T,N,B,J,K=E;BE=B>=b;BF=J>=c;BG=K>=d
							if BE and BF and BG:
								A0=get_next_grade(N)
								if A0==_AJ:A.execute_update(_CP,(D,));BD+=1;k=_AK;l=_AJ;m='Met all promotion criteria - Graduated'
								else:A.execute_update(_CO,(A0,D));BB+=1;k=_Bm;l=A0;m='Met all promotion criteria'
								Au(student_id=D,student_name=T,from_grade=N,to_grade=l,action=k,gpa=B,attendance_rate=J,behavior_score=K,reason=m);AG.append({_P:T,A3:k.title(),Ar:N,As:l,BU:m})
							else:
								BC+=1;AH=[]
								if not BE:AH.append(f"GPA {B:.2f} < {b}")
								if not BF:AH.append(f"Attendance {J:.1f}% < {c}%")
								if not BG:AH.append(f"Behavior {K} < {d}")
								m='; '.join(AH);Au(student_id=D,student_name=T,from_grade=N,to_grade=N,action=_Bn,gpa=B,attendance_rate=J,behavior_score=K,reason=m);AG.append({_P:T,A3:AV,Ar:N,As:N,BU:m})
						CI=len(BA);st.success(f"""
                        **Bulk Promotion Complete!**
                        - Total Students Processed: {CI}
                        - Students Promoted: {BB}
                        - Students Graduated: {BD}
                        - Students Retained: {BC}
                        """)
						with st.expander('View Detailed Results',expanded=_A):
							if AG:
								CJ=pd.DataFrame(AG)
								def CK(val):
									A=val
									if A==At:return AS
									elif A==_B2:return An
									elif A==AV:return AT
									return''
								CL=CJ.style.map(CK,subset=[A3]);st.dataframe(CL,use_container_width=_A,hide_index=_A)
							else:st.info('No students to process')
						st.rerun()
					except Exception as C:st.error(f"Error during bulk promotion: {str(C)}")
			st.markdown(_AP);st.markdown('### üìä Historical Promotion Analysis')
			try:
				A.execute_update('\n                    CREATE TABLE IF NOT EXISTS promotion_history (\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\n                        academic_year TEXT NOT NULL,\n                        student_id TEXT NOT NULL,\n                        student_name TEXT NOT NULL,\n                        from_grade TEXT NOT NULL,\n                        to_grade TEXT NOT NULL,\n                        action TEXT NOT NULL,\n                        promotion_date TEXT NOT NULL,\n                        gpa REAL,\n                        attendance_rate REAL,\n                        behavior_score REAL,\n                        reason TEXT\n                    )\n                ');from datetime import datetime as BH;BI=BH.now().year;A1=f"{BI}-{str(BI+1)[2:]}";CM=A.execute_query('\n                    SELECT COUNT(*) FROM promotion_history \n                    WHERE academic_year = ?\n                ',(A1,))
				if CM[0][0]==0:
					CN=A.execute_query('\n                        SELECT student_id, name, grade, gpa, attendance_rate, behavior_score, status\n                        FROM students\n                    ')
					for E in CN:
						D,T,I,B,CO,CP,CQ=E
						if CQ==_AK:k=_AK;l=_AJ
						else:k=_n;l=I
						A.execute_update('\n                            INSERT INTO promotion_history \n                            (academic_year, student_id, student_name, from_grade, to_grade, action, \n                             promotion_date, gpa, attendance_rate, behavior_score, reason)\n                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n                        ',(A1,D,T,I,l,k,BH.now().strftime(_M),B,CO,CP,'Initial enrollment data'))
				CR="\n                    SELECT \n                        academic_year,\n                        COUNT(*) as total_students,\n                        COUNT(CASE WHEN action = 'promoted' THEN 1 END) as promoted,\n                        COUNT(CASE WHEN action = 'retained' THEN 1 END) as retained,\n                        COUNT(CASE WHEN action = 'graduated' THEN 1 END) as graduated,\n                        ROUND(\n                            (COUNT(CASE WHEN action = 'promoted' THEN 1 END) * 100.0 / \n                             NULLIF(COUNT(CASE WHEN action IN ('promoted', 'retained') THEN 1 END), 0)), 1\n                        ) as promotion_rate\n                    FROM promotion_history\n                    WHERE action IN ('promoted', 'retained', 'graduated')\n                    GROUP BY academic_year\n                    ORDER BY academic_year DESC\n                    LIMIT 5\n                ";BJ=A.execute_query(CR)
				if BJ:
					A2=pd.DataFrame(BJ,columns=[BV,_s,At,AV,_B2,Ao]);A2=A2.fillna(0);G,H=st.columns(2)
					with G:
						st.dataframe(A2,use_container_width=_A,hide_index=_A);BK=A.execute_query("\n                            SELECT \n                                from_grade,\n                                COUNT(*) as total,\n                                COUNT(CASE WHEN action = 'promoted' THEN 1 END) as promoted,\n                                COUNT(CASE WHEN action = 'retained' THEN 1 END) as retained,\n                                COUNT(CASE WHEN action = 'graduated' THEN 1 END) as graduated\n                            FROM promotion_history\n                            WHERE academic_year = ? AND action IN ('promoted', 'retained', 'graduated')\n                            GROUP BY from_grade\n                            ORDER BY \n                                CASE from_grade\n                                    WHEN 'Grade 1' THEN 1\n                                    WHEN 'Grade 2' THEN 2\n                                    WHEN 'Grade 3' THEN 3\n                                    WHEN 'Grade 4' THEN 4\n                                    WHEN 'Grade 5' THEN 5\n                                    WHEN 'Grade 6' THEN 6\n                                    WHEN 'JHS 1' THEN 7\n                                    WHEN 'JHS 2' THEN 8\n                                    WHEN 'JHS 3' THEN 9\n                                    ELSE 10\n                                END\n                        ",(A1,))
						if BK:st.markdown(f"#### Current Year ({A1}) by Grade");CS=pd.DataFrame(BK,columns=[_f,'Total',At,AV,_B2]);st.dataframe(CS,use_container_width=_A,hide_index=_A)
					with H:
						if len(A2)>1:import plotly.express as q;r=q.line(A2,x=BV,y=Ao,title='Promotion Rate Trend',markers=_A);r.update_layout(yaxis_range=[0,100]);st.plotly_chart(r,use_container_width=_A)
						else:st.info('Need more historical data to show trend chart')
						BL=A.execute_query("\n                            SELECT student_name, from_grade, to_grade, action, promotion_date\n                            FROM promotion_history\n                            WHERE academic_year = ? AND action IN ('promoted', 'retained', 'graduated')\n                            ORDER BY promotion_date DESC\n                            LIMIT 10\n                        ",(A1,))
						if BL:
							st.markdown('#### Recent Promotion Activities');CT=pd.DataFrame(BL,columns=[_AG,Ar,As,A3,_AU])
							def CU(val):
								A=val
								if A==_Bm:return AS
								elif A==_AK:return An
								elif A==_Bn:return AT
								return''
							CV=CT.style.map(CU,subset=[A3]);st.dataframe(CV,use_container_width=_A,hide_index=_A)
				else:st.info('No historical promotion data available yet. Data will be populated after running promotions.')
			except Exception as C:st.error(f"Error loading historical data: {str(C)}")
def finance_page():
	A1='Payment Rate %';A0='Paid Students';z='donations';y='grants';x='Profit';w='Expenses';v='üí≥ Fee Management';u='üìä Financial Overview';c='Due Date';b='fees';a='tuition';st.header('üí∞ Financial Management');C=DatabaseManager();A2={_Ba:'‚Çµ',_Cu:'$','‚Ç¨ (Euro)':'‚Ç¨',_Cv:'¬£',_Cw:'‚Ç¶'}
	if _CA in st.session_state:J=st.session_state.selected_currency_name;A=A2.get(J,'‚Çµ')
	else:J=_Ba;A='‚Çµ'
	A3,A4,A5=st.tabs([u,_Cx,v])
	with A3:
		st.subheader(u);D,E=st.columns(2)
		with D:
			st.subheader('üí∞ Financial Metrics')
			try:
				A6="\n                    SELECT SUM(amount) FROM finance \n                    WHERE type IN ('tuition', 'fees', 'grants', 'donations') \n                    AND status = 'completed'\n                ";d=C.execute_query(A6);F=d[0][0]if d[0][0]else 0;A7="\n                    SELECT SUM(amount) FROM finance \n                    WHERE type IN ('salary', 'utilities', 'supplies', 'maintenance', 'other_expenses')\n                    AND status = 'completed'\n                ";e=C.execute_query(A7);P=e[0][0]if e[0][0]else 0;Q=F-P;f=Q/F*100 if F>0 else 0;st.metric(_BM,f"{A}{F:,.2f}");st.metric('Total Expenses',f"{A}{P:,.2f}");st.metric('Net Profit',f"{A}{Q:,.2f}",delta=f"{f:.1f}%");A8="\n                    SELECT \n                        CASE \n                            WHEN type = 'tuition' THEN 'Tuition'\n                            WHEN type = 'grants' THEN 'Grants'\n                            WHEN type = 'donations' THEN 'Donations'\n                            WHEN type = 'fees' THEN 'Fees'\n                            ELSE 'Other'\n                        END as source,\n                        SUM(amount) as total_amount\n                    FROM finance \n                    WHERE type IN ('tuition', 'fees', 'grants', 'donations') \n                    AND status = 'completed'\n                    GROUP BY source\n                    HAVING total_amount > 0\n                ";W=C.execute_query(A8)
				if W:A9=[A[0]for A in W];X=[A[1]for A in W];K=px.pie(values=X,names=A9,title='Revenue Sources');st.plotly_chart(K,use_container_width=_A)
				else:st.info('No revenue data available yet.')
			except Exception as B:st.error(f"Error loading financial data: {str(B)}");F=0;P=0;Q=0
		with E:
			st.subheader('ü§ñ AI Financial Insights')
			if st.button('Generate Financial Report'):
				L=SchoolAI()
				try:
					Y="\n                        SELECT COUNT(*), COALESCE(SUM(amount), 0) \n                        FROM finance \n                        WHERE status = 'pending' AND type IN ('tuition', 'fees')\n                    ";g=C.execute_query(Y);AA,AB=g[0]if g else(0,0);AC="\n                        SELECT \n                            strftime('%Y-%m', date) as month,\n                            SUM(amount) as monthly_revenue\n                        FROM finance \n                        WHERE type IN ('tuition', 'fees', 'grants', 'donations') \n                        AND status = 'completed'\n                        AND date >= date('now', '-6 months')\n                        GROUP BY month\n                        ORDER BY month\n                    ";I=C.execute_query(AC);AD=f"""
                    Analyze the school's financial data (Currency: {J}):
                    - Total Revenue: {A}{F:,.2f}
                    - Total Expenses: {A}{P:,.2f}
                    - Net Profit: {A}{Q:,.2f}
                    - Net Profit Margin: {f:.1f}%
                    - Pending Payments: {AA} transactions worth {A}{AB:,.2f}
                    - Recent Revenue Trend: {len(I)} months of data available
                    
                    Provide insights on:
                    1. Financial health assessment
                    2. Cost optimization opportunities
                    3. Revenue enhancement strategies
                    4. Cash flow management recommendations
                    5. Collection efficiency improvements
                    """
					with st.spinner(_Cy):AE=L.generate_response(AD);st.write(AE)
				except Exception as B:st.error(f"Error generating AI insights: {str(B)}")
		st.subheader('üìà Financial Analytics')
		try:
			AF="\n                SELECT \n                    strftime('%Y-%m', date) as month,\n                    SUM(CASE WHEN type IN ('tuition', 'fees', 'grants', 'donations') THEN amount ELSE 0 END) as revenue,\n                    SUM(CASE WHEN type IN ('salary', 'utilities', 'supplies', 'maintenance', 'other_expenses') THEN amount ELSE 0 END) as expenses\n                FROM finance \n                WHERE status = 'completed'\n                AND date >= date('now', '-12 months')\n                GROUP BY month\n                ORDER BY month\n            ";I=C.execute_query(AF)
			if I:
				AG=[A[0]for A in I];h=[A[1]for A in I];i=[A[2]for A in I];Z=pd.DataFrame({_AC:AG,_Ac:h,w:i,x:[A-B for(A,B)in zip(h,i)]});D,E=st.columns(2)
				with D:AH=px.line(Z,x=_AC,y=_Ac,title=f"Monthly Revenue Trend ({A})");st.plotly_chart(AH,use_container_width=_A)
				with E:AI=px.line(Z,x=_AC,y=x,title=f"Monthly Profit/Loss Trend ({A})");st.plotly_chart(AI,use_container_width=_A)
				AJ=px.bar(Z,x=_AC,y=[_Ac,w],title=f"Revenue vs Expenses Comparison ({A})",barmode='group');st.plotly_chart(AJ,use_container_width=_A)
			else:st.info('No financial trend data available yet.')
		except Exception as B:st.error(f"Error loading analytics: {str(B)}")
	with A4:
		st.subheader(_Cz);st.info('üí° Use this section to record all financial transactions including tuition payments, fees, expenses, and other income.');D,E=st.columns(2)
		with D:st.subheader('üìù Transaction Details');M=st.selectbox(_CB,[a,b,y,z,_x,'utilities','supplies','maintenance','other_expenses']);N=st.number_input(f"Amount ({A})",min_value=_D,step=.01,format='%.2f');R=st.text_input(_Bb,placeholder='Enter transaction description...')
		with E:
			st.subheader('üéØ Additional Information')
			if M in[a,b]:AK="SELECT student_id, name FROM students WHERE status = 'active' ORDER BY name";AL=C.execute_query(AK);AM=['']+[f"{A[1]} ({A[0]})"for A in AL];S=st.selectbox('Student (if applicable)',AM)
			else:S='';st.info('üíº Business expense - no student selection needed')
			AN=st.selectbox(_o,[_BQ,'completed','overdue']);AO=st.date_input(_AU,value=datetime.now().date())
		if N>0:
			st.success(f"üí∞ Transaction Preview: **{A}{N:,.2f}** - {M.title()}")
			if M in[a,b]:st.info('üìö This is a revenue transaction (increases school income)')
			elif M in[y,z]:st.info('üéÅ This is an income transaction (external funding)')
			else:st.warning('üí∏ This is an expense transaction (reduces school funds)')
		D,E,AP=st.columns([2,1,1])
		with D:
			if st.button('üíæ Save Transaction',type=_AW,use_container_width=_A):
				if N<=0:st.error('‚ö†Ô∏è Please enter a valid amount greater than 0')
				elif not R.strip():st.error('‚ö†Ô∏è Please enter a description for the transaction')
				else:
					try:AQ=S.split('(')[1].rstrip(')')if S and'('in S else _B;AR=f"TXN_{datetime.now().strftime(_A7)}";AS=f"{R} ({A})"if R else f"Transaction ({A})";AT='\n                            INSERT INTO finance (transaction_id, student_id, amount, type, description, date, status)\n                            VALUES (?, ?, ?, ?, ?, ?, ?)\n                        ';C.execute_update(AT,(AR,AQ,N,M,AS,AO.isoformat(),AN));st.success(f"‚úÖ Transaction recorded successfully!");st.success(f"üí∞ **{A}{N:,.2f}** - {R}");st.balloons();st.rerun()
					except Exception as B:st.error(f"‚ùå Error saving transaction: {str(B)}")
		with E:
			if st.button('üîÑ Clear Form',use_container_width=_A):st.rerun()
		with AP:
			if st.button('üìä View Overview',use_container_width=_A):st.info("üí° Switch to the 'Financial Overview' tab to see updated metrics and charts!")
		st.subheader('üìã Recent Transactions')
		try:
			AU='\n                SELECT transaction_id, type, amount, description, date, status\n                FROM finance \n                ORDER BY date DESC, rowid DESC\n                LIMIT 5\n            ';j=C.execute_query(AU)
			if j:G=pd.DataFrame(j,columns=['ID',_AX,_AT,_Bb,_AU,_o]);G[_AT]=G[_AT].apply(lambda x:f"{A}{x:,.2f}"if pd.notnull(x)else f"{A}0.00");G[_AX]=G[_AX].str.title();G[_o]=G[_o].str.title();st.dataframe(G,use_container_width=_A,hide_index=_A)
			else:st.info('üìù No transactions recorded yet. Use the form above to add your first transaction!')
		except Exception as B:st.error(f"Error loading recent transactions: {str(B)}")
	with A5:
		st.subheader(v);AV,AW,AX=st.tabs(['üìã Fee Structure','üí∞ Collections','üìä Payment Analytics'])
		with AV:
			st.subheader('Current Fee Structure')
			try:
				AY="SELECT DISTINCT grade FROM students WHERE status = 'active' ORDER BY grade";k=C.execute_query(AY);AZ=[A[0]for A in k]if k else[_a,_R,_S,_T];l=[]
				for m in AZ:Aa="\n                        SELECT amount FROM finance \n                        WHERE description LIKE ? AND type = 'tuition'\n                        ORDER BY date DESC LIMIT 1\n                    ";n=C.execute_query(Aa,(f"%{m}%",));T=n[0][0]if n else 10000;l.append({_A1:m,f"Tuition ({A})":T,f"Activity Fee ({A})":T*.05,f"Technology Fee ({A})":T*.03,f"Total ({A})":T*1.08})
				U=pd.DataFrame(l);Ab=[B for B in U.columns if A in B]
				for o in Ab:U[o]=U[o].apply(lambda x:f"{A}{x:,.2f}")
				st.dataframe(U,use_container_width=_A)
				if st.button('ü§ñ AI Optimize Fee Structure'):
					with st.spinner('AI analyzing market rates and costs...'):Ac="\n                            SELECT grade, COUNT(*) as student_count\n                            FROM students \n                            WHERE status = 'active'\n                            GROUP BY grade\n                        ";p=C.execute_query(Ac);Ad=f"""
                        Analyze our current fee structure and student distribution (Currency: {J}):
                        Grade Distribution: {dict(p)if p else"No data"}
                        Current Revenue: {A}{F:,.2f}
                        
                        Provide recommendations for:
                        1. Competitive fee pricing for each grade level
                        2. Optimal fee structure to maximize revenue while remaining affordable
                        3. Additional fee categories that could be introduced
                        4. Discount strategies for families with multiple children
                        """;L=SchoolAI();Ae=L.generate_response(Ad);st.success('‚úÖ Fee structure analysis complete!');st.write(Ae)
			except Exception as B:st.error(f"Error loading fee structure: {str(B)}")
		with AW:
			st.subheader('Collection Status')
			try:
				Af="\n                    SELECT \n                        status,\n                        COUNT(*) as count,\n                        COALESCE(SUM(amount), 0) as total_amount\n                    FROM finance \n                    WHERE type IN ('tuition', 'fees')\n                    GROUP BY status\n                ";V=C.execute_query(Af)
				if V:
					q=[A[0]for A in V];Ag=[A[1]for A in V];X=[A[2]for A in V];D,E=st.columns(2)
					with D:K=px.bar(x=q,y=Ag,title='Payment Status Count');st.plotly_chart(K,use_container_width=_A)
					with E:K=px.bar(x=q,y=X,title=f"Payment Status Amount ({A})");st.plotly_chart(K,use_container_width=_A)
					Ah="\n                        SELECT s.name, f.amount, f.description, f.date\n                        FROM finance f\n                        JOIN students s ON f.student_id = s.student_id\n                        WHERE f.status = 'overdue' OR (f.status = 'pending' AND f.date < date('now', '-30 days'))\n                        ORDER BY f.date\n                    ";r=C.execute_query(Ah)
					if r:
						st.subheader('‚ö†Ô∏è Overdue Payments');O=pd.DataFrame(r,columns=[_AG,_AT,_Bb,c]);O[_AT]=O[_AT].apply(lambda x:f"{A}{x:,.2f}"if pd.notnull(x)else f"{A}0.00")
						try:O[c]=pd.to_datetime(O[c]).dt.date
						except:pass
						st.dataframe(O,use_container_width=_A)
				else:st.info('No payment data available yet.')
				if st.button('ü§ñ AI Send Payment Reminders'):
					try:
						Y="\n                            SELECT DISTINCT s.name, s.parent_contact, f.amount, f.description\n                            FROM finance f\n                            JOIN students s ON f.student_id = s.student_id\n                            WHERE f.status IN ('pending', 'overdue')\n                        ";s=C.execute_query(Y)
						with st.spinner('AI generating personalized payment reminders...'):L=SchoolAI();Ai=f"""
                            Generate personalized payment reminder messages for {len(s)} students.
                            Use currency: {J} ({A})
                            Create templates that are:
                            1. Professional but friendly
                            2. Include payment details
                            3. Offer payment plan options
                            4. Maintain positive school-parent relationship
                            """;Aj=L.generate_response(Ai);st.success(f"‚úÖ {len(s)} personalized payment reminders generated!");st.write(Aj)
					except Exception as B:st.error(f"Error generating reminders: {str(B)}")
			except Exception as B:st.error(f"Error loading collection data: {str(B)}")
		with AX:
			st.subheader('Payment Analytics by Grade')
			try:
				Ak="\n                    SELECT \n                        s.grade,\n                        COUNT(DISTINCT s.student_id) as total_students,\n                        COUNT(DISTINCT CASE WHEN f.status = 'completed' THEN f.student_id END) as paid_students,\n                        COALESCE(AVG(f.amount), 0) as avg_payment\n                    FROM students s\n                    LEFT JOIN finance f ON s.student_id = f.student_id AND f.type IN ('tuition', 'fees')\n                    WHERE s.status = 'active'\n                    GROUP BY s.grade\n                    ORDER BY s.grade\n                ";t=C.execute_query(Ak)
				if t:H=pd.DataFrame(t,columns=[_f,_s,A0,f"Avg Payment ({A})"]);H[A1]=(H[A0]/H[_s]*100).round(2);H[f"Avg Payment ({A})"]=H[f"Avg Payment ({A})"].apply(lambda x:f"{A}{x:,.2f}");st.dataframe(H,use_container_width=_A);Al=px.bar(H,x=_f,y=A1,title='Payment Rate by Grade Level');st.plotly_chart(Al,use_container_width=_A)
				else:st.info('No payment analytics data available yet.')
			except Exception as B:st.error(f"Error loading payment analytics: {str(B)}")
def analytics_page():
	'Advanced Analytics Dashboard for School Management System';k='present_students';j='class_teacher';i='avg_gpa';h='üí∞ Financial Analytics';c='Avg Salary ($)';b='Total Amount ($)';a='transaction_count';Z='total_amount';st.header('üìà Advanced Analytics');F=DatabaseManager();l="\n        SELECT student_id, name, age, grade, gpa, behavior_score, status, stream_id\n        FROM students \n        WHERE status = 'active'\n    "
	try:d=F.execute_query(l)
	except Exception as AN:st.error('Unable to load student data. Please check database connection.');return
	if not d:st.warning('No student data available for analytics.');return
	A=pd.DataFrame(d,columns=[_C,_E,_Z,_H,_G,_U,_I,_O]);P={}
	for L in A[_C]:
		try:
			m=_CX;e=F.execute_query(m,(L,))[0][0]
			if e>0:n="\n                    SELECT COUNT(*) FROM attendance \n                    WHERE student_id = ? AND status = 'present'\n                ";o=F.execute_query(n,(L,))[0][0];P[L]=o/e*100
			else:P[L]=1e2
		except Exception:P[L]=_D
	A[_K]=A[_C].map(P);p,q,r,s,t,u,v=st.tabs(['üéØ Overview KPIs','üìä Student Analytics','üè´ Stream Analysis',h,'üë®\u200düè´ Teacher Analytics','ü§ñ AI Predictions','üìà Trends & Stats'])
	with p:
		st.subheader(_CY);C,D,G,S=st.columns(4)
		with C:w=A[_G].mean();st.metric(_AM,f"{w:.2f}")
		with D:x=A[_K].mean();st.metric(_Br,f"{x:.1f}%")
		with G:y=len(A[A[_G]>=3.5]);st.metric('High Performers (GPA ‚â• 3.5)',y)
		with S:z=len(A[(A[_G]<2.)|(A[_K]<75)]);st.metric(_Bs,z)
		st.divider();st.subheader('üìä System Overview');C,D,G,S=st.columns(4)
		try:
			with C:A0=F.execute_query(_CQ)[0][0];st.metric('Active Students',A0)
			with D:A1=F.execute_query(_CR)[0][0];st.metric(_CZ,A1)
			with G:A2=F.execute_query(_BF)[0][0];st.metric(_Ca,A2)
			with S:A3=F.execute_query('SELECT COUNT(*) FROM streams')[0][0];st.metric(_C6,A3)
		except Exception:st.error('Unable to load system metrics.')
	with q:
		st.subheader('üìä Student Performance Analysis');C,D=st.columns(2)
		with C:f=A[_H].value_counts();B=px.bar(x=f.index,y=f.values,title=_Cf,labels={_k:_A1,_l:_AN});B.update_layout(showlegend=_F);st.plotly_chart(B,use_container_width=_A)
		with D:B=px.histogram(A,x=_G,nbins=20,title=_Cd,labels={_k:_h,_l:_AN});st.plotly_chart(B,use_container_width=_A)
		st.divider();st.subheader('üîó Performance Correlation Analysis');T=[_Z,_G,_K,_U];A4=A[T].corr();B=px.imshow(A4,text_auto=_A,aspect='auto',title='Performance Metrics Correlation Matrix',color_continuous_scale='RdBu_r');st.plotly_chart(B,use_container_width=_A);st.subheader('‚ö†Ô∏è At-Risk Students');M=A[(A[_G]<2.5)|(A[_K]<80)|(A[_U]<70)]
		if len(M)>0:
			st.warning(f"**{len(M)} students identified as at-risk:**")
			for(_,H)in M.iterrows():
				Q=[]
				if H[_G]<2.5:Q.append(f"Low GPA ({H[_G]:.2f})")
				if H[_K]<80:Q.append(f"Poor Attendance ({H[_K]:.1f}%)")
				if H[_U]<70:Q.append(f"Behavior Issues ({H[_U]:.0f})")
				st.write(f"‚ö†Ô∏è **{H[_E]}** - {_j.join(Q)}")
		else:st.success('No students currently identified as at-risk!')
	with r:
		st.subheader('üè´ Stream Performance Analysis');A5="\n            SELECT s.stream_id, s.grade_level, s.stream_type, s.max_capacity,\n                   COUNT(st.student_id) as current_students,\n                   AVG(st.gpa) as avg_gpa,\n                   t.name as class_teacher\n            FROM streams s\n            LEFT JOIN students st ON s.stream_id = st.stream_id AND st.status = 'active'\n            LEFT JOIN teachers t ON s.class_teacher_id = t.teacher_id\n            GROUP BY s.stream_id, s.grade_level, s.stream_type, s.max_capacity, t.name\n        "
		try:U=F.execute_query(A5)
		except Exception:st.error('Unable to load stream data.');U=[]
		if U:
			I=pd.DataFrame(U,columns=[_O,_A8,_A5,_y,_Ax,i,j]);C,D=st.columns(2)
			with C:B=px.bar(I,x=_O,y=_Ax,title='Students per Stream',color=_A8,labels={_k:_Ad,_l:_AN});st.plotly_chart(B,use_container_width=_A)
			with D:B=px.bar(I,x=_O,y=i,title='Average GPA by Stream',color=_A5,labels={_k:_Ad,_l:_AM});st.plotly_chart(B,use_container_width=_A)
			st.divider();I[_AR]=I[_Ax]/I[_y]*100;C,D=st.columns(2)
			with C:B=px.bar(I,x=_O,y=_AR,title='Stream Capacity Utilization (%)',color=_A5,labels={_k:_Ad,_l:'Capacity Utilization (%)'});B.add_hline(y=100,line_dash=_AD,line_color=_t,annotation_text=_Cg);st.plotly_chart(B,use_container_width=_A)
			with D:st.subheader('Stream Details');J=I[[_O,_A8,_A5,_Ax,_y,j]].copy();J.columns=[_Ad,_f,_AX,_Bx,_BO,_B6];st.dataframe(J,use_container_width=_A,hide_index=_A)
		else:st.info('No stream data available.')
	with s:
		st.subheader(h);A6='\n            SELECT type, SUM(amount) as total_amount, COUNT(*) as transaction_count\n            FROM finance\n            GROUP BY type\n        '
		try:V=F.execute_query(A6)
		except Exception:st.error('Unable to load financial data.');V=[]
		if V:
			N=pd.DataFrame(V,columns=[_w,Z,a]);C,D=st.columns(2)
			with C:B=px.pie(N,values=Z,names=_w,title='Revenue by Transaction Type');st.plotly_chart(B,use_container_width=_A)
			with D:B=px.bar(N,x=_w,y=a,title='Transaction Count by Type',labels={_k:_CB,_l:_e});st.plotly_chart(B,use_container_width=_A)
			st.divider();C,D,G=st.columns(3);g=N[Z].sum();W=N[a].sum();A7=g/W if W>0 else 0
			with C:st.metric(_BM,f"${g:,.2f}")
			with D:st.metric(_Bu,W)
			with G:st.metric('Avg Transaction Value',f"${A7:.2f}")
			st.subheader(_Ci);J=N.copy();J.columns=[_CB,b,'Transaction Count'];J[b]=J[b].apply(lambda x:f"${x:,.2f}");st.dataframe(J,use_container_width=_A,hide_index=_A)
		else:st.info('No financial data available.')
	with t:
		st.subheader('üë®\u200düè´ Teacher Performance Analytics');A8="\n            SELECT name, subject, department, performance_score, salary\n            FROM teachers\n            WHERE status = 'active'\n        "
		try:X=F.execute_query(A8)
		except Exception:st.error('Unable to load teacher data.');X=[]
		if X:
			K=pd.DataFrame(X,columns=[_E,_AY,_A4,_p,_x]);C,D=st.columns(2)
			with C:A9=K.groupby(_A4)[_p].mean().reset_index();B=px.bar(A9,x=_A4,y=_p,title='Average Performance by Department',labels={_k:_Q,_l:_AV});st.plotly_chart(B,use_container_width=_A)
			with D:B=px.scatter(K,x=_p,y=_x,color=_A4,title='Performance vs Salary',labels={_k:_AV,_l:'Salary ($)'});st.plotly_chart(B,use_container_width=_A)
			st.divider();C,D,G=st.columns(3)
			with C:AA=K[_p].mean();st.metric('Average Performance Score',f"{AA:.1f}")
			with D:AB=len(K[K[_p]>=90]);st.metric('Top Performers (‚â•90)',AB)
			with G:AC=K[_x].mean();st.metric('Average Salary',f"${AC:,.2f}")
			st.subheader('üìö Department Analysis');R=K.groupby(_A4).agg({_p:_B5,_x:_B5,_E:_AL}).round(2);R.columns=[_BV,c,'Teacher Count'];R[c]=R[c].apply(lambda x:f"${x:,.2f}");st.dataframe(R,use_container_width=_A)
		else:st.info('No teacher data available.')
	with u:
		st.subheader('ü§ñ AI Predictive Analytics');C,D=st.columns(2)
		with C:
			st.info('**Student Performance Prediction**');st.write('Analyze student data patterns to predict academic outcomes and identify intervention needs.')
			if st.button('ü§ñ Generate Performance Predictions',key='predict_performance'):
				try:
					O=SchoolAI();T=[_Z,_G,_K,_U];AO=A[T].describe();AD=f"""
                    Based on student performance data, provide academic predictions and recommendations:
                    
                    Data Summary:
                    - Total Students: {len(A)}
                    - Average GPA: {A[_G].mean():.2f}
                    - Average Attendance: {A[_K].mean():.1f}%
                    - High Performers (GPA ‚â• 3.5): {len(A[A[_G]>=3.5])}
                    - At-Risk Students: {len(A[(A[_G]<2.)|(A[_K]<75)])}
                    
                    Provide concise predictions for:
                    1. Students needing academic intervention
                    2. Expected graduation rates
                    3. Performance trends for next semester
                    4. Recommended interventions
                    """
					with st.spinner('Analyzing performance patterns...'):AE=O.generate_response(AD);st.success('**AI Predictions Generated:**');st.write(AE)
				except Exception:st.error('AI prediction service temporarily unavailable.')
		with D:
			st.info('**Risk Assessment Analysis**');st.write('Comprehensive risk analysis for at-risk students with intervention strategies.')
			if st.button('üéØ Generate Risk Assessment',key='risk_assessment'):
				try:
					O=SchoolAI();M=A[(A[_G]<2.5)|(A[_K]<80)|(A[_U]<70)];AF=f"""
                    Analyze at-risk student data and provide intervention recommendations:
                    
                    Risk Analysis:
                    - Total Students: {len(A)}
                    - At-Risk Students: {len(M)}
                    - Low GPA (<2.5): {len(A[A[_G]<2.5])} students
                    - Poor Attendance (<80%): {len(A[A[_K]<80])} students
                    - Behavior Issues (<70): {len(A[A[_U]<70])} students
                    
                    Provide:
                    1. Risk assessment summary
                    2. Intervention strategies
                    3. Resource allocation recommendations
                    4. Implementation timeline
                    """
					with st.spinner('Generating risk assessment...'):AG=O.generate_response(AF);st.success('**Risk Assessment Complete:**');st.write(AG)
				except Exception:st.error('AI analysis service temporarily unavailable.')
		st.divider();st.subheader('üí° Quick AI Insights')
		if st.button('üìà Generate Performance Insights',key='performance_insights'):
			try:
				O=SchoolAI();AH=f"""
                Provide 3-5 key actionable insights about student performance:
                - Average GPA: {A[_G].mean():.2f}
                - Average Attendance: {A[_K].mean():.1f}%
                - High Performers: {len(A[A[_G]>=3.5])} students
                - At-Risk Students: {len(A[(A[_G]<2.)|(A[_K]<75)])} students
                
                Keep insights concise and actionable for school administrators.
                """
				with st.spinner('Generating insights...'):AI=O.generate_response(AH);st.info(f"**AI Insights:** {AI}")
			except Exception:st.error('AI insights service temporarily unavailable.')
	with v:
		st.subheader('üìà Attendance Trends & Statistics');AJ="\n            SELECT date, \n                   COUNT(*) as total_students,\n                   SUM(CASE WHEN status = 'present' THEN 1 ELSE 0 END) as present_students\n            FROM attendance\n            WHERE date >= date('now', '-30 days')\n            GROUP BY date\n            ORDER BY date\n        "
		try:Y=F.execute_query(AJ)
		except Exception:st.error('Unable to load attendance trend data.');Y=[]
		if Y:
			E=pd.DataFrame(Y,columns=[_L,_BP,k]);E[_K]=E[k]/E[_BP]*100;E[_L]=pd.to_datetime(E[_L]);B=px.line(E,x=_L,y=_K,title='Daily Attendance Rate (Last 30 Days)',labels={_k:_AU,_l:_B1});B.add_hline(y=E[_K].mean(),line_dash=_AD,line_color='green',annotation_text='Average Rate');st.plotly_chart(B,use_container_width=_A);C,D,G=st.columns(3)
			with C:AK=E[_K].mean();st.metric('Average Daily Attendance',f"{AK:.1f}%")
			with D:AL=E.loc[E[_K].idxmax()];st.metric('Best Attendance Day',f"{AL[_K]:.1f}%")
			with G:AM=E.loc[E[_K].idxmin()];st.metric('Lowest Attendance Day',f"{AM[_K]:.1f}%")
		else:st.info('No recent attendance data available for trend analysis.')
		st.divider();st.subheader('üìä Performance Trends');B=px.box(A,x=_H,y=_G,title='GPA Distribution by Grade Level',labels={_k:_A1,_l:_h});st.plotly_chart(B,use_container_width=_A);B=px.scatter(A,x=_K,y=_G,color=_H,size=_U,title='Attendance Rate vs GPA by Grade',labels={_k:_B1,_l:_h},hover_data=[_E]);st.plotly_chart(B,use_container_width=_A)
def ai_insights_page():
	Z='assistant';Y='Operational Efficiency';X='Academic Deep Dive';W='Financial Review';V='Risk Assessment';U='Trend Analysis';T='Performance Overview';S='last_ai_analysis';D='Error:';st.header('ü§ñ AI-Powered Insights');a=st.session_state.school_manager;b=a.db;C=AIHelperFunctions(b);st.subheader('üß† Comprehensive School Analysis');c,d=st.columns([2,1])
	with c:
		if st.button('üöÄ Generate Complete AI Analysis',type=_AW):
			with st.spinner('AI is analyzing all school data...'):
				A=SchoolAI()
				if _v in st.session_state:A.provider=st.session_state.ai_provider
				if _Y in st.session_state:A.model=st.session_state.ai_model
				if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
				e=C.get_data_by_type(_BG);f=f"""
                Based on the following real school data, provide a comprehensive analysis:
                
                {e}
                
                Please analyze:
                1. Overall performance assessment
                2. Key strengths and weaknesses
                3. Priority areas for improvement
                4. Strategic recommendations
                5. Implementation roadmap
                """
				try:
					F=A.generate_response(f)
					if D in F:st.error(f"{F}")
					else:st.write('### üìä AI Analysis Results');st.write(F);st.session_state.last_ai_analysis=F;st.success('Complete AI analysis generated successfully!')
				except Exception as B:st.error(f"Error generating AI analysis: {str(B)}")
	with d:
		st.subheader('üéØ Quick AI Actions')
		if st.button('üìù Generate Report'):
			with st.spinner('Generating comprehensive report...'):
				A=SchoolAI()
				if _v in st.session_state:A.provider=st.session_state.ai_provider
				if _Y in st.session_state:A.model=st.session_state.ai_model
				if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
				g=C.get_data_by_type(_Bo);h=f"""
                Generate a detailed school performance report based on this data:
                
                {g}
                
                Include:
                1. Executive summary
                2. Key performance indicators
                3. Student achievement metrics
                4. Financial overview
                5. Recommendations for improvement
                """
				try:
					I=A.generate_response(h)
					if D in I:st.error(f"{I}")
					else:
						st.success('Comprehensive report generated!')
						with st.expander('üìÑ View Generated Report'):st.write(I)
				except Exception as B:st.error(f"Error generating report: {str(B)}")
		if st.button('üîç Identify Trends'):
			with st.spinner('Analyzing trends...'):
				A=SchoolAI()
				if _v in st.session_state:A.provider=st.session_state.ai_provider
				if _Y in st.session_state:A.model=st.session_state.ai_model
				if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
				i=C.get_data_by_type(_BH);j=f"""
                Analyze trends based on this historical school data:
                
                {i}
                
                Identify:
                1. Academic performance trends over time
                2. Enrollment patterns and demographics
                3. Financial trends and patterns
                4. Staffing and resource utilization trends
                5. Emerging challenges and opportunities
                """
				try:
					J=A.generate_response(j)
					if D in J:st.error(f"{J}")
					else:
						st.info('Trend analysis completed!')
						with st.expander('üìä View Trend Analysis'):st.write(J)
				except Exception as B:st.error(f"Error analyzing trends: {str(B)}")
		if st.button('‚ö†Ô∏è Risk Assessment'):
			with st.spinner('Conducting risk assessment...'):
				A=SchoolAI()
				if _v in st.session_state:A.provider=st.session_state.ai_provider
				if _Y in st.session_state:A.model=st.session_state.ai_model
				if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
				k=C.get_data_by_type(_BI);l=f"""
                Conduct a comprehensive risk assessment based on this data:
                
                {k}
                
                Assess:
                1. Academic performance risks
                2. Financial risks and concerns
                3. Operational and safety risks
                4. Compliance and regulatory risks
                5. Risk mitigation strategies and priorities
                """
				try:
					K=A.generate_response(l)
					if D in K:st.error(f"{K}")
					else:
						st.warning('Risk assessment completed!')
						with st.expander('‚ö†Ô∏è View Risk Assessment'):st.write(K)
				except Exception as B:st.error(f"Error conducting risk assessment: {str(B)}")
	if S in st.session_state:
		st.subheader('üìã Previous Analysis')
		with st.expander('View Last Generated Analysis'):st.write(st.session_state.last_ai_analysis)
	st.subheader('üí° AI Recommendations');m,n,o,p=st.tabs(['üéì Academic','üë• Administrative',_Cb,'üè´ Infrastructure'])
	with m:
		st.write('### Academic Recommendations')
		if st.button('ü§ñ Analyze Academic Performance'):
			A=SchoolAI()
			if _v in st.session_state:A.provider=st.session_state.ai_provider
			if _Y in st.session_state:A.model=st.session_state.ai_model
			if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
			q=C.get_data_by_type(_BJ);r=f"""
            Based on this academic data, provide specific recommendations:
            
            {q}
            
            Focus on:
            1. Curriculum optimization suggestions
            2. Teaching methodology improvements
            3. Student support programs
            4. Assessment strategy enhancements
            5. Technology integration opportunities
            """
			with st.spinner('AI analyzing academic data...'):
				try:
					L=A.generate_response(r)
					if D in L:st.error(f"{L}")
					else:st.write(L);st.success('Academic analysis completed!')
				except Exception as B:st.error(f"Error generating academic recommendations: {str(B)}")
	with n:
		st.write('### Administrative Efficiency')
		if st.button('üîß Optimize Operations'):
			A=SchoolAI()
			if _v in st.session_state:A.provider=st.session_state.ai_provider
			if _Y in st.session_state:A.model=st.session_state.ai_model
			if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
			s=C.get_data_by_type(_BK);t=f"""
            Based on this administrative data, suggest improvements:
            
            {s}
            
            Address:
            1. Process automation opportunities
            2. Communication improvements
            3. Resource allocation optimization
            4. Staff productivity enhancements
            5. Digital transformation initiatives
            """
			with st.spinner('AI optimizing operations...'):
				try:
					M=A.generate_response(t)
					if D in M:st.error(f"{M}")
					else:st.write(M);st.success('Operational optimization completed!')
				except Exception as B:st.error(f"Error generating administrative recommendations: {str(B)}")
	with o:
		st.write('### Financial Optimization')
		if st.button('üí° Financial Insights'):
			A=SchoolAI()
			if _v in st.session_state:A.provider=st.session_state.ai_provider
			if _Y in st.session_state:A.model=st.session_state.ai_model
			if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
			u=C.get_data_by_type(_BL);v=f"""
            Based on this financial data, provide optimization recommendations:
            
            {u}
            
            Include:
            1. Cost reduction strategies
            2. Revenue enhancement opportunities
            3. Budget allocation improvements
            4. Investment priorities
            5. Financial risk management
            """
			with st.spinner(_Cy):
				try:
					N=A.generate_response(v)
					if D in N:st.error(f"{N}")
					else:st.write(N);st.success('Financial analysis completed!')
				except Exception as B:st.error(f"Error generating financial insights: {str(B)}")
	with p:
		st.write('### Infrastructure Planning')
		if st.button('üèóÔ∏è Infrastructure Analysis'):
			A=SchoolAI()
			if _v in st.session_state:A.provider=st.session_state.ai_provider
			if _Y in st.session_state:A.model=st.session_state.ai_model
			if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
			w=C.get_data_by_type(_Bp);x=f"""
            Based on this infrastructure data, analyze needs and provide recommendations:
            
            {w}
            
            Cover:
            1. Facility utilization optimization
            2. Technology infrastructure upgrades
            3. Safety and security improvements
            4. Future expansion planning
            5. Maintenance and sustainability strategies
            """
			with st.spinner('AI assessing infrastructure...'):
				try:
					O=A.generate_response(x)
					if D in O:st.error(f"{O}")
					else:st.write(O);st.success('Infrastructure analysis completed!')
				except Exception as B:st.error(f"Error generating infrastructure analysis: {str(B)}")
	st.subheader('üîç Data Explorer');y,z=st.columns(2)
	with y:
		st.write('### Available Data Types');A0=[_BG,_Bo,_BH,_BI,_BJ,_BK,_BL,_Bp,_Bq];G=st.selectbox('Select data type to preview:',A0)
		if st.button('üîé Preview Selected Data'):
			with st.spinner(f"Loading {G} data..."):
				try:
					A1=C.get_data_by_type(G)
					with st.expander(f"üìã {G.title()} Data Preview"):st.text(A1)
				except Exception as B:st.error(f"Error loading {G} data: {str(B)}")
	with z:
		st.write('### Custom Analysis');E=st.selectbox('Choose analysis focus:',[T,U,V,W,X,Y])
		if st.button('üéØ Run Custom Analysis'):
			A=SchoolAI()
			if _v in st.session_state:A.provider=st.session_state.ai_provider
			if _Y in st.session_state:A.model=st.session_state.ai_model
			if _q in st.session_state:A.ollama_url=st.session_state.ollama_url
			A2={T:_BG,U:_BH,V:_BI,W:_BL,X:_BJ,Y:_BK};A3=C.get_data_by_type(A2[E]);A4=f"""
            Perform a focused {E.lower()} based on this data:
            
            {A3}
            
            Provide detailed insights, actionable recommendations, and specific next steps 
            for school administrators to implement improvements.
            """
			with st.spinner(f"Running {E}..."):
				try:
					P=A.generate_response(A4)
					if D in P:st.error(f"{P}")
					else:st.write(f"### {E} Results");st.write(P);st.success(f"{E} completed successfully!")
				except Exception as B:st.error(f"Error running custom analysis: {str(B)}")
	st.subheader('üõ†Ô∏è AI Utilities');A5,A6=st.columns(2)
	with A5:
		if st.button('üîÑ Clear AI Cache'):
			if _CT in st.session_state:del st.session_state.school_ai
			if S in st.session_state:del st.session_state.last_ai_analysis
			st.success('AI cache cleared successfully!')
	with A6:
		if st.button('üì§ Export AI Results'):
			if S in st.session_state:st.download_button(label='üíæ Download Analysis',data=st.session_state.last_ai_analysis,file_name='ai_school_analysis.txt',mime='text/plain')
			else:st.info('No analysis available to export. Generate an analysis first.')
	st.subheader('üí¨ AI Assistant Chat')
	if'chat_history'not in st.session_state:st.session_state.chat_history=[]
	for Q in st.session_state.chat_history:
		if Q[_At]=='user':st.write(f"**You:** {Q[_Aa]}")
		else:st.write(f"**AI Assistant:** {Q[_Aa]}")
	R=st.chat_input('Ask the AI Assistant anything about your school...')
	if R:
		st.session_state.chat_history.append({_At:'user',_Aa:R});H=SchoolAI()
		if _v in st.session_state:H.provider=st.session_state.ai_provider
		if _Y in st.session_state:H.model=st.session_state.ai_model
		if _q in st.session_state:H.ollama_url=st.session_state.ollama_url
		A7=C.get_data_by_type(_Bq);A8=f"""You are an AI assistant for a comprehensive school management system. 
        Here is the current school data for context:
        
        {A7}
        
        Provide helpful, accurate, and actionable advice for school administrators based on this real data."""
		with st.spinner('AI is thinking...'):
			try:A9=H.generate_response(R,A8);st.session_state.chat_history.append({_At:Z,_Aa:A9})
			except Exception as B:AA=f"I apologize, but I encountered an error: {str(B)}";st.session_state.chat_history.append({_At:Z,_Aa:AA})
		st.rerun()
	if st.button('üóëÔ∏è Clear Chat History'):st.session_state.chat_history=[];st.rerun()
def data_input_page():
	'Page for manual data input for students, teachers, courses, grades, attendance, and finance';Bj='‚ùå No data was restored. Please check the backup file format.';Bi='**Restored tables:**';Bh='Excel Workbook';Bg='JSON Export';Bf='SQLite Database (.db)';Be='SELECT * FROM teachers';Bd='Failed';Bc='Completed';Bb='Refund';Ba='Donation';BZ='formatted_amount';BY='Status*';BX='Excused';BW='Absent';BV='Present';BU='Select a student';BT='Student*';BS='teacher_name';BR='Grade Level*';BA='Replace existing data';B9='Student Name';B8='original_grades_df';B7='course_name';B6='Select course to delete...';Ad='Selected Tables';Ac='NaT';Ab='transactions_to_delete';Aa='confirm_delete';AO='Complete Database';AN='finance';AM='grades';AL='courses';AK='teachers';AJ='delete';AI='is_class_teacher';AH='coerce';AA='Financial Transactions';A9='Grades';A8='Courses';A7='dynamic';r='schedule';i='description';h='attendance_id';g='credits';W='student_name';S='amount';R='transaction_id';Q='grade_id';I='hire_date';H='course_id';G='teacher_id';st.header(_CW);B=st.session_state.school_manager;Bk,Bl,Bm,Bn,Bo,Bp,Bq=st.tabs(['üë®\u200düéì Students',_CV,'üìö Courses','üìù Grades',_Cc,'üí∞ Financial Transactions','üìÅ Bulk Operations'])
	with Bk:
		st.subheader('Students Management');K=B.get_all_students()
		if K:
			st.write('**Existing Students:**');AP=pd.DataFrame(K)
			if _r in AP.columns:AP[_r]=pd.to_datetime(AP[_r],errors=AH).dt.date
			N={_C:st.column_config.TextColumn(_Cs,disabled=_A),_E:st.column_config.TextColumn(_P,required=_A),_Z:st.column_config.NumberColumn(_AS,min_value=3,max_value=25),_H:st.column_config.SelectboxColumn(_f,options=[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]),_G:st.column_config.NumberColumn(_h,min_value=_D,max_value=4.),_K:st.column_config.NumberColumn(_Ct,min_value=_D,max_value=1e2),_U:st.column_config.NumberColumn(_BS,min_value=_D,max_value=1e2),_AB:st.column_config.TextColumn(_C2),_A9:st.column_config.TextColumn('Medical Info'),_r:st.column_config.DateColumn(_C3),_I:st.column_config.SelectboxColumn(_o,options=[_n,_BT])};Br=st.data_editor(AP,column_config=N,num_rows=A7,use_container_width=_A,key='students_editor')
			if st.button('üíæ Save Student Changes',key='save_students'):
				try:
					for(s,A)in Br.iterrows():Bs=A[_r].strftime(_M)if pd.notna(A[_r])else _B;D='\n                            UPDATE students SET name=?, age=?, grade=?, gpa=?, attendance_rate=?, \n                            behavior_score=?, parent_contact=?, medical_info=?, admission_date=?, status=?\n                            WHERE student_id=?\n                        ';E=A[_E],A[_Z],A[_H],A[_G],A[_K],A[_U],A[_AB],A[_A9],Bs,A[_I],A[_C];B.db.execute_update(D,E)
					st.success('‚úÖ Student records updated successfully!');st.rerun()
				except Exception as C:st.error(f"‚ùå Error updating students: {str(C)}")
		else:st.info('No students found. Use the form below to add new students.')
		with st.expander('‚ûï Add New Student',expanded=_F):
			with st.form('new_student_form'):
				L=st.text_input(_Cj,placeholder='Enter student name');Bt=st.number_input('Age*',min_value=3,max_value=25,value=6);Bu=st.selectbox(BR,[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]);Bv=st.number_input(_h,min_value=_D,max_value=4.,value=_D);Bw=st.number_input(_B1,min_value=_D,max_value=1e2,value=1e2);Bx=st.number_input(_BS,min_value=_D,max_value=1e2,value=1e2);By=st.text_input(_C2,placeholder=_Ck);Bz=st.text_area(_Bz,placeholder='Any medical conditions or notes');t=st.date_input(_C3,value=datetime.now());U=st.form_submit_button('‚ûï Add Student')
				if U and L:
					X=str(uuid.uuid4())[:8];B_=Student(student_id=X,name=L,age=Bt,grade=Bu,admission_date=t.strftime(_M),gpa=Bv,attendance_rate=Bw,behavior_score=Bx,parent_contact=By,medical_info=Bz)
					try:B._save_student(B_);st.success(f"‚úÖ Student {L} added successfully! ID: {X}");st.rerun()
					except Exception as C:st.error(f"‚ùå Error adding student: {str(C)}")
	with Bl:
		st.subheader('Teachers Management');Y=B.db.execute_query('SELECT * FROM teachers ORDER BY name')
		if Y:
			st.write('**Existing Teachers:**');j=pd.DataFrame(Y,columns=[G,_E,_AY,_A4,I,_p,_x,_I,AI]);j[I]=pd.to_datetime(j[I],errors=AH).dt.strftime(_M);j[I]=j[I].fillna('');j[AI]=j[AI].astype(bool);N={G:st.column_config.TextColumn(_AI,disabled=_A),_E:st.column_config.TextColumn(_P,required=_A),_AY:st.column_config.TextColumn(_m),_A4:st.column_config.TextColumn(_Q),I:st.column_config.TextColumn(_C5,help='Format: YYYY-MM-DD'),_p:st.column_config.NumberColumn(_AV,min_value=0,max_value=100,step=.1),_x:st.column_config.NumberColumn(_C4,min_value=0,step=100),_I:st.column_config.SelectboxColumn(_o,options=[_n,_BT,'on_leave']),AI:st.column_config.CheckboxColumn(_A3,help='Is this teacher a class teacher?')};AQ=st.data_editor(j,column_config=N,num_rows=A7,use_container_width=_A,key='teachers_data_editor');O,T=st.columns(2)
			with O:
				if st.button('üíæ Save Teacher Changes',key='save_teacher_changes'):
					try:
						for(BB,A)in AQ.iterrows():
							if I in A and A[I]and A[I].strip():
								try:datetime.strptime(A[I],_M)
								except ValueError:st.error(f"‚ùå Invalid date format in row {BB+1}. Use YYYY-MM-DD format.");st.stop()
						for(BB,A)in AQ.iterrows():
							if G in A:C0='\n                                    UPDATE teachers \n                                    SET name=?, subject=?, department=?, hire_date=?, \n                                        performance_score=?, salary=?, status=?, is_class_teacher=?\n                                    WHERE teacher_id=?\n                                ';Ae=1 if A[AI]else 0;E=A[_E],A[_AY],A[_A4],A[I],A[_p],A[_x],A[_I],Ae,A[G];B.db.execute_update(C0,E)
						st.success('‚úÖ Teacher data updated successfully!');st.rerun()
					except Exception as C:st.error(f"‚ùå Error updating teacher data: {str(C)}")
			with T:
				if st.button('üóëÔ∏è Delete Selected Records',key='delete_teachers'):
					C1=set(j[G].tolist());C2=set(AQ[G].tolist())if not AQ.empty else set();Af=C1-C2
					if Af:
						try:
							for Z in Af:u='DELETE FROM teachers WHERE teacher_id=?';B.db.execute_update(u,(Z,))
							st.success(f"‚úÖ {len(Af)} teacher record(s) deleted successfully!");st.rerun()
						except Exception as C:st.error(f"‚ùå Error deleting teacher records: {str(C)}")
					else:st.warning('‚ö†Ô∏è No records selected for deletion. Remove rows from the table above to delete them.')
		else:st.info('No teachers found. Use the form below to add new teachers.')
		with st.expander(_Cm,expanded=_F):
			with st.form('new_teacher_form'):
				e=st.text_input('Teacher Name*',placeholder='Enter teacher name');BC=st.text_input('Subject*',placeholder='e.g., Mathematics');BD=st.text_input('Department*',placeholder='e.g., STEM');C3=st.number_input(_C4,min_value=_D,value=_D);C4=st.number_input(_AV,min_value=_D,max_value=1e2,value=1e2);v=st.date_input(_C5,value=datetime.now());C5=st.checkbox(_C7,value=_F);U=st.form_submit_button(_Co)
				if U and e and BC and BD:
					Z=str(uuid.uuid4())[:8];D='\n                        INSERT INTO teachers (teacher_id, name, subject, department, hire_date, \n                                            performance_score, salary, status, is_class_teacher)\n                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n                    ';Ae=1 if C5 else 0;E=Z,e,BC,BD,v.strftime(_M),C4,C3,_n,Ae
					try:B.db.execute_update(D,E);st.success(f"‚úÖ Teacher {e} added successfully! ID: {Z}");st.rerun()
					except Exception as C:st.error(f"‚ùå Error adding teacher: {str(C)}")
	with Bm:
		st.subheader('Courses Management');C6='\n            SELECT c.course_id, c.name, c.teacher_id, t.name as teacher_name, \n                   c.grade_level, c.credits, c.schedule\n            FROM courses c\n            LEFT JOIN teachers t ON c.teacher_id = t.teacher_id\n            ORDER BY c.name\n        ';k=B.db.execute_query(C6)
		if k:
			st.write('**Existing Courses:**');C7=pd.DataFrame(k,columns=[H,_E,G,BS,_A8,g,r]);AR=C7[[H,_E,G,_A8,g,r]].copy();Y=B.db.execute_query(_Ag);AS={A[1]:A[0]for A in Y};C8={A[0]:A[1]for A in Y};AR[G]=AR[G].map(C8);N={H:st.column_config.TextColumn(_C8,disabled=_A),_E:st.column_config.TextColumn(_BW,required=_A),G:st.column_config.SelectboxColumn(_B6,options=list(AS.keys()),help='Select the teacher for this course'),_A8:st.column_config.SelectboxColumn(_A1,options=[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]),g:st.column_config.NumberColumn(_C9,min_value=1,max_value=10),r:st.column_config.TextColumn(_B7)};C9=st.data_editor(AR,column_config=N,num_rows=A7,use_container_width=_A,key='courses_editor');O,T,BE=st.columns([1,1,2])
			with O:
				if st.button('üíæ Save Course Changes',key='save_courses'):
					try:
						for(s,A)in C9.iterrows():e=A[G];Z=AS[e];D='\n                                UPDATE courses SET name=?, teacher_id=?, grade_level=?, credits=?, schedule=?\n                                WHERE course_id=?\n                            ';E=A[_E],Z,A[_A8],A[g],A[r],A[H];B.db.execute_update(D,E)
						st.success('‚úÖ Course records updated successfully!');st.rerun()
					except Exception as C:st.error(f"‚ùå Error updating courses: {str(C)}")
			with T:
				A1=[B6]+[f"{A[_E]} (ID: {A[H]})"for(B,A)in AR.iterrows()]
				with st.form('delete_course_form'):
					AT=st.selectbox('Choose course to delete:',options=A1,key='course_delete_select');BF=st.checkbox('‚ö†Ô∏è I confirm I want to delete this course');Ag=st.form_submit_button('üóëÔ∏è Delete Course',type=_Bc)
					if Ag and AT!=B6 and BF:
						try:
							BG=AT.split('ID: ')[1].rstrip(')');BH=AT.split(' (ID:')[0]
							try:
								Ah=B.db.execute_query('SELECT COUNT(*) FROM enrollments WHERE course_id = ?',(BG,))
								if Ah and Ah[0][0]>0:st.error(f"‚ùå Cannot delete course '{BH}'. It has {Ah[0][0]} enrolled students. Remove enrollments first.");return
							except Exception:pass
							u='DELETE FROM courses WHERE course_id = ?';B.db.execute_update(u,(BG,));st.success(f"‚úÖ Course '{BH}' deleted successfully!");st.rerun()
						except Exception as C:st.error(f"‚ùå Error deleting course: {str(C)}")
					elif Ag and AT==B6:st.warning('‚ö†Ô∏è Please select a course to delete.')
					elif Ag and not BF:st.warning('‚ö†Ô∏è Please check the confirmation box to delete the course.')
		else:st.info('No courses found. Use the form below to add new courses.')
		with st.expander(_Cp,expanded=_F):
			Y=B.db.execute_query(_Ag);AS=[_BX]+[A[1]for A in Y];CA={A[1]:A[0]for A in Y}
			with st.form('new_course_form'):
				w=st.text_input('Course Name*',placeholder='e.g., Algebra I');e=st.selectbox('Teacher*',AS,help='Select a teacher for this course');CB=st.selectbox(BR,[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]);credits=st.number_input('Credits*',min_value=1,max_value=10,value=3);CC=st.text_input(_B7,placeholder='e.g., Mon/Wed 9:00-10:00');U=st.form_submit_button('‚ûï Add Course')
				if U:
					if not w:st.error('‚ùå Please enter a course name.')
					elif e==_BX:st.error('‚ùå Please select a teacher.')
					else:
						A2=str(uuid.uuid4())[:8];Z=CA[e];A3=Course(course_id=A2,name=w,teacher_id=Z,grade_level=CB,credits=credits,schedule=CC);D=_Cq;E=A3.course_id,A3.name,A3.teacher_id,A3.grade_level,A3.credits,A3.schedule
						try:B.db.execute_update(D,E);st.success(f"‚úÖ Course '{w}' assigned to '{e}' added successfully! ID: {A2}");st.rerun()
						except Exception as C:st.error(f"‚ùå Error adding course: {str(C)}")
	with Bn:
		st.subheader('Grades Management');CD='\n            SELECT g.grade_id, g.student_id, s.name as student_name, \n                   g.course_id, c.name as course_name, g.grade, g.semester, g.year\n            FROM grades g\n            LEFT JOIN students s ON g.student_id = s.student_id\n            LEFT JOIN courses c ON g.course_id = c.course_id\n            ORDER BY g.year DESC, g.semester, s.name\n        ';AU=B.db.execute_query(CD)
		if AU:
			st.write('**Existing Grades:**');BI=pd.DataFrame(AU,columns=[Q,_C,W,H,B7,_H,_A6,_A0])
			if B8 not in st.session_state:st.session_state.original_grades_df=BI.copy()
			K=B.get_all_students();J={A[_E]:A[_C]for A in K};k=B.db.execute_query(_BY);A1={A[1]:A[0]for A in k};N={Q:st.column_config.TextColumn('Grade ID',disabled=_A),_C:st.column_config.SelectboxColumn(_AG,options=J),W:st.column_config.TextColumn(B9,disabled=_A),H:st.column_config.SelectboxColumn(_BZ,options=A1),B7:st.column_config.TextColumn(_BW,disabled=_A),_H:st.column_config.NumberColumn(_f,min_value=_D,max_value=1e2),_A6:st.column_config.TextColumn(_B8),_A0:st.column_config.NumberColumn('Year',min_value=2000,max_value=2100)};BJ=st.data_editor(BI,column_config=N,num_rows=A7,use_container_width=_A,key='grades_editor')
			if st.button('üíæ Save Grade Changes',key='save_grades'):
				try:
					BK=set(st.session_state.original_grades_df[Q].tolist());CE=set(BJ[Q].tolist());CF=BK-CE
					for AB in CF:u='DELETE FROM grades WHERE grade_id = ?';B.db.execute_update(u,(AB,))
					for(s,A)in BJ.iterrows():
						if A[Q]in BK:D='\n                                UPDATE grades SET student_id=?, course_id=?, grade=?, semester=?, year=?\n                                WHERE grade_id=?\n                            ';E=A[_C],A[H],A[_H],A[_A6],A[_A0],A[Q];B.db.execute_update(D,E)
						else:CG=_Cr;E=A[Q],A[_C],A[H],A[_H],A[_A6],A[_A0];B.db.execute_update(CG,E)
					if B8 in st.session_state:del st.session_state.original_grades_df
					st.success('‚úÖ Grade records updated successfully!');st.rerun()
				except Exception as C:st.error(f"‚ùå Error updating grades: {str(C)}")
		else:st.info('No grades found. Use the form below to add new grades.')
		with st.expander('‚ûï Add New Grade',expanded=_F):
			K=B.get_all_students();J={A[_E]:A[_C]for A in K};k=B.db.execute_query(_BY);A1={A[1]:A[0]for A in k}
			with st.form('new_grade_form'):
				L=st.selectbox(BT,list(J.keys()),help=BU);w=st.selectbox('Course*',list(A1.keys()),help='Select a course');CH=st.number_input('Grade*',min_value=_D,max_value=1e2,value=_D);BL=st.text_input('Semester*',placeholder='e.g., Fall 2025');CI=st.number_input('Year*',min_value=2000,max_value=2100,value=datetime.now().year);U=st.form_submit_button('‚ûï Add Grade')
				if U and L and w and BL:
					AB=str(uuid.uuid4())[:8];X=J[L];A2=A1[w];D='\n                        INSERT INTO grades (grade_id, student_id, course_id, grade, semester, year)\n                        VALUES (?, ?, ?, ?, ?, ?)\n                    ';E=AB,X,A2,CH,BL,CI
					try:
						B.db.execute_update(D,E);st.success(f"‚úÖ Grade added for {L} in {w}!")
						if B8 in st.session_state:del st.session_state.original_grades_df
						st.rerun()
					except Exception as C:st.error(f"‚ùå Error adding grade: {str(C)}")
	with Bo:
		st.subheader('Attendance Management');CJ='\n                SELECT a.attendance_id, a.student_id, s.name as student_name, \n                       a.date, a.status\n                FROM attendance a\n                LEFT JOIN students s ON a.student_id = s.student_id\n                ORDER BY a.date DESC, s.name\n            ';AV=B.db.execute_query(CJ)
		if AV:
			st.write('**Existing Attendance Records:**');Ai=pd.DataFrame(AV,columns=[h,_C,W,_L,_I]);Ai[_L]=pd.to_datetime(Ai[_L],errors=AH).dt.date;K=B.get_all_students();J={A[_E]:A[_C]for A in K};N={h:st.column_config.TextColumn('Attendance ID',disabled=_A),_C:st.column_config.SelectboxColumn(_AG,options=J),W:st.column_config.TextColumn(B9,disabled=_A),_L:st.column_config.DateColumn(_AU),_I:st.column_config.SelectboxColumn(_o,options=[BV,BW,'Tardy',BX])};CK=st.data_editor(Ai,column_config=N,num_rows=A7,use_container_width=_A,key='attendance_editor')
			if st.button('üíæ Save Attendance Changes',key='save_attendance'):
				try:
					for(s,A)in CK.iterrows():CL=A[_L].strftime(_M)if A[_L]else _B;D='\n                                UPDATE attendance SET student_id=?, date=?, status=?\n                                WHERE attendance_id=?\n                            ';E=A[_C],CL,A[_I],A[h];B.db.execute_update(D,E)
					st.success('‚úÖ Attendance records updated successfully!');st.rerun()
				except Exception as C:st.error(f"‚ùå Error updating attendance: {str(C)}")
		else:st.info('No attendance records found. Use the form below to add new records.')
		with st.expander('‚ûï Add Attendance Record',expanded=_F):
			K=B.get_all_students();J={A[_E]:A[_C]for A in K}
			with st.form('new_attendance_form'):
				L=st.selectbox(BT,list(J.keys()),help=BU);l=st.date_input('Date*',value=datetime.now());CM=st.selectbox(BY,[BV,BW,'Tardy',BX]);U=st.form_submit_button('‚ûï Add Attendance')
				if U and L:
					Aj=str(uuid.uuid4())[:8];X=J[L];D='\n                            INSERT INTO attendance (attendance_id, student_id, date, status)\n                            VALUES (?, ?, ?, ?)\n                        ';E=Aj,X,l.strftime(_M),CM
					try:B.db.execute_update(D,E);st.success(f"‚úÖ Attendance recorded for {L} on {l.strftime(_M)}!");st.rerun()
					except Exception as C:st.error(f"‚ùå Error adding attendance: {str(C)}")
	with Bp:
		st.subheader('Financial Transactions Management');O,T=st.columns([1,3])
		with O:Ak={_Ba:'‚Çµ',_Cu:'$','‚Ç¨ (Euro)':'‚Ç¨',_Cv:'¬£',_Cw:'‚Ç¶'};BM=st.selectbox('Currency',list(Ak.keys()),index=0 if _CA not in st.session_state else list(Ak.keys()).index(st.session_state.get(_CA,_Ba)),help='Select currency for display and new transactions',key='currency_selector');a=Ak[BM];st.session_state.selected_currency_name=BM;st.session_state.currency_symbol=a
		CN='\n            SELECT f.transaction_id, f.student_id, s.name as student_name, \n                   f.amount, f.type, f.description, f.date, f.status\n            FROM finance f\n            LEFT JOIN students s ON f.student_id = s.student_id\n            ORDER BY f.date DESC\n        ';AW=B.db.execute_query(CN)
		if AW:
			st.write('**Existing Financial Transactions:**');b=pd.DataFrame(AW,columns=[R,_C,W,S,_w,i,_L,_I]);b[AJ]=_F;b[BZ]=b[S].apply(lambda x:f"{a}{x:,.2f}"if pd.notnull(x)else f"{a}0.00")
			try:b[_L]=pd.to_datetime(b[_L]).dt.date
			except Exception:st.warning('Date conversion issue. Date column will be text-editable.')
			K=B.get_all_students();J={A[_E]:A[_C]for A in K};J['None']=_B;N={AJ:st.column_config.CheckboxColumn('Delete',help='Check to mark for deletion'),R:st.column_config.TextColumn('Transaction ID',disabled=_A),_C:st.column_config.SelectboxColumn(_AG,options=J),W:st.column_config.TextColumn(B9,disabled=_A),S:st.column_config.NumberColumn(f"Amount ({a})",min_value=_D,format=f"{a}%.2f"),BZ:_B,_w:st.column_config.SelectboxColumn(_AX,options=[_Bt,'Fee',Ba,Bb,'Other']),i:st.column_config.TextColumn(_Bb),_I:st.column_config.SelectboxColumn(_o,options=[_Ao,Bc,Bd])}
			if b[_L].dtype=='object'and not b[_L].astype(str).str.match('\\d{4}-\\d{2}-\\d{2}').all():N[_L]=st.column_config.TextColumn('Date (YYYY-MM-DD)')
			else:N[_L]=st.column_config.DateColumn(_AU)
			CO=[AJ,R,_C,W,S,_w,i,_L,_I];b=b[CO];A4=st.data_editor(b,column_config=N,num_rows=A7,use_container_width=_A,key='transactions_editor');O,T=st.columns([1,1])
			with O:
				if st.button('üíæ Save Transaction Changes',key='save_transactions'):
					try:
						CP=A4[~A4[AJ]]
						for(s,A)in CP.iterrows():
							AX=A[_L]
							if isinstance(AX,str):
								try:datetime.strptime(AX,_M);BN=AX
								except ValueError:st.error(f"Invalid date format in row {s+1}. Please use YYYY-MM-DD format.");continue
							else:BN=AX.strftime(_M)
							D='\n                                UPDATE finance SET student_id=?, amount=?, type=?, description=?, date=?, status=?\n                                WHERE transaction_id=?\n                            ';E=A[_C],A[S],A[_w],A[i],BN,A[_I],A[R];B.db.execute_update(D,E)
						st.success('‚úÖ Transaction records updated successfully!');st.rerun()
					except Exception as C:st.error(f"‚ùå Error updating transactions: {str(C)}")
			with T:
				AC=A4[A4[AJ]]
				if not AC.empty:
					if st.button(f"üóëÔ∏è Delete Selected ({len(AC)} items)",key='delete_transactions',type=_Bc):st.session_state.transactions_to_delete=AC[R].tolist();st.session_state.confirm_delete=_A
				else:st.button('üóëÔ∏è Delete Selected (0 items)',key='delete_transactions_disabled',disabled=_A)
			if st.session_state.get(Aa,_F):
				Al=st.session_state.get(Ab,[]);AC=A4[A4[R].isin(Al)];st.warning(f"‚ö†Ô∏è Are you sure you want to delete {len(Al)} transaction(s)? This action cannot be undone.");st.write('**Transactions to be deleted:**');Am=AC[[R,W,S,_w,i,_L]].copy();Am[S]=Am[S].apply(lambda x:f"{a}{x:,.2f}");st.dataframe(Am,use_container_width=_A);CQ,CR=st.columns(2)
				with CQ:
					if st.button('‚úÖ Confirm Delete',key='confirm_delete_btn',type=_AW):
						try:
							BO=0
							for AD in Al:u='DELETE FROM finance WHERE transaction_id = ?';B.db.execute_update(u,(AD,));BO+=1
							st.success(f"‚úÖ Successfully deleted {BO} transaction(s)!")
							if Aa in st.session_state:del st.session_state.confirm_delete
							if Ab in st.session_state:del st.session_state.transactions_to_delete
							st.rerun()
						except Exception as C:
							st.error(f"‚ùå Error deleting transactions: {str(C)}")
							if Aa in st.session_state:del st.session_state.confirm_delete
							if Ab in st.session_state:del st.session_state.transactions_to_delete
				with CR:
					if st.button('‚ùå Cancel',key='cancel_delete_btn'):
						if Aa in st.session_state:del st.session_state.confirm_delete
						if Ab in st.session_state:del st.session_state.transactions_to_delete
						st.rerun()
		else:st.info('No financial transactions found. Use the form below to add new transactions.')
		with st.expander(_Cz,expanded=_F):
			K=B.get_all_students();J={A[_E]:A[_C]for A in K}
			with st.form('new_transaction_form'):
				O,T=st.columns(2)
				with O:L=st.selectbox(_AG,list(J.keys()),help='Select a student (optional)');AE=st.number_input(f"Amount* ({a})",min_value=_D,value=_D,format='%.2f');CS=st.selectbox('Type*',[_Bt,'Fee',Ba,Bb,'Other'])
				with T:An=st.text_input('Description*',placeholder='e.g., Tuition payment for Fall 2025');x=st.date_input('Date*',value=datetime.now());CT=st.selectbox(BY,[_Ao,Bc,Bd])
				if AE>0:st.info(f"üí∞ Amount Preview: {a}{AE:,.2f}")
				U=st.form_submit_button(_Cx)
				if U and AE and An:
					AD=str(uuid.uuid4())[:8];X=J[L]if L else _B;CU=f"{An} ({a})";D='\n                        INSERT INTO finance (transaction_id, student_id, amount, type, description, date, status)\n                        VALUES (?, ?, ?, ?, ?, ?, ?)\n                    ';E=AD,X,AE,CS,CU,x.strftime(_M),CT
					try:B.db.execute_update(D,E);st.success(f"‚úÖ Transaction added: {a}{AE:,.2f} - {An}!");st.rerun()
					except Exception as C:st.error(f"‚ùå Error adding transaction: {str(C)}")
	with Bq:
		st.subheader('Bulk Data Operations');CV,CW,CX,CY=st.tabs(['üì§ Export Data','üì• Import Data','üíæ Backup','üîÑ Restore'])
		with CV:
			st.write('### Export School Data');m=st.selectbox('Select data to export:',[_J,_AO,A8,A9,_AF,AA,'All Data'])
			if st.button('üîÑ Generate Export Data',key='generate_export'):
				with st.spinner('Preparing data for export...'):
					try:
						if m==_J:P=B.get_all_students();n='students_data'
						elif m==_AO:Y=B.db.execute_query(Be);P=[dict(zip([G,_E,_AY,_A4,I,_p,_x,_I],A))for A in Y];n='teachers_data'
						elif m==A8:k=B.db.execute_query('\n                                    SELECT c.course_id, c.name, c.teacher_id, t.name as teacher_name, \n                                           c.grade_level, c.credits, c.schedule\n                                    FROM courses c\n                                    LEFT JOIN teachers t ON c.teacher_id = t.teacher_id\n                                ');P=[dict(zip([H,_E,G,BS,_A8,g,r],A))for A in k];n='courses_data'
						elif m==A9:AU=B.db.execute_query('\n                                    SELECT g.grade_id, g.student_id, s.name as student_name, \n                                           g.course_id, c.name as course_name, g.grade, g.semester, g.year\n                                    FROM grades g\n                                    LEFT JOIN students s ON g.student_id = s.student_id\n                                    LEFT JOIN courses c ON g.course_id = c.course_id\n                                ');P=[dict(zip([Q,_C,W,H,B7,_H,_A6,_A0],A))for A in AU];n='grades_data'
						elif m==_AF:AV=B.db.execute_query('\n                                    SELECT a.attendance_id, a.student_id, s.name as student_name, a.date, a.status\n                                    FROM attendance a\n                                    LEFT JOIN students s ON a.student_id = s.student_id\n                                ');P=[dict(zip([h,_C,W,_L,_I],A))for A in AV];n='attendance_data'
						elif m==AA:AW=B.db.execute_query('\n                                    SELECT f.transaction_id, f.student_id, s.name as student_name, \n                                           f.amount, f.type, f.description, f.date, f.status\n                                    FROM finance f\n                                    LEFT JOIN students s ON f.student_id = s.student_id\n                                ');P=[dict(zip([R,_C,W,S,_w,i,_L,_I],A))for A in AW];n='finance_data'
						else:
							st.write('**All Data Export - Multiple formats available:**');Ao=B.get_all_students();Ap=B.db.execute_query(Be);Aq=B.db.execute_query('SELECT * FROM courses');Ar=B.db.execute_query('SELECT * FROM grades');As=B.db.execute_query('SELECT * FROM attendance');At=B.db.execute_query('SELECT * FROM finance');o=io.BytesIO()
							with pd.ExcelWriter(o,engine=_Bd)as p:
								if Ao:pd.DataFrame(Ao).to_excel(p,sheet_name=_J,index=_F)
								if Ap:pd.DataFrame(Ap,columns=[G,_E,_AY,_A4,I,_p,_x,_I]).to_excel(p,sheet_name=_AO,index=_F)
								if Aq:pd.DataFrame(Aq,columns=[H,_E,G,_A8,g,r]).to_excel(p,sheet_name=A8,index=_F)
								if Ar:pd.DataFrame(Ar,columns=[Q,_C,H,_H,_A6,_A0]).to_excel(p,sheet_name=A9,index=_F)
								if As:pd.DataFrame(As,columns=[h,_C,_L,_I]).to_excel(p,sheet_name=_AF,index=_F)
								if At:pd.DataFrame(At,columns=[R,_C,S,_w,i,_L,_I]).to_excel(p,sheet_name='Finance',index=_F)
							AF=o.getvalue();st.download_button(label='üìä Download Complete Database (Excel)',data=AF,file_name=f"school_complete_data_{datetime.now().strftime(_A7)}.xlsx",mime=_Be);CZ={_AZ:Ao,AK:[dict(zip([G,_E,_AY,_A4,I,_p,_x,_I],A))for A in Ap],AL:[dict(zip([H,_E,G,_A8,g,r],A))for A in Aq],AM:[dict(zip([Q,_C,H,_H,_A6,_A0],A))for A in Ar],_AE:[dict(zip([h,_C,_L,_I],A))for A in As],AN:[dict(zip([R,_C,S,_w,i,_L,_I],A))for A in At]};Au=json.dumps(CZ,indent=2,default=str);st.download_button(label='üìã Download Complete Database (JSON)',data=Au,file_name=f"school_complete_data_{datetime.now().strftime(_A7)}.json",mime=_AQ);return
						if P:
							F=pd.DataFrame(P);O,T,BE=st.columns(3)
							with O:Ca=F.to_csv(index=_F);st.download_button(label=_C_,data=Ca,file_name=f"{n}_{datetime.now().strftime(_A7)}.csv",mime=_Ar)
							with T:o=io.BytesIO();F.to_excel(o,index=_F,engine=_Bd);AF=o.getvalue();st.download_button(label=_D0,data=AF,file_name=f"{n}_{datetime.now().strftime(_A7)}.xlsx",mime=_Be)
							with BE:Au=F.to_json(orient='records',indent=2);st.download_button(label=_D1,data=Au,file_name=f"{n}_{datetime.now().strftime(_A7)}.json",mime=_AQ)
							st.success(f"‚úÖ {m} data prepared for download ({len(P)} records)")
						else:st.warning(f"‚ö†Ô∏è No {m.lower()} data found to export")
					except Exception as C:st.error(f"‚ùå Error preparing export data: {str(C)}")
		with CW:
			st.write('### Import Data from Files');M=st.selectbox('Select data type to import:',[_J,_AO,A8,A9,_AF,AA],key='import_type_select');y=st.file_uploader(f"Choose {M} file to import",type=['csv','xlsx','json'],help='Upload CSV, Excel, or JSON file with the appropriate data structure')
			if y is not _B:
				try:
					if y.name.endswith('.csv'):F=pd.read_csv(y)
					elif y.name.endswith('.xlsx'):F=pd.read_excel(y)
					elif y.name.endswith(_CC):F=pd.read_json(y)
					A5=[]
					if M==_J and _r in F.columns:A5.append(_r)
					elif M==_AO and I in F.columns:A5.append(I)
					elif M in[_AF,AA]and _L in F.columns:A5.append(_L)
					for V in A5:
						if V in F.columns:F[V]=pd.to_datetime(F[V],errors=AH).dt.strftime(_M);F[V]=F[V].fillna('')
					st.write('**Preview of uploaded data:**');st.dataframe(F.head());st.write(f"Total records: {len(F)}");O,T=st.columns(2)
					with O:BP=st.radio('Import mode:',['Add new records',BA])
					with T:Cj=st.checkbox('Validate data before import',value=_A)
					if'replace_confirmed'not in st.session_state:st.session_state.replace_confirmed=_F
					if BP==BA and not st.session_state.replace_confirmed:
						st.warning('‚ö†Ô∏è This will replace all existing data!')
						if st.button('‚ö†Ô∏è Confirm Replace',key='confirm_replace'):st.session_state.replace_confirmed=_A;st.rerun()
					elif st.button(f"üì• Import {M} Data",key='import_data_btn'):
						with st.spinner(f"Importing {M.lower()} data..."):
							try:
								Av=0;A6=[]
								if BP==BA and st.session_state.replace_confirmed:Cb={_J:_AZ,_AO:AK,A8:AL,A9:AM,_AF:_AE,AA:AN};B.db.execute_update(f"DELETE FROM {Cb[M]}");st.session_state.replace_confirmed=_F
								for(s,A)in F.iterrows():
									try:
										if M==_J:
											X=str(uuid.uuid4())[:8]if _C not in A or pd.isna(A[_C])else str(A[_C]);t=A.get(_r,datetime.now().strftime(_M))
											if pd.isna(t)or t==''or t==Ac:t=datetime.now().strftime(_M)
											D='\n                                                        INSERT OR REPLACE INTO students \n                                                        (student_id, name, age, grade, admission_date, gpa, attendance_rate, behavior_score, parent_contact, medical_info, status)\n                                                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n                                                    ';E=X,str(A.get(_E,'')),int(float(A.get(_Z,0)))if pd.notna(A.get(_Z,0))else 0,str(A.get(_H,'')),str(t),float(A.get(_G,_D))if pd.notna(A.get(_G,_D))else _D,float(A.get(_K,1e2))if pd.notna(A.get(_K,1e2))else 1e2,float(A.get(_U,1e2))if pd.notna(A.get(_U,1e2))else 1e2,str(A.get(_AB,'')),str(A.get(_A9,'')),str(A.get(_I,_n))
										elif M==_AO:
											Z=str(uuid.uuid4())[:8]if G not in A or pd.isna(A[G])else str(A[G]);v=A.get(I,datetime.now().strftime(_M))
											if pd.isna(v)or v==''or v==Ac:v=datetime.now().strftime(_M)
											D='\n                                                        INSERT OR REPLACE INTO teachers \n                                                        (teacher_id, name, subject, department, hire_date, performance_score, salary, status)\n                                                        VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n                                                    ';E=Z,str(A.get(_E,'')),str(A.get(_AY,'')),str(A.get(_A4,'')),str(v),float(A.get(_p,1e2))if pd.notna(A.get(_p,1e2))else 1e2,float(A.get(_x,_D))if pd.notna(A.get(_x,_D))else _D,str(A.get(_I,_n))
										elif M==A8:A2=str(uuid.uuid4())[:8]if H not in A or pd.isna(A[H])else str(A[H]);D='\n                                                        INSERT OR REPLACE INTO courses \n                                                        (course_id, name, teacher_id, grade_level, credits, schedule)\n                                                        VALUES (?, ?, ?, ?, ?, ?)\n                                                    ';E=A2,str(A.get(_E,'')),str(A.get(G,'')),str(A.get(_A8,'')),int(float(A.get(g,0)))if pd.notna(A.get(g,0))else 0,str(A.get(r,''))
										elif M==A9:AB=str(uuid.uuid4())[:8]if Q not in A or pd.isna(A[Q])else str(A[Q]);D='\n                                                        INSERT OR REPLACE INTO grades \n                                                        (grade_id, student_id, course_id, grade, semester, year)\n                                                        VALUES (?, ?, ?, ?, ?, ?)\n                                                    ';E=AB,str(A.get(_C,'')),str(A.get(H,'')),str(A.get(_H,'')),str(A.get(_A6,'')),int(float(A.get(_A0,datetime.now().year)))if pd.notna(A.get(_A0,datetime.now().year))else datetime.now().year
										elif M==_AF:
											Aj=str(uuid.uuid4())[:8]if h not in A or pd.isna(A[h])else str(A[h]);l=A.get(_L,datetime.now().strftime(_M))
											if pd.isna(l)or l==''or l==Ac:l=datetime.now().strftime(_M)
											D='\n                                                        INSERT OR REPLACE INTO attendance \n                                                        (attendance_id, student_id, date, status)\n                                                        VALUES (?, ?, ?, ?)\n                                                    ';E=Aj,str(A.get(_C,'')),str(l),str(A.get(_I,'present'))
										elif M==AA:
											AD=str(uuid.uuid4())[:8]if R not in A or pd.isna(A[R])else str(A[R]);x=A.get(_L,datetime.now().strftime(_M))
											if pd.isna(x)or x==''or x==Ac:x=datetime.now().strftime(_M)
											D='\n                                                        INSERT OR REPLACE INTO finance \n                                                        (transaction_id, student_id, amount, type, description, date, status)\n                                                        VALUES (?, ?, ?, ?, ?, ?, ?)\n                                                    ';E=AD,str(A.get(_C,'')),float(A.get(S,_D))if pd.notna(A.get(S,_D))else _D,str(A.get(_w,'')),str(A.get(i,'')),str(x),str(A.get(_I,_BQ))
										B.db.execute_update(D,E);Av+=1
									except Exception as Cc:A6.append(f"Row {s+1}: {str(Cc)}")
								if Av>0:st.success(f"‚úÖ Successfully imported {Av} {M.lower()} records!")
								if A6:
									st.warning(f"‚ö†Ô∏è {len(A6)} rows had errors:")
									for Cd in A6[:5]:st.write(f"‚Ä¢ {Cd}")
									if len(A6)>5:st.write(f"... and {len(A6)-5} more errors")
								st.rerun()
							except Exception as C:st.error(f"‚ùå Import failed: {str(C)}")
				except Exception as C:st.error(f"‚ùå Error reading file: {str(C)}")
		with CX:
			st.write('### Database Backup');Aw=st.radio('Backup type:',[AO,Ad])
			if Aw==Ad:BQ=st.multiselect('Select tables to backup:',[_AZ,AK,AL,AM,_AE,AN])
			Ax=st.selectbox('Backup format:',[Bf,Bg,Bh])
			if st.button('üíæ Create Backup'):
				with st.spinner('Creating backup...'):
					try:
						AY=datetime.now().strftime(_A7)
						if Ax==Bf:
							Ce=f"school_backup_{AY}.db"
							with open(B.db.db_path,'rb')as Ay:Cf=Ay.read()
							st.download_button(label='üì• Download Database Backup',data=Cf,file_name=Ce,mime='application/octet-stream')
						elif Ax==Bg:
							z={};AG=[_AZ,AK,AL,AM,_AE,AN]
							if Aw==Ad:AG=BQ
							for c in AG:
								try:P=B.db.execute_query(f"SELECT * FROM {c}");Az=B.db.execute_query(f"PRAGMA table_info({c})");f=[A[1]for A in Az];z[c]=[dict(zip(f,A))for A in P]
								except Exception as A_:st.warning(f"‚ö†Ô∏è Could not backup table {c}: {str(A_)}");z[c]=[]
							Cg=json.dumps(z,indent=2,default=str);st.download_button(label='üì• Download JSON Backup',data=Cg,file_name=f"school_backup_{AY}.json",mime=_AQ)
						elif Ax==Bh:
							o=io.BytesIO();AG=[_AZ,AK,AL,AM,_AE,AN]
							if Aw==Ad:AG=BQ
							with pd.ExcelWriter(o,engine=_Bd)as p:
								for c in AG:
									try:
										P=B.db.execute_query(f"SELECT * FROM {c}")
										if P:Az=B.db.execute_query(f"PRAGMA table_info({c})");f=[A[1]for A in Az];F=pd.DataFrame(P,columns=f);F.to_excel(p,sheet_name=c.capitalize(),index=_F)
									except Exception as A_:st.warning(f"‚ö†Ô∏è Could not backup table {c}: {str(A_)}")
							AF=o.getvalue();st.download_button(label='üì• Download Excel Backup',data=AF,file_name=f"school_backup_{AY}.xlsx",mime=_Be)
						st.success(f"‚úÖ Backup created successfully! Timestamp: {AY}");st.info('üí° Store your backup file in a safe location')
					except Exception as C:st.error(f"‚ùå Backup failed: {str(C)}")
		with CY:
			st.write('### Database Restore');st.warning('‚ö†Ô∏è **Warning**: Restoring will replace current data. Make sure to backup first!');B0=st.radio('Restore mode:',[AO,'Merge with Existing Data']);d=st.file_uploader('Choose backup file to restore',type=['db','json','xlsx'],help='Upload a .db database file, .json backup file, or .xlsx Excel backup')
			if d is not _B:
				st.write('**Backup file details:**');st.write(f"‚Ä¢ Filename: {d.name}");st.write(f"‚Ä¢ Size: {len(d.getvalue())} bytes");Ch=st.checkbox('I understand this will modify/replace current data')
				if Ch and st.button('üîÑ Restore from Backup'):
					with st.spinner('Restoring from backup...'):
						try:
							if d.name.endswith('.db'):
								if B0==AO:
									z=d.getvalue()
									with open(B.db.db_path,'wb')as Ay:Ay.write(z)
									st.success('‚úÖ Database restored successfully!');st.info('üîÑ Please refresh the page to see the restored data.')
								else:st.error('‚ùå Merge mode not supported for .db files')
							elif d.name.endswith(_CC):
								z=json.loads(d.getvalue().decode('utf-8'));A0=[]
								for(q,AZ)in z.items():
									if AZ and isinstance(AZ,list):
										try:
											if B0==AO:B.db.execute_update(f"DELETE FROM {q}")
											for B1 in AZ:
												if isinstance(B1,dict):f=list(B1.keys());B2=[str(A)if A is not _B else''for A in B1.values()];B3=_j.join(['?'for A in f]);D=f"INSERT OR REPLACE INTO {q} ({_j.join(f)}) VALUES ({B3})";B.db.execute_update(D,B2)
											A0.append(f"{q} ({len(AZ)} records)")
										except Exception:st.error(f"Failed to restore table: {q}")
								if A0:
									st.success(_CD);st.info(Bi)
									for B4 in A0:st.write(f"‚Ä¢ {B4}")
								else:st.error(Bj)
							elif d.name.endswith('.xlsx'):
								Ci=pd.ExcelFile(d);A0=[]
								for B5 in Ci.sheet_names:
									try:
										F=pd.read_excel(d,sheet_name=B5);q=B5.lower()
										if B0==AO:B.db.execute_update(f"DELETE FROM {q}")
										A5=[I,_r,_L]
										for V in A5:
											if V in F.columns:F[V]=pd.to_datetime(F[V],errors=AH).dt.strftime(_M);F[V]=F[V].fillna('')
										for(_,A)in F.iterrows():f=list(A.index);B2=[str(A)if pd.notna(A)else''for A in A.values];B3=_j.join(['?'for A in f]);D=f"INSERT OR REPLACE INTO {q} ({_j.join(f)}) VALUES ({B3})";B.db.execute_update(D,B2)
										A0.append(f"{q} ({len(F)} records)")
									except Exception:st.error(f"Failed to restore sheet: {B5}")
								if A0:
									st.success(_CD);st.info(Bi)
									for B4 in A0:st.write(f"‚Ä¢ {B4}")
								else:st.error(Bj)
							st.rerun()
						except Exception as C:st.error(f"‚ùå Restore failed: {str(C)}");st.error('Please check that the backup file is valid and not corrupted.')
def streams_page():
	Ab='excess';Aa='current';AZ='Available Spots';AY='Utilization (%)';AX='Capacity per Stream';AW='Current Utilization';AV='Ghanaian Language';AU='Creative Arts';AT='English Language';AS='Stream assignment method not found';AR='assign_student_to_stream';AQ="UPDATE students SET stream_id = NULL WHERE grade = ? AND status = 'active'";AP='Select teacher';AO='Custom Configuration';A6='Streams';v='Total Capacity';j='Error';st.header('üè´ Class Stream Management');C=st.session_state.school_manager
	with st.expander('üîß Stream Configuration',expanded=_F):
		st.subheader('Configure Streams per Grade');Q=st.selectbox('Select Grade to Configure',[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d],key='config_grade_select');L=C.stream_manager.get_streams_config_for_grade(Q);E,F=st.columns([2,1])
		with E:
			st.write(f"**Current streams for {Q}:** {_j.join(L)}");Ac=st.radio('Stream Configuration',['Use Default (R, C, S)',AO],key='stream_config_option')
			if Ac==AO:
				Ad=C.stream_manager.get_available_stream_types();Ae=['A','B','C','D','E','R','C','S','Gold','Silver','Bronze'];Af=list(set(Ad+Ae));b=st.multiselect('Select Stream Types',options=sorted(Af),default=L,help='Select stream types for this grade. Order will be preserved for performance-based assignment.');k=st.text_input('Add Custom Stream Type',placeholder='e.g., Alpha, Beta, Gamma')
				if k and st.button('Add Custom Stream'):
					if k not in b:b.append(k);st.success(f"Added '{k}' to stream types");st.rerun()
				if b:
					st.info(f"Preview: {Q} will have streams: {_j.join(b)}")
					if st.button('Apply Configuration'):
						try:C.stream_manager.set_streams_for_grade(Q,b);st.success(f"Stream configuration updated for {Q}!");st.rerun()
						except Exception as B:st.error(f"Error updating configuration: {B}")
				else:st.warning('Please select at least one stream type')
			elif st.button('Reset to Default (R, C, S)'):
				try:C.stream_manager.set_streams_for_grade(Q,['R','C','S']);st.success(f"Reset {Q} to default streams (R, C, S)!");st.rerun()
				except Exception as B:st.error(f"Error resetting configuration: {B}")
		with F:st.info('\n            **Stream Types Guide:**\n            - **R**: Regular/General\n            - **C**: Commerce/Creative\n            - **S**: Science/Special\n            - **A, B, C**: Alphabetical\n            - **1, 2, 3**: Numerical\n            - Custom names allowed\n            ')
	st.subheader('üöÄ Quick Setup');E,F=st.columns(2)
	with E:
		if st.button('‚ú® Initialize Streams for All Grades (Default)'):
			for G in[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]:C.stream_manager.create_streams_for_grade(G)
			st.success('Default streams (R, C, S) created for all grades!');st.rerun()
	with F:
		if st.button('üîÑ Recreate Streams with Current Config'):
			H=0
			for G in[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]:
				try:C.stream_manager.create_streams_for_grade(G);H+=1
				except Exception as B:st.error(f"Error creating streams for {G}: {B}")
			if H>0:st.success(f"Streams created/updated for {H} grades using stored configurations!");st.rerun()
	st.divider();st.subheader('üìã Stream Management');A=st.selectbox('Select Grade Level',[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d],key='stream_grade_select');I=C.stream_manager.get_streams_for_grade(A);Ag=C.stream_manager.get_streams_config_for_grade(A)
	if not I:
		st.warning(f"No streams exist for {A}");E,F=st.columns(2)
		with E:
			if st.button(f"Create Default Streams for {A}"):C.stream_manager.create_streams_for_grade(A);st.rerun()
		with F:
			if st.button(f"Create Configured Streams for {A}"):C.stream_manager.create_streams_for_grade(A,Ag);st.rerun()
		return
	st.info(f"**{A}** has **{len(I)} streams**: {_j.join([A.stream_type for A in I])} | Class size limit: {C.stream_manager.max_class_size} students");Ah,Ai,Aj,Ak=st.tabs(['üìä Stream Overview','üë• Student Assignment','üë®\u200düè´ Teacher Assignment','‚öôÔ∏è Capacity Management'])
	with Ah:
		for(B9,D)in enumerate(I):
			J=C.stream_manager.get_student_count(D.stream_id);A7=min(100,J/D.max_capacity*100)
			with st.expander(f"{D.stream_id} Stream ({J}/{D.max_capacity} students) - {A7:.1f}% full"):
				E,F,c=st.columns([3,1,1])
				with E:
					st.progress(A7/100);st.caption(f"Capacity: {J}/{D.max_capacity} students");K=C.stream_manager.get_students_in_stream(D.stream_id)
					if K:
						st.write('**Students:**')
						for A8 in K[:10]:st.write(f"- {A8.name} (ID: {A8.student_id})")
						if len(K)>10:st.write(f"... and {len(K)-10} more")
					else:st.info('No students assigned yet')
				with F:
					if _f in A or A==_a:
						A9=C.db.execute_query(_Ag);W={f"{B} ({A})":A for(A,B)in A9};Al=D.class_teacher_id;Am=next((B for(A,B)in A9 if A==Al),_A2);st.write(f"**Class Teacher:** {Am}");d=st.selectbox('Assign Class Teacher',[AP]+list(W.keys()),key=f"teacher_{D.stream_id}")
						if st.button('Assign Teacher',key=f"assign_{D.stream_id}")and d!=AP:An=W[d];C.stream_manager.assign_class_teacher(D.stream_id,An);st.success('Teacher assigned!');st.rerun()
				with c:
					st.write('**Actions:**')
					if len(I)>1:
						if st.button('üóëÔ∏è Delete Stream',key=f"delete_{D.stream_id}"):
							if J>0:
								Ao=st.selectbox('Reassignment method for students:',[_Al,_Ak,_Bl],key=f"reassign_method_{D.stream_id}")
								if st.button('Confirm Delete & Reassign',key=f"confirm_delete_{D.stream_id}"):
									try:C.stream_manager.delete_stream(D.stream_id,Ao);st.success(f"Stream {D.stream_id} deleted and students reassigned!");st.rerun()
									except Exception as B:st.error(f"Error deleting stream: {B}")
							elif st.button('Confirm Delete',key=f"confirm_delete_empty_{D.stream_id}"):
								try:C.stream_manager.delete_stream(D.stream_id);st.success(f"Stream {D.stream_id} deleted!");st.rerun()
								except Exception as B:st.error(f"Error deleting stream: {B}")
					else:st.info('Cannot delete the only stream')
	with Ai:
		st.subheader('Student Assignment')
		try:
			R=C.db.execute_query("SELECT student_id, name, grade \n                   FROM students \n                   WHERE grade = ? AND (stream_id IS NULL OR stream_id = '') AND status = 'active'",(A,));X=C.db.execute_query("SELECT student_id, name, grade \n                   FROM students \n                   WHERE grade = ? AND stream_id IS NOT NULL AND stream_id != '' AND status = 'active'",(A,));E,F=st.columns(2)
			with E:
				if R:
					st.info(f"Found {len(R)} unassigned students in {A}")
					if len(R)<=5:
						st.write('**Unassigned students:**')
						for(e,S,G)in R:st.write(f"- {S} (ID: {e})")
					else:st.write(f"**Unassigned students:** {R[0][1]}, {R[1][1]}, and {len(R)-2} others")
				else:st.success(f"All students in {A} are assigned to streams")
			with F:
				if X:
					st.info(f"Found {len(X)} assigned students in {A}")
					if f"confirm_reset_{A}"not in st.session_state:st.session_state[f"confirm_reset_{A}"]=_F
					if not st.session_state[f"confirm_reset_{A}"]:
						if st.button('üîÑ Reset Student Assignments',key='reset_assignments',type=_Bc,help='This will unassign ALL students in this grade'):st.session_state[f"confirm_reset_{A}"]=_A;st.rerun()
					if st.session_state[f"confirm_reset_{A}"]:
						st.warning(f"‚ö†Ô∏è This will unassign ALL {len(X)} students from their streams in {A}!");Ap,Aq=st.columns(2)
						with Ap:
							if st.button('‚úÖ Confirm Reset',key='confirm_reset',type=_AW):
								try:f=C.db.execute_update(AQ,(A,));st.success(f"Successfully unassigned all students from {A} streams!");st.info("All students are now in the 'Unassigned' category and can be reassigned.");st.session_state[f"confirm_reset_{A}"]=_F;st.rerun()
								except Exception as B:st.error(f"Error resetting student assignments: {B}");st.session_state[f"confirm_reset_{A}"]=_F
						with Aq:
							if st.button('‚ùå Cancel',key='cancel_reset'):st.session_state[f"confirm_reset_{A}"]=_F;st.info('Reset cancelled.');st.rerun()
				else:st.info(f"No assigned students found in {A}")
		except Exception as B:st.error(f"Error checking student assignments: {B}")
		st.divider();Y=st.radio('Assignment Method',[_B_,_C0,_C1],index=2,key='stream_assignment_method',help='Performance-based: Assigns students based on GPA to appropriate streams. Random: Randomly distributes students. Balanced: Fills streams evenly.');AA={_B_:_Ak,_C0:_Bl,_C1:_Al};E,F=st.columns(2)
		with E:
			if st.button(f"Assign Unassigned Students ({Y})",key='assign_unassigned'):
				try:
					AB=C.db.execute_query("SELECT student_id, name, grade \n                           FROM students \n                           WHERE grade = ? AND (stream_id IS NULL OR stream_id = '') AND status = 'active'",(A,))
					if AB:
						H=0;M=0
						for(e,S,G)in AB:
							try:
								if hasattr(C.stream_manager,AR):
									f=C.stream_manager.assign_student_to_stream(e,AA[Y])
									if f:H+=1
									else:M+=1
								else:st.error(AS);break
							except Exception as B:st.error(f"Error assigning {S}: {B}");M+=1
						if H>0:st.success(f"Successfully assigned {H} students using {Y} method!")
						if M>0:st.warning(f"Failed to assign {M} students")
						if H>0:st.rerun()
					else:st.info('No unassigned students found for this grade')
				except Exception as B:st.error(f"Error during student assignment: {B}")
		with F:
			if st.button(f"Reassign ALL Students ({Y})",key='reassign_all'):
				try:
					C.db.execute_update('UPDATE students SET stream_id = NULL WHERE grade = ?',(A,));AC=C.db.execute_query("SELECT student_id, name, grade FROM students WHERE grade = ? AND status = 'active'",(A,))
					if AC:
						H=0;M=0
						for(e,S,G)in AC:
							try:
								if hasattr(C.stream_manager,AR):
									f=C.stream_manager.assign_student_to_stream(e,AA[Y])
									if f:H+=1
									else:M+=1
								else:st.error(AS);break
							except Exception as B:st.error(f"Error reassigning {S}: {B}");M+=1
						if H>0:st.success(f"Successfully reassigned {H} students using {Y} method!")
						if M>0:st.warning(f"Failed to reassign {M} students")
						if H>0:st.rerun()
					else:st.info('No students found for this grade')
				except Exception as B:st.error(f"Error during student reassignment: {B}")
		st.divider();st.subheader('üîÑ Quick Reset Options');Ar,As=st.columns(2)
		with Ar:
			AD=st.text_input(f"Type 'RESET {A}' to confirm unassigning all students:",key='reset_confirmation_text')
			if st.button('Reset All Assignments',key='simple_reset',type=_Bc):
				if AD==f"RESET {A}":
					try:f=C.db.execute_update(AQ,(A,));st.success(f"‚úÖ Successfully reset all student assignments for {A}!");st.info('All students are now unassigned and ready for re-assignment.');st.session_state.reset_confirmation_text='';st.rerun()
					except Exception as B:st.error(f"‚ùå Error resetting assignments: {B}")
				elif AD:st.error(f"Please type exactly: RESET {A}")
				else:st.warning('Please enter the confirmation text above')
		with As:
			try:
				w=C.db.execute_query("SELECT s.name, s.stream_id \n                       FROM students s \n                       WHERE s.grade = ? AND s.stream_id IS NOT NULL AND s.stream_id != '' AND s.status = 'active'\n                       ORDER BY s.stream_id, s.name",(A,))
				if w:
					st.write(f"**Current assignments ({len(w)} students):**");from collections import defaultdict as At;AE=At(list)
					for(S,l)in w:AE[l].append(S)
					for(l,K)in AE.items():
						if len(K)<=3:st.write(f"- **{l}**: {_j.join(K)}")
						else:st.write(f"- **{l}**: {K[0]}, {K[1]}, +{len(K)-2} more")
				else:st.info('No students currently assigned to streams')
			except Exception as B:st.error(f"Error loading current assignments: {B}")
		st.divider();E,F=st.columns(2)
		with E:
			if st.button('‚öñÔ∏è Balance Class Sizes',key='balance_classes'):
				try:
					if hasattr(C.stream_manager,'enforce_class_sizes'):C.stream_manager.enforce_class_sizes(A);st.success('Class sizes balanced across all streams!');st.rerun()
					else:st.error('Class size balancing method not implemented')
				except Exception as B:st.error(f"Error balancing class sizes: {B}")
		with F:
			if st.button('‚ûï Add New Stream',key='add_stream'):
				Au=C.stream_manager.get_streams_config_for_grade(A);x=st.text_input('Enter new stream type (e.g., D, Alpha, etc.)',key='new_stream_input')
				if x and st.button('Create Stream',key='create_new_stream'):
					try:Av=Au+[x];C.stream_manager.set_streams_for_grade(A,Av);C.stream_manager.create_streams_for_grade(A);st.success(f"Stream {x} added to {A}!");st.rerun()
					except Exception as B:st.error(f"Error adding stream: {B}")
	with Aj:
		st.subheader('Subject Teacher Assignment')
		try:AF=C.db.execute_query('SELECT DISTINCT name FROM courses');m=[A[0]for A in AF]if AF else[]
		except Exception as B:
			st.error(f"Error fetching subjects: {B}")
			if'JHS'in A:m=[_B3,AT,_Af,_BU,'Information Communication Technology',AU,_B4,AV,'French']
			else:m=[_B3,AT,_Af,_BU,AU,_B4,AV]
		if m:
			g=st.selectbox('Select Subject',m)
			try:
				n=C.db.execute_query("SELECT DISTINCT t.teacher_id, t.name FROM teachers t JOIN courses c ON t.teacher_id = c.teacher_id WHERE c.name = ? AND t.status = 'active'",(g,))
				if not n:n=C.db.execute_query(_Ag)
			except Exception as B:n=C.db.execute_query(_Ag)
			W={f"{B} ({A})":A for(A,B)in n}
			if W:
				d=st.selectbox(f"Select Teacher for {g}",list(W.keys()))
				if st.button(f"Assign to All {A} Streams"):
					H=0
					for D in I:
						try:C.stream_manager.assign_subject_teacher(D.stream_id,g,W[d]);H+=1
						except AttributeError:st.warning('Subject teacher assignment method not implemented yet');break
						except Exception as B:st.error(f"Error assigning to {D.stream_id}: {B}")
					if H>0:st.success(f"{d} assigned to teach {g} in {H} {A} streams!")
			else:st.warning(f"No teachers available for {g}")
		else:st.warning('No subjects found in the database')
	with Ak:
		st.subheader('‚öôÔ∏è Stream Capacity Management')
		with st.expander('üåç Global Capacity Settings',expanded=_F):
			st.write('**Set default capacity for new streams across the school**');Z=C.stream_manager.default_max_capacity;E,F=st.columns([2,1])
			with E:
				AG=st.number_input('Default Maximum Capacity for New Streams',min_value=1,max_value=100,value=Z,step=1,help='This will be used as the default capacity when creating new streams')
				if st.button('Update Global Default Capacity'):
					try:C.stream_manager.set_global_max_capacity(AG);st.success(f"Global default capacity updated to {AG} students!");st.info('This will apply to all newly created streams. Existing streams are not affected.')
					except Exception as B:st.error(f"Error updating global capacity: {B}")
			with F:st.info(f"""
                    **Current Global Default:**
                    {Z} students per stream
                    
                    **Recommended Ranges:**
                    - Kindergarten: 20-25
                    - Primary: 30-35
                    - JHS: 35-40
                    """)
		st.divider();st.subheader(f"üìã Grade-Specific Capacity: {A}")
		try:
			Aw=C.stream_manager.get_streams_config_for_grade(A);y=Aw[_y];E,F=st.columns([2,1])
			with E:
				st.write(f"**Current capacity for {A}:** {y} students per stream");z=st.number_input(f"Set Maximum Capacity for {A}",min_value=1,max_value=100,value=y,step=1,key=f"capacity_{A}",help=f"This will update the capacity for all streams in {A}");L=C.stream_manager.get_streams_for_grade(A)
				if L:st.info(f"This will affect {len(L)} existing streams: {_j.join([A.stream_id for A in L])}")
				Ax,Ay=st.columns(2)
				with Ax:
					if st.button(f"Update {A} Capacity",key=f"update_capacity_{A}"):
						try:C.stream_manager.set_max_capacity_for_grade(A,z);st.success(f"Capacity for {A} updated to {z} students!");st.rerun()
						except Exception as B:st.error(f"Error updating capacity: {B}")
				with Ay:
					if st.button(f"Reset to Global Default ({Z})",key=f"reset_capacity_{A}"):
						try:C.stream_manager.set_max_capacity_for_grade(A,Z);st.success(f"Capacity for {A} reset to global default ({Z})!");st.rerun()
						except Exception as B:st.error(f"Error resetting capacity: {B}")
			with F:
				if A==_a:o='20-25';p='Younger children need more individual attention'
				elif A in[_R,_S,_T]:o='25-30';p='Lower primary requires smaller class sizes'
				elif A in[_V,_W,_X]:o='30-35';p='Upper primary can handle slightly larger classes'
				else:o='35-40';p='Secondary students can work in larger groups'
				st.info(f"""
                    **Recommended for {A}:**
                    {o} students
                    
                    **Reason:** {p}
                    
                    **Current Setting:** {y}
                    """)
				if L:
					O=sum(C.stream_manager.get_student_count(A.stream_id)for A in L);T=len(L)*z;N=O/T*100 if T>0 else 0;st.metric(AW,f"{N:.1f}%")
					if N>90:st.warning('‚ö†Ô∏è High utilization - consider adding more streams')
					elif N<50:st.info('‚ÑπÔ∏è Low utilization - streams have plenty of space')
		except Exception as B:st.error(f"Error loading capacity configuration: {B}")
		st.divider();st.subheader('üéØ Individual Stream Capacity Override');st.write('Override capacity for specific streams (advanced usage)')
		if I:
			AH={f"{A.stream_id} (Current: {A.max_capacity})":A.stream_id for A in I};AI=st.selectbox('Select Stream to Modify',list(AH.keys()),key='individual_stream_select')
			if AI:
				h=AH[AI];i=next(A for A in I if A.stream_id==h);E,F=st.columns([2,1])
				with E:
					P=C.stream_manager.get_student_count(h);U=st.number_input(f"Capacity for {h}",min_value=max(1,P),max_value=100,value=i.max_capacity,step=1,key='individual_capacity',help=f"Cannot be set below current student count ({P})")
					if U<P:st.warning(f"‚ö†Ô∏è Cannot set capacity below current student count ({P})")
					if st.button('Update Individual Stream Capacity',disabled=U<P):
						try:Az='UPDATE streams SET max_capacity = ? WHERE stream_id = ?';C.db.execute_update(Az,(U,h));st.success(f"Capacity for {h} updated to {U}!");st.rerun()
						except Exception as B:st.error(f"Error updating individual stream capacity: {B}")
				with F:
					N=P/i.max_capacity*100 if i.max_capacity>0 else 0;A_=P/U*100 if U>0 else 0;st.metric(_Ae,P);st.metric('Current Capacity',i.max_capacity);st.metric(AW,f"{N:.1f}%")
					if U!=i.max_capacity:st.write('**After Update:**');st.metric('New Utilization',f"{A_:.1f}%")
		else:st.info('No streams available for individual modification')
		st.divider();st.subheader('üîß Bulk Capacity Operations');E,F=st.columns(2)
		with E:
			st.write('**Apply Recommended Capacities**');st.write('Set all grade levels to their recommended capacity ranges')
			if st.button('Apply All Recommended Capacities'):
				try:
					B0={_a:25,_R:28,_S:28,_T:28,_V:32,_W:32,_X:32,_b:38,_c:38,_d:38};V=0
					for(G,B1)in B0.items():
						try:C.stream_manager.set_max_capacity_for_grade(G,B1);V+=1
						except Exception as B:st.error(f"Error updating {G}: {B}")
					if V>0:st.success(f"Updated capacity for {V} grade levels to recommended values!");st.rerun()
				except Exception as B:st.error(f"Error applying recommended capacities: {B}")
		with F:
			st.write('**Standardize All Capacities**');AJ=st.number_input('Set same capacity for all grades',min_value=1,max_value=100,value=Z,step=1,key='standard_capacity')
			if st.button('Apply to All Grades'):
				try:
					A0=[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d];V=0
					for G in A0:
						try:C.stream_manager.set_max_capacity_for_grade(G,AJ);V+=1
						except Exception as B:st.error(f"Error updating {G}: {B}")
					if V>0:st.success(f"Standardized capacity to {AJ} for {V} grade levels!");st.rerun()
				except Exception as B:st.error(f"Error standardizing capacities: {B}")
		st.divider();st.subheader('üìä Capacity Overview - All Grades')
		try:
			A0=[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d];q=[]
			for G in A0:
				try:AK=C.stream_manager.get_streams_config_for_grade(G);a=C.stream_manager.get_streams_for_grade(G);O=sum(C.stream_manager.get_student_count(A.stream_id)for A in a);T=len(a)*AK[_y]if a else 0;N=O/T*100 if T>0 else 0;q.append({_f:G,A6:len(a),AX:AK[_y],v:T,_Ae:O,AY:f"{N:.1f}%",AZ:max(0,T-O)})
				except Exception as B:q.append({_f:G,A6:0,AX:j,v:j,_Ae:j,AY:j,AZ:j})
			import pandas as r;B2=r.DataFrame(q);st.dataframe(B2,hide_index=_A,use_container_width=_A);E,F,c,A1=st.columns(4);A2=[A for A in q if isinstance(A[_Ae],int)];AL=sum(A[_Ae]for A in A2);A3=sum(A[v]for A in A2);B3=sum(A[A6]for A in A2);B4=AL/A3*100 if A3>0 else 0
			with E:st.metric(_s,AL)
			with F:st.metric(v,A3)
			with c:st.metric(_C6,B3)
			with A1:st.metric(_Cn,f"{B4:.1f}%")
		except Exception as B:st.error(f"Error loading capacity overview: {B}")
		st.divider();st.subheader('‚öñÔ∏è Capacity Enforcement');E,F=st.columns(2)
		with E:
			st.write('**Check for Overcapacity Issues**')
			if st.button('Scan for Overcapacity Streams'):
				try:
					s=[];B5=[_a,_R,_S,_T,_V,_W,_X,_b,_c,_d]
					for G in B5:
						a=C.stream_manager.get_streams_for_grade(G)
						for D in a:
							J=C.stream_manager.get_student_count(D.stream_id)
							if J>D.max_capacity:s.append({_O:D.stream_id,_H:G,Aa:J,_By:D.max_capacity,Ab:J-D.max_capacity})
					if s:
						st.warning(f"Found {len(s)} overcapacity streams:")
						for t in s:st.write(f"- **{t[_O]}**: {t[Aa]}/{t[_By]} ({t[Ab]} excess)")
					else:st.success('‚úÖ All streams are within capacity limits!')
				except Exception as B:st.error(f"Error scanning for overcapacity: {B}")
		with F:
			st.write('**Auto-Rebalance Overcapacity**')
			if st.button('Enforce Capacity Limits'):
				try:C.stream_manager.enforce_class_sizes();st.success('‚úÖ Capacity limits enforced! Excess students have been rebalanced.');st.info('Students from overcapacity streams have been moved to available streams in the same grade.');st.rerun()
				except Exception as B:st.error(f"Error enforcing capacity limits: {B}")
		st.divider();st.subheader('üìä Stream Statistics')
		try:
			O=C.db.execute_query("SELECT COUNT(*) FROM students WHERE grade = ? AND status = 'active'",(A,))[0][0];X=C.db.execute_query("SELECT COUNT(*) FROM students WHERE grade = ? AND stream_id IS NOT NULL AND stream_id != '' AND status = 'active'",(A,))[0][0];E,F,c,A1=st.columns(4)
			with E:st.metric(_s,O)
			with F:st.metric('Assigned Students',X)
			with c:st.metric('Unassigned Students',O-X)
			with A1:st.metric('Number of Streams',len(I))
			if I:
				st.write('**Per-Stream Breakdown:**');AM=[]
				for D in I:J=C.stream_manager.get_student_count(D.stream_id);N=J/D.max_capacity*100;AM.append({_Aq:D.stream_id,_AX:D.stream_type,_J:J,'Capacity':D.max_capacity,_Bw:f"{N:.1f}%"})
				import pandas as r;B6=r.DataFrame(AM);st.dataframe(B6,hide_index=_A)
		except Exception as B:st.error(f"Error loading statistics: {B}")
		with st.expander('üåç School-wide Stream Statistics'):
			try:
				u=C.stream_manager.get_stream_statistics();E,F=st.columns(2)
				with E:
					st.write('**Streams by Grade Level:**')
					for(G,A4)in u[_Av].items():st.write(f"- {G}: {A4} streams")
				with F:
					st.write('**Streams by Type:**')
					for(B7,A4)in u[_Aw].items():st.write(f"- {B7}: {A4} streams")
				if u[_AR]:
					st.write('**Capacity Utilization by Stream:**');AN=[]
					for A5 in u[_AR]:AN.append({_Aq:A5[_O],_f:A5[_H],_B0:A5[_CI]})
					B8=r.DataFrame(AN);st.bar_chart(B8.set_index(_Aq)[_B0])
			except Exception as B:st.error(f"Error loading global statistics: {B}")
def export_data():
	'Export school data to various formats';D=st.session_state.school_manager;B=D.get_all_students()
	if B:
		A=pd.DataFrame(B);E,F,G=st.columns(3)
		with E:H=A.to_csv(index=_F);st.download_button(label=_C_,data=H,file_name='students_data.csv',mime=_Ar)
		with F:C=io.BytesIO();A.to_excel(C,index=_F,engine=_Bd);I=C.getvalue();st.download_button(label=_D0,data=I,file_name='students_data.xlsx',mime=_Be)
		with G:J=A.to_json(orient='records',indent=2);st.download_button(label=_D1,data=J,file_name='students_data.json',mime=_AQ)
def backup_restore():
	'Backup and restore functionality';st.subheader('üíæ Backup & Restore');F,G=st.columns(2)
	with F:
		st.write('### Backup')
		if st.button('üîÑ Create Backup'):
			C=st.session_state.school_manager;H=f"school_backup_{datetime.now().strftime('%Y_%m_%d_%H%M%S')}.db"
			try:A={_AZ:C.get_all_students(),'backup_date':datetime.now().isoformat(),'version':'1.0'};I=json.dumps(A,indent=2);st.download_button(label='üíæ Download Backup File',data=I,file_name=H.replace('.db',_CC),mime=_AQ);st.success('‚úÖ Backup created successfully!')
			except Exception as D:st.error(f"‚ùå Backup failed: {str(D)}")
	with G:
		st.write('### Restore');E=st.file_uploader('Choose backup file',type=['json','db'])
		if E:
			if st.button('üì• Restore from Backup'):
				try:
					J=E.read().decode('utf-8');A=json.loads(J)
					if _AZ in A:
						C=st.session_state.school_manager
						for B in A[_AZ]:C.add_student(B[_E],B[_C],B[_H],B['subjects'])
						st.success(_CD);st.experimental_rerun()
					else:st.error('‚ùå Invalid backup file format')
				except json.JSONDecodeError:st.error('‚ùå Invalid JSON format in backup file')
				except Exception as D:st.error(f"‚ùå Restore failed: {str(D)}")
if __name__=='__main__':main()